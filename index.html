<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BrawlCity Rank</title>
<link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Barlow:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#060608;--bg2:#0a0a0f;--surface:#0f0f18;--surface2:#141420;--border:rgba(255,255,255,0.06);--gold:#FFD000;--gold2:#FF9500;--silver:#A8B8C8;--bronze:#C87840;--accent:#00C8FF;--green:#00FF88;--red:#FF3355;--text:#D8D8E8;--text-dim:rgba(216,216,232,0.45);--text-muted:rgba(216,216,232,0.22);--pe:#FF4400;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,0.025) 1px,transparent 1px);background-size:50px 50px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 35% at 50% 0%,rgba(0,120,255,0.07) 0%,transparent 70%),radial-gradient(ellipse 40% 25% at 90% 90%,rgba(255,208,0,0.04) 0%,transparent 60%);pointer-events:none;z-index:0;}
header{position:relative;z-index:10;padding:36px 20px 18px;text-align:center;border-bottom:1px solid var(--border);}
.logo{font-family:'Teko',sans-serif;font-size:clamp(3.5rem,13vw,7rem);font-weight:700;letter-spacing:6px;line-height:0.9;background:linear-gradient(180deg,#fff 0%,var(--gold) 55%,var(--gold2) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 40px rgba(255,208,0,0.25));animation:logoIn 0.8s cubic-bezier(.16,1,.3,1) both;}
@keyframes logoIn{from{transform:translateY(-15px);opacity:0}to{transform:translateY(0);opacity:1}}
.logo-sub{font-family:'JetBrains Mono',monospace;font-size:0.6rem;letter-spacing:5px;color:var(--accent);text-transform:uppercase;opacity:0.7;margin-top:4px;}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.18);border-radius:3px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--green);letter-spacing:3px;margin-top:10px;}
.live-dot{width:5px;height:5px;background:var(--green);border-radius:50%;box-shadow:0 0 8px var(--green);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.tab-bar{position:relative;z-index:10;display:flex;max-width:780px;margin:0 auto;padding:16px 16px 0;gap:4px;}
.tab-btn{flex:1;background:var(--surface);border:1px solid var(--border);border-bottom:none;color:var(--text-dim);padding:8px 4px;font-family:'Teko',sans-serif;font-size:0.85rem;letter-spacing:0px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;border-radius:4px 4px 0 0;}
.tab-btn:hover{color:var(--text);background:var(--surface2);}
.tab-btn.active{background:var(--surface2);border-color:rgba(0,200,255,0.2);color:var(--accent);border-bottom:2px solid var(--accent);}
.tab-btn.pe-tab.active{color:var(--pe);border-bottom-color:var(--pe);border-color:rgba(255,68,0,0.2);}
.tab-btn.map-tab.active{color:var(--green);border-bottom-color:var(--green);border-color:rgba(0,255,136,0.2);}
.tab-btn.notif-tab.active{color:#f39c12;border-bottom-color:#f39c12;border-color:rgba(243,156,18,0.2);}
.notif-badge{display:inline-block;background:#e74c3c;color:#fff;border-radius:50%;width:16px;height:16px;font-size:0.6rem;text-align:center;line-height:16px;margin-left:4px;animation:pulse 1.5s infinite;}
.notif-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:10px;display:flex;align-items:flex-start;gap:12px;}
.notif-icon{font-size:1.5rem;}
.notif-text{flex:1;}
.notif-name{font-family:'Teko',sans-serif;font-size:1.1rem;color:var(--accent);letter-spacing:1px;}
.notif-desc{font-size:0.8rem;color:var(--text-muted);margin-top:2px;}
.notif-time{font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--text-dim);margin-top:4px;}
.notif-empty{text-align:center;padding:40px;color:var(--text-dim);font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:2px;}
/* ADMIN */
.admin-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.95);z-index:3000;align-items:center;justify-content:center;padding:16px;}
.admin-overlay.open{display:flex;}
.admin-box{background:#0d1117;border:1px solid #e74c3c;border-radius:12px;width:100%;max-width:420px;max-height:90vh;overflow-y:auto;padding:24px;}
.admin-title{font-family:'Teko',sans-serif;font-size:1.5rem;color:#e74c3c;letter-spacing:2px;margin-bottom:20px;text-align:center;}
.admin-input{width:100%;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:6px;font-family:monospace;font-size:0.9rem;margin-bottom:10px;box-sizing:border-box;}
.admin-btn{width:100%;padding:10px;border-radius:6px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:1px;cursor:pointer;border:none;margin-bottom:8px;}
.admin-btn-primary{background:#e74c3c;color:#fff;}
.admin-btn-secondary{background:var(--surface2);border:1px solid var(--border);color:var(--text);}
.admin-section{margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid var(--border);}
.admin-section-title{font-family:'Teko',sans-serif;font-size:1rem;color:#e74c3c;letter-spacing:1px;margin-bottom:10px;}
.admin-player-item{display:flex;align-items:center;justify-content:space-between;padding:8px;background:var(--surface2);border-radius:6px;margin-bottom:6px;}
.admin-remove-btn{background:#e74c3c22;border:1px solid #e74c3c;color:#e74c3c;padding:4px 10px;border-radius:4px;font-size:0.75rem;cursor:pointer;font-family:monospace;}
/* CELEBRA√á√ÉO MVP */
.celebracao-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:2000;align-items:center;justify-content:center;flex-direction:column;text-align:center;padding:20px;}
.celebracao-overlay.ativa{display:flex;}
.celebracao-titulo{font-family:'Teko',sans-serif;font-size:3.5rem;color:#f5a623;letter-spacing:4px;animation:pulse2 1s ease-in-out infinite;}
.celebracao-sub{font-family:'Teko',sans-serif;font-size:1.2rem;color:#fff;letter-spacing:3px;margin-bottom:20px;}
.celebracao-nome{font-family:'Teko',sans-serif;font-size:2.8rem;color:#fff;letter-spacing:2px;margin:10px 0;}
.celebracao-trofeus{font-family:'JetBrains Mono',monospace;font-size:1.1rem;color:#2ecc71;margin:10px 0;}
.celebracao-foto{width:80px;height:80px;border-radius:50%;border:3px solid #f5a623;margin:10px auto;}
.celebracao-fechar{margin-top:24px;background:none;border:1px solid #f5a623;color:#f5a623;padding:10px 30px;border-radius:8px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer;}
.fogo-celebracao{position:fixed;width:8px;height:8px;border-radius:50%;pointer-events:none;z-index:2001;}
@keyframes pulse2{0%,100%{transform:scale(1);}50%{transform:scale(1.05);}}
@keyframes fogo-anim{0%{transform:translate(0,0) scale(1);opacity:1;}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0;}}
/* MVP DA SEMANA */
.mvp-banner{background:linear-gradient(135deg,#1a1200,#2d1f00);border:2px solid #f5a623;border-radius:12px;padding:20px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden;}
.mvp-banner::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(245,166,35,0.15) 0%,transparent 70%);pointer-events:none;}
.mvp-crown{font-size:2.5rem;animation:float 2s ease-in-out infinite;}
.mvp-title{font-family:'Teko',sans-serif;font-size:0.85rem;letter-spacing:3px;color:#f5a623;margin:4px 0;}
.mvp-name{font-family:'Teko',sans-serif;font-size:2rem;color:#fff;letter-spacing:2px;margin:4px 0;}
.mvp-gain{font-family:'JetBrains Mono',monospace;font-size:1rem;color:#2ecc71;margin:4px 0;}
.mvp-emoji{font-size:2rem;}
.firework{position:absolute;width:6px;height:6px;border-radius:50%;animation:firework 1.5s ease-out infinite;}
@keyframes firework{0%{transform:translate(0,0) scale(1);opacity:1;}100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0;}}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-8px);}}
/* EDITOR PERFIL */
.perfil-edit{margin-bottom:16px;background:var(--surface2);border-radius:8px;padding:14px;}
.perfil-edit-title{font-family:'Teko',sans-serif;font-size:0.95rem;letter-spacing:1px;color:var(--text-dim);margin-bottom:10px;}
.color-picker{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
.color-opt{width:28px;height:28px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:transform 0.1s;}
.color-opt.selected,.color-opt:hover{transform:scale(1.2);border-color:#fff;}
.emoji-picker{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;}
.emoji-opt{font-size:1.4rem;cursor:pointer;padding:4px;border-radius:6px;border:2px solid transparent;transition:transform 0.1s;}
.emoji-opt.selected,.emoji-opt:hover{transform:scale(1.2);background:var(--surface);border-color:var(--accent);}
.save-perfil-btn{background:var(--accent);color:#000;border:none;padding:8px 20px;border-radius:6px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:1px;cursor:pointer;width:100%;}
/* COMPARTILHAR */
.share-btn{background:linear-gradient(135deg,#25d366,#128c7e);border:none;color:#fff;padding:10px 20px;border-radius:8px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:2px;cursor:pointer;display:flex;align-items:center;gap:8px;margin:12px auto;width:100%;justify-content:center;}
.share-btn:hover{opacity:0.9;}
#shareCanvas{display:none;}
/* MODAL */
.modal-overlay{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;align-items:center;justify-content:center;padding:16px;}
.modal-overlay.open{display:flex;}
.modal-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;width:100%;max-width:500px;max-height:85vh;overflow-y:auto;padding:20px;}
.modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.modal-title{font-family:'Teko',sans-serif;font-size:1.4rem;letter-spacing:2px;color:var(--accent);}
.modal-close{background:none;border:1px solid var(--border);color:var(--text);border-radius:6px;padding:4px 10px;cursor:pointer;font-size:1rem;}
.modal-player-info{display:flex;align-items:center;gap:12px;margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:8px;}
.modal-avatar{font-size:2rem;}
.modal-name{font-family:'Teko',sans-serif;font-size:1.3rem;color:var(--text);}
.modal-tag{font-family:'JetBrains Mono',monospace;font-size:0.7rem;color:var(--text-muted);}
.chart-container{background:var(--surface2);border-radius:8px;padding:16px;margin-bottom:16px;}
.chart-title{font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:1px;color:var(--text-dim);margin-bottom:12px;}
.chart-canvas{width:100%;height:160px;position:relative;}
.chart-empty{text-align:center;padding:30px;color:var(--text-dim);font-size:0.8rem;}
.stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.stat-box{background:var(--surface2);border-radius:8px;padding:12px;text-align:center;}
.stat-val{font-family:'Teko',sans-serif;font-size:1.4rem;color:var(--gold);}
.stat-lbl{font-size:0.65rem;color:var(--text-dim);letter-spacing:1px;text-transform:uppercase;}
.city-bar{position:relative;z-index:10;display:flex;gap:6px;padding:14px 16px 0;overflow-x:auto;scrollbar-width:none;max-width:780px;margin:0 auto;}
.city-bar::-webkit-scrollbar{display:none;}
.city-btn{flex-shrink:0;background:var(--surface);border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;border-radius:3px;font-family:'Barlow',sans-serif;font-weight:700;font-size:0.78rem;cursor:pointer;transition:all 0.2s;text-transform:uppercase;white-space:nowrap;}
.city-btn:hover,.city-btn.active{background:rgba(255,208,0,0.08);border-color:var(--gold);color:var(--gold);}
main{position:relative;z-index:10;max-width:780px;margin:0 auto;padding:16px 16px 80px;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;}
.tab-content{display:none;}.tab-content.active{display:block;}
.register-card{background:var(--surface);border:1px solid var(--border);border-top:2px solid var(--accent);border-radius:4px;padding:22px;margin-bottom:24px;}
.section-label{font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(0,200,255,0.2),transparent);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-grid .full{grid-column:1/-1;}
.input-wrap{display:flex;flex-direction:column;gap:4px;}
.input-wrap label{font-size:0.62rem;font-weight:700;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;}
.input-wrap input,.input-wrap select{background:var(--bg2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Barlow',sans-serif;font-size:0.95rem;font-weight:600;padding:10px 12px;outline:none;transition:all 0.2s;width:100%;}
.input-wrap input::placeholder{color:var(--text-muted);}
.input-wrap input:focus,.input-wrap select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,200,255,0.07);}
.input-wrap select option{background:#0a0a0f;}
.hint{font-size:0.63rem;color:var(--text-muted);font-weight:500;margin-top:2px;}
.btn-register{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:3px;color:#000;font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:3px;padding:11px 24px;cursor:pointer;transition:all 0.2s;width:100%;font-weight:600;}
.btn-register:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,208,0,0.25);}
.btn-register:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.toast{display:none;padding:10px 14px;border-radius:3px;margin-top:12px;font-size:0.85rem;font-weight:700;}
.toast.success{display:block;background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.25);color:var(--green);}
.toast.error{display:block;background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.25);color:var(--red);}
.toast.info{display:block;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.25);color:var(--accent);}
.ranking-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.ranking-title{font-family:'Teko',sans-serif;font-size:1.5rem;letter-spacing:3px;display:flex;align-items:center;gap:10px;}
.city-pill{font-family:'JetBrains Mono',monospace;font-size:0.58rem;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);color:var(--accent);padding:3px 8px;border-radius:2px;letter-spacing:1px;}
.pe-pill{font-family:'JetBrains Mono',monospace;font-size:0.58rem;background:rgba(255,68,0,0.08);border:1px solid rgba(255,68,0,0.2);color:var(--pe);padding:3px 8px;border-radius:2px;letter-spacing:1px;}
.update-info{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text-muted);letter-spacing:1px;}
.player-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:13px 16px;margin-bottom:7px;display:flex;align-items:center;gap:14px;transition:all 0.18s;animation:cardIn 0.35s ease both;position:relative;overflow:hidden;}
.player-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--border);transition:background 0.2s;}
.player-card:hover{background:var(--surface2);transform:translateX(2px);}
.player-card:hover::before{background:var(--accent);}
.player-card.top1{border-color:rgba(255,208,0,0.18);background:linear-gradient(135deg,rgba(255,208,0,0.04),var(--surface));}
.player-card.top1::before{background:var(--gold);box-shadow:0 0 12px rgba(255,208,0,0.4);}
.player-card.top2::before{background:var(--silver);}
.player-card.top3::before{background:var(--bronze);}
@keyframes cardIn{from{transform:translateX(-12px);opacity:0}to{transform:translateX(0);opacity:1}}
.rank-num{font-family:'Teko',sans-serif;font-size:1.7rem;font-weight:600;min-width:42px;text-align:center;line-height:1;}
.r1{color:var(--gold);text-shadow:0 0 16px rgba(255,208,0,0.4);}
.r2{color:var(--silver);}
.r3{color:var(--bronze);}
.rn{color:var(--text-muted);font-size:1rem;}
.player-avatar{width:42px;height:42px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.player-info{flex:1;min-width:0;}
.player-name{font-weight:800;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
.player-meta{display:flex;align-items:center;gap:8px;margin-top:3px;flex-wrap:wrap;}
.player-tag{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text-muted);}
.player-city{font-size:0.68rem;color:var(--text-dim);font-weight:700;}
.verify-link{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--accent);text-decoration:none;opacity:0.6;transition:opacity 0.2s;}
.verify-link:hover{opacity:1;}
.player-score{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;gap:4px;}
.trophy-num{font-family:'Teko',sans-serif;font-size:1.45rem;font-weight:600;color:var(--gold);letter-spacing:1px;line-height:1;}
.trophy-label{font-family:'JetBrains Mono',monospace;font-size:0.52rem;color:var(--text-muted);letter-spacing:2px;}
.horas-num{font-family:'Teko',sans-serif;font-size:1rem;font-weight:600;color:var(--accent);letter-spacing:1px;line-height:1;}
.horas-label{font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:var(--text-muted);letter-spacing:2px;}
.crown-icon{position:absolute;top:-5px;right:12px;font-size:1rem;animation:float 2.5s ease-in-out infinite;filter:drop-shadow(0 0 6px rgba(255,208,0,0.6));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
.shimmer{position:absolute;inset:0;background:linear-gradient(105deg,transparent 40%,rgba(255,208,0,0.03) 50%,transparent 60%);animation:sweep 4s infinite;}
@keyframes sweep{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
.pe-banner{background:linear-gradient(135deg,rgba(255,68,0,0.08),rgba(255,208,0,0.05));border:1px solid rgba(255,68,0,0.15);border-radius:4px;padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;gap:12px;}
.pe-flag{font-size:1.8rem;}
.pe-title{font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--pe);}
.pe-desc{font-size:0.72rem;color:var(--text-dim);font-weight:600;margin-top:1px;}
.empty-state,.loading-state{text-align:center;padding:60px 20px;color:var(--text-muted);}
.empty-icon{font-size:2rem;margin-bottom:10px;opacity:0.4;}
.empty-state p,.loading-state p{font-family:'JetBrains Mono',monospace;font-size:0.7rem;letter-spacing:2px;}
.info-bar{background:rgba(0,200,255,0.04);border:1px solid rgba(0,200,255,0.08);border-radius:3px;padding:10px 14px;margin-bottom:18px;font-size:0.73rem;color:var(--text-muted);font-weight:600;line-height:1.5;}
.info-bar span{color:var(--accent);}
footer{position:relative;z-index:10;text-align:center;padding:18px;font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text-muted);letter-spacing:2px;border-top:1px solid var(--border);max-width:780px;margin:0 auto;}
/* MAPAS */
.map-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;margin-bottom:14px;animation:cardIn 0.35s ease both;transition:all 0.2s;cursor:pointer;}
.map-card:hover{transform:translateY(-2px);border-color:rgba(0,255,136,0.2);}
.map-card-top{position:relative;height:200px;overflow:hidden;background:var(--bg2);}
.map-card-top img{width:100%;height:100%;object-fit:cover;}
.map-mode-badge{position:absolute;top:8px;left:8px;padding:4px 12px;border-radius:3px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:2px;font-weight:600;backdrop-filter:blur(8px);}
.map-timer{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.75);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:0.68rem;color:var(--gold);letter-spacing:1px;}
.map-card-body{padding:14px 16px;}
.map-name{font-family:'Teko',sans-serif;font-size:1.4rem;letter-spacing:2px;font-weight:600;margin-bottom:12px;}
.brawler-section{margin-top:8px;}
.brawler-section-title{font-family:'JetBrains Mono',monospace;font-size:0.58rem;letter-spacing:2px;margin-bottom:6px;font-weight:700;}
.brawler-section-title.best{color:var(--green);}
.brawler-section-title.worst{color:var(--red);}
.brawler-tags{display:flex;flex-wrap:wrap;gap:4px;}
.brawler-tag{font-size:0.72rem;font-weight:700;padding:2px 8px;border-radius:3px;}
.brawler-tag.best{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.2);color:var(--green);}
.brawler-tag.worst{background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.2);color:var(--red);}
.expand-hint{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--text-muted);letter-spacing:1px;margin-top:12px;text-align:center;padding:6px;border:1px dashed rgba(255,255,255,0.08);border-radius:3px;}
.next-preview{background:var(--bg2);border:1px solid rgba(0,255,136,0.15);border-radius:4px;padding:12px;margin-top:12px;}
.next-preview-title{font-family:'JetBrains Mono',monospace;font-size:0.6rem;color:var(--green);letter-spacing:2px;margin-bottom:8px;}
.next-preview-img{width:100%;height:110px;object-fit:cover;border-radius:3px;margin-bottom:8px;}
.next-preview-name{font-weight:800;font-size:1rem;}
.next-preview-mode{font-size:0.72rem;color:var(--text-dim);margin-top:2px;font-weight:600;}
@media(max-width:480px){
  .form-grid{grid-template-columns:1fr;}
  .form-grid .full{grid-column:1;}
  .tab-btn{font-size:0.8rem;padding:8px 6px;letter-spacing:0;}
}
</style>
</head>
<body>
<div id="avisoGeral" style="display:none;background:#e67e22;color:#fff;padding:10px 16px;text-align:center;font-family:'Teko',sans-serif;letter-spacing:1px;position:relative;z-index:100;">
  <div id="avisoTitulo" style="font-size:1rem;"></div>
  <div id="avisoTexto" style="font-size:0.8rem;font-family:monospace;"></div>
  <button id="btnFecharAviso" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;cursor:pointer;font-size:1rem;">‚úï</button>
</div>
<header>
  <div class="logo">BrawlCity</div>
  <div class="logo-sub">Ranking Competitivo ‚Ä¢ Pernambuco</div>
  <div class="live-badge"><span class="live-dot"></span> AO VIVO</div>
  <button id="musicBtn" onclick="toggleMusic()" style="margin-top:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:var(--text);padding:5px 14px;border-radius:3px;font-family:'Barlow',sans-serif;font-size:0.8rem;font-weight:700;cursor:pointer;letter-spacing:1px;">üîá M√öSICA</button>
</header>
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('cidade',this)">üèô Cidade</button>
  <button class="tab-btn pe-tab" onclick="switchTab('pe',this)">üèÜ PE</button>
  <button class="tab-btn map-tab" onclick="switchTab('mapas',this)">üó∫Ô∏è Mapas</button>
  <button class="tab-btn notif-tab" id="btnNotif" onclick="switchTab('notif',this)">üîî<span id="notifBadge" style="display:none" class="notif-badge">0</span></button>
  <button class="tab-btn" style="color:#a78bfa;" onclick="switchTab('semana',this)">üìÖ Semana</button>
</div>
<div class="city-bar" id="cityBar"></div>
<main>
  <div class="tab-content active" id="tab-cidade">
    <div class="info-bar">‚ö° <span>Autom√°tico:</span> Digite s√≥ sua TAG e o sistema busca seu nome e trof√©us direto do Brawl Stars!</div>
    <div class="register-card">
      <div class="section-label">Entrar no Ranking</div>
      <div class="form-grid">
        <div class="input-wrap full"><label>TAG do Brawl Stars</label><input type="text" id="inputTag" placeholder="#JQ2UUJLP" maxlength="15"><div class="hint">Encontre sua TAG no perfil do jogo</div></div>
        <div class="input-wrap full"><label>Cidade</label><select id="inputCity"></select></div>
        <div class="input-wrap full"><button class="btn-register" id="btnRegister" onclick="register()">ENTRAR NO RANKING</button></div>
      </div>
      <div class="toast" id="toast"></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">TOP <span class="city-pill" id="activeCityTag">AGRESTINA-PE</span></div>
      <div class="update-info" id="updateInfo">CONECTANDO...</div>
    </div>
    <div id="rankingList"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
    <button class="share-btn" id="btnCompartilhar">üì§ COMPARTILHAR RANKING</button>
    <canvas id="shareCanvas"></canvas>
  </div>
  <div class="tab-content" id="tab-pe">
    <div class="pe-banner">
      <div class="pe-flag">ü¶Å</div>
      <div><div class="pe-title">TOP PERNAMBUCO</div><div class="pe-desc">Os melhores jogadores de todo o estado</div></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">RANKING <span class="pe-pill">PERNAMBUCO</span></div>
      <div class="update-info" id="updateInfoPE">AO VIVO</div>
    </div>
    <div id="rankingListPE"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
  </div>
  <div class="tab-content" id="tab-mapas">
    <div class="ranking-header">
      <div class="ranking-title" style="color:var(--green);font-size:1.1rem;">üó∫Ô∏è SHOWDOWN AO VIVO</div>
      <div class="update-info" id="updateInfoMapas">CARREGANDO...</div>
    </div>
    <div id="mapGrid"><div class="loading-state"><div class="empty-icon">üó∫Ô∏è</div><p>CARREGANDO MAPAS...</p></div></div>
  </div>
</main>
  <div class="tab-content" id="tab-semana">
    <div style="padding:16px;">
      <div style="font-family:'Teko',sans-serif;font-size:1.3rem;color:#a78bfa;letter-spacing:2px;margin-bottom:4px;">üìÖ RANKING SEMANAL</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-size:0.7rem;color:var(--text-dim);font-family:'JetBrains Mono',monospace;">QUEM MAIS GANHOU TROF√âUS ESSA SEMANA</div>
        <button id="btnAtualizarSemana" style="background:var(--surface2);border:1px solid var(--border);color:var(--accent);padding:6px 12px;border-radius:6px;font-family:'Teko',sans-serif;font-size:0.85rem;cursor:pointer;">üîÑ ATUALIZAR</button>
      </div>
      <div id="mvpBanner"></div>
      <div id="rankingSemanaList"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
    </div>
  </div>

  <div class="tab-content" id="tab-notif">
    <div style="padding:16px;">
      <div style="font-family:'Teko',sans-serif;font-size:1.3rem;color:#f39c12;letter-spacing:2px;margin-bottom:16px;">üîî NOVIDADES</div>
      <div id="notifList"><div class="notif-empty">NENHUMA NOVIDADE AINDA</div></div>
    </div>
  </div>

<!-- CELEBRA√á√ÉO MVP -->
<div class="celebracao-overlay" id="celebracaoMVP">
  <div style="font-size:3rem;animation:float 1s ease-in-out infinite;">üëë</div>
  <div class="celebracao-titulo">PARAB√âNS!</div>
  <div class="celebracao-sub">üèÜ MVP DA SEMANA üèÜ</div>
  <img id="celebracaoFoto" class="celebracao-foto" src="" style="display:none">
  <div class="celebracao-nome" id="celebracaoNome"></div>
  <div class="celebracao-trofeus" id="celebracaoTrofeus"></div>
  <div style="color:#ffffff88;font-size:0.75rem;font-family:monospace;margin-top:8px;">pela conquista desta semana!</div>
  <button class="celebracao-fechar" onclick="fecharCelebracao()">‚úï FECHAR</button>
</div>

<!-- MODAL PERFIL -->
<div class="modal-overlay" id="modalPerfil" onclick="if(event.target===this)fecharModal()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitulo">PERFIL</div>
      <button class="modal-close" onclick="fecharModal()">‚úï</button>
    </div>
    <div class="modal-player-info">
      <div class="modal-avatar" id="modalAvatar">üéÆ</div>
      <div>
        <div class="modal-name" id="modalNome">-</div>
        <div class="modal-tag" id="modalTag">-</div>
        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;" id="modalCidade">-</div>
      </div>
    </div>
    <div class="stat-grid" style="margin-bottom:16px;">
      <div class="stat-box"><div class="stat-val" id="modalTrofeus">-</div><div class="stat-lbl">Trof√©us</div></div>
      <div class="stat-box"><div class="stat-val" id="modalHoras">-</div><div class="stat-lbl">Horas de jogo</div></div>
      <div class="stat-box"><div class="stat-val" id="modalPosicao">-</div><div class="stat-lbl">Posi√ß√£o PE</div></div>
      <div class="stat-box"><div class="stat-val" id="modalVariacao">-</div><div class="stat-lbl">Varia√ß√£o 24h</div></div>
    </div>
    <div class="chart-container">
      <div class="chart-title">üìà EVOLU√á√ÉO DE TROF√âUS</div>
      <div class="chart-canvas" id="chartArea"><div class="chart-empty">Coletando dados...<br>Volte amanh√£!</div></div>
    </div>
    <div class="perfil-edit" id="perfilEditor" style="display:none;">
      <div class="perfil-edit-title">üé® PERSONALIZAR PERFIL</div>
      <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">COR DO CARD</div>
      <div class="color-picker" id="colorPicker"></div>
      <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">AVATAR</div>
      <div class="emoji-picker" id="emojiPicker"></div>
      <button class="save-perfil-btn" id="btnSalvarPerfil">üíæ SALVAR</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button onclick="toggleEditPerfil()" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;font-family:'Teko',sans-serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;">‚úèÔ∏è EDITAR PERFIL</button>
      <a id="modalBrawlify" href="#" target="_blank" style="flex:1;display:block;text-align:center;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-family:'Teko',sans-serif;letter-spacing:2px;text-decoration:none;">‚Üó BRAWLIFY</a>
    </div>
  </div>
</div>

<audio id="bgMusic" src="song.mp3" loop preload="auto"></audio>


<!-- ADMIN -->
<div class="admin-overlay" id="adminOverlay">
  <div class="admin-box">
    <div class="admin-title">üîê ADMIN</div>
    <div id="adminLogin">
      <input class="admin-input" id="adminUser" type="text" placeholder="Usu√°rio">
      <input class="admin-input" id="adminPass" type="password" placeholder="Senha">
      <div id="adminErr" style="color:#e74c3c;font-size:0.75rem;margin-bottom:8px;display:none;">Usu√°rio ou senha incorretos!</div>
      <button class="admin-btn admin-btn-primary" id="btnAdminLogin">ENTRAR</button>
      <button class="admin-btn admin-btn-secondary" onclick="fecharAdmin()">CANCELAR</button>
    </div>
    <div id="adminPainel" style="display:none;">
      <div class="admin-section">
        <div class="admin-section-title">üóëÔ∏è REMOVER JOGADOR</div>
        <div id="adminPlayerList"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üèôÔ∏è ADICIONAR CIDADE</div>
        <input class="admin-input" id="adminNovaCidade" type="text" placeholder="Nome da cidade (ex: Caruaru-PE)">
        <button class="admin-btn admin-btn-primary" id="btnAdicionarCidade">ADICIONAR CIDADE</button>
        <div id="adminCidadeMsg" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üì¢ ENVIAR AVISO GERAL</div>
        <input class="admin-input" id="adminAvisoTitulo" type="text" placeholder="T√≠tulo do aviso (ex: Manuten√ß√£o)">
        <textarea class="admin-input" id="adminAvisoMsg" placeholder="Mensagem do aviso..." style="height:80px;resize:none;"></textarea>
        <button class="admin-btn admin-btn-primary" id="btnEnviarAviso">üì¢ ENVIAR AVISO</button>
        <button class="admin-btn" style="background:#e74c3c22;border:1px solid #e74c3c;color:#e74c3c;" id="btnApagarAviso">üóëÔ∏è APAGAR AVISO ATUAL</button>
        <div id="adminAvisoMsg2" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üèÜ RESETAR RANKING SEMANAL</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;font-family:monospace;">Reseta os trof√©us base de todos os jogadores para iniciar uma nova semana.</div>
        <button class="admin-btn" style="background:#e67e2222;border:1px solid #e67e22;color:#e67e22;" id="btnResetSemana">‚ö†Ô∏è RESETAR SEMANA AGORA</button>
        <div id="adminResetMsg" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üîí BLOQUEAR JOGADOR</div>
        <div id="adminBlockList"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üìä VISITAS DO SITE</div>
        <div id="adminVisitas"><div style="color:var(--text-dim);font-size:0.8rem;">Carregando...</div></div>
      </div>
      <button class="admin-btn admin-btn-secondary" onclick="fecharAdmin()">FECHAR PAINEL</button>
    </div>
  </div>
</div>

<footer id="adminTrigger" style="cursor:default;">BRAWLCITY RANK ‚Ä¢ PERNAMBUCO ‚Ä¢ VERIFIQUE EM BRAWLIFY.COM</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAi05OMG44jmNm_HUEtv9LS_wa-tBvErd8",
  authDomain: "brawlcity-rank.firebaseapp.com",
  projectId: "brawlcity-rank",
  storageBucket: "brawlcity-rank.firebasestorage.app",
  messagingSenderId: "929168855194",
  appId: "1:929168855194:web:c41092248e5863f5dc0f23"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CITIES = ['Agrestina-PE','Altinho-PE','Cupira-PE','Caruaru-PE','Petrolina-PE','Recife-PE','Garanhuns-PE','Vit√≥ria de Santo Ant√£o-PE'];
const EMOJIS = ['ü¶Å','üêØ','ü¶ä','üê∫','ü¶Ö','üêâ','ü¶à','üêª','ü¶ù','ü¶â','üî•','‚ö°','üíé'];
const COLORS = ['#FF6B00','#7B2FBE','#00BFFF','#FF3D5A','#00E676','#FFD000','#FF69B4'];

const MODOS = {
  'Solo Showdown': {nome:'Sobreviv√™ncia Solo',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'},
  'Duo Showdown': {nome:'Sobreviv√™ncia Dupla',cor:'#1ABC9C',bg:'rgba(26,188,156,0.15)'},
  'Showdown': {nome:'Sobreviv√™ncia',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'},
};

function getModo(name) {
  if (!name) return {nome:'Showdown',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'};
  const n = name.trim();
  if (MODOS[n]) return MODOS[n];
  const lower = n.toLowerCase();
  if (lower.includes('duo')) return MODOS['Duo Showdown'];
  if (lower.includes('trio')) return {nome:'Sobreviv√™ncia em Trio',cor:'#1ABC9C',bg:'rgba(26,188,156,0.15)'};
  return {nome:'Sobreviv√™ncia',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'};
}

function formatTempo(ms) {
  if (!ms || ms <= 0) return 'Encerrando...';
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  return h > 0 ? h + 'h ' + m + 'm' : m + 'm';
}

let eventTimers = [];

function renderMapas(ativos, proximos) {
  const grid = document.getElementById('mapGrid');
  eventTimers.forEach(function(t){ clearInterval(t); });
  eventTimers = [];

  if (!ativos.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üó∫Ô∏è</div><p>SEM SHOWDOWN ATIVO</p></div>';
    document.getElementById('updateInfoMapas').textContent = 'üü¢ ' + new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    return;
  }

  grid.innerHTML = '';

  for (var idx = 0; idx < ativos.length; idx++) {
    var ev = ativos[idx];
    var modeName = '';
    if (ev.gameMode && ev.gameMode.name) modeName = ev.gameMode.name;
    else if (ev.map && ev.map.gameMode && ev.map.gameMode.name) modeName = ev.map.gameMode.name;
    var modo = getModo(modeName);
    var mapName = (ev.map && ev.map.name) ? ev.map.name : 'Mapa';
    var mapImg = (ev.map && ev.map.imageUrl) ? ev.map.imageUrl : '';
    var endTime = 0;
    if (ev.endTime) {
      var rawEnd = String(ev.endTime);
      // Tenta parsear direto primeiro
      var et = new Date(rawEnd).getTime();
      // Se falhou, tenta converter formato "20260222T200000.000Z" -> "2026-02-22T20:00:00.000Z"
      if (!et || isNaN(et)) {
        var r = rawEnd.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6');
        et = new Date(r).getTime();
      }
      endTime = (!et || isNaN(et)) ? 0 : et;
    }
    var timerId = 'timer_' + idx;

    // Melhores e piores por winrate real - converte ID para nome
    var bmap = window._brawlerMap || {};
    var stats = (ev.map && ev.map.stats) ? ev.map.stats : [];
    var sorted = stats.filter(function(s){ return s.winRate > 0; }).sort(function(a,b){ return b.winRate - a.winRate; });
    var melhores = sorted.slice(0,5);
    var piores = sorted.slice(-5).reverse();

    // Converte ID para nome usando brawlerMap
    if (melhores.length && typeof melhores[0].brawler === 'number') {
      // IDs numericos - ja converte na exibicao
    }
    // Fallback: lista manual quando nao tiver stats reais
    var FALLBACK = {
      solo: {best:['Bull','Shelly','Frank','Brock','Piper'], worst:['Poco','Sprout','Gene','Sandy','Tara']},
      duo:  {best:['Poco','Gene','Max','Sandy','Rosa'],      worst:['Piper','Brock','Tick','Dynamike','Barley']},
      trio: {best:['Poco','Gene','Max','Sandy','Rosa'],      worst:['Piper','Brock','Tick','Dynamike','Barley']}
    };
    if (!melhores.length) {
      var modeKey = modeName.toUpperCase().includes('DUO') ? 'duo' : modeName.toUpperCase().includes('TRIO') ? 'trio' : 'solo';
      melhores = FALLBACK[modeKey].best.map(function(n){ return {brawler: n}; });
      piores   = FALLBACK[modeKey].worst.map(function(n){ return {brawler: n}; });
    }

    // Pr√≥ximo mapa - pega o do mesmo √≠ndice ou o primeiro dispon√≠vel
    var proximo = proximos[idx] || proximos[0] || null;
    var proximoNome = (proximo && proximo.map) ? proximo.map.name : '';
    var proximoImg = (proximo && proximo.map && proximo.map.imageUrl) ? proximo.map.imageUrl : '';
    var proximoModoNome = proximo && proximo.gameMode ? getModo(proximo.gameMode.name).nome : '';

    var melhorHTML = '';
    if (melhores.length) {
      for (var k = 0; k < melhores.length; k++) {
        var bid = melhores[k].brawler || melhores[k].id || '';
        var nome = bmap[bid] || bmap[parseInt(bid)] || (typeof bid === 'string' ? bid : '?');
        melhorHTML += '<span class="brawler-tag best">' + nome + '</span>';
      }
    } else {
      melhorHTML = '<span style="color:var(--text-muted);font-size:0.7rem;">Sem dados</span>';
    }

    var piorHTML = '';
    if (piores.length) {
      for (var k = 0; k < piores.length; k++) {
        var bid2 = piores[k].brawler || piores[k].id || '';
        var nome2 = bmap[bid2] || bmap[parseInt(bid2)] || (typeof bid2 === 'string' ? bid2 : '?');
        piorHTML += '<span class="brawler-tag worst">' + nome2 + '</span>';
      }
    } else {
      piorHTML = '<span style="color:var(--text-muted);font-size:0.7rem;">Sem dados</span>';
    }

    // Proximo mapa: da lista upcoming da Brawlify
    var outroShowdown = null;
    for (var oi = 0; oi < ativos.length; oi++) {
      if (oi !== idx) { outroShowdown = ativos[oi]; break; }
    }
    if (!outroShowdown) outroShowdown = proximos[0] || null;
    var proximoHTML = '';
    if (proximoNome) {
      proximoHTML = '<div class="next-preview">' +
        '<div class="next-preview-title">‚è≠ PR√ìXIMO MAPA DE SHOWDOWN</div>' +
        (proximoImg ? '<img class="next-preview-img" src="' + proximoImg + '" alt="' + proximoNome + '">' : '') +
        '<div class="next-preview-name">' + proximoNome + '</div>' +
        (proximoModoNome ? '<div class="next-preview-mode">' + proximoModoNome + '</div>' : '') +

        '</div>';
    } else if (outroShowdown && outroShowdown.map) {
      var onome = outroShowdown.map.name || '';
      var oimg = outroShowdown.map.imageUrl || '';
      var omodo = getModo((outroShowdown.gameMode && outroShowdown.gameMode.name) ? outroShowdown.gameMode.name : '').nome;
      proximoHTML = '<div class="next-preview">' +
        '<div class="next-preview-title">‚è≠ PR√ìXIMO MAPA DE SHOWDOWN</div>' +
        (oimg ? '<img class="next-preview-img" src="' + oimg + '" alt="' + onome + '">' : '') +
        '<div class="next-preview-name">' + onome + '</div>' +
        '<div class="next-preview-mode">' + omodo + '</div>' +
        '</div>';
    } else {
      proximoHTML = '<div class="next-preview"><div class="next-preview-title">‚è≠ PR√ìXIMO MAPA</div><div style="color:var(--text-muted);font-size:0.75rem;margin-top:6px;">A API n√£o divulga o pr√≥ximo mapa com anteced√™ncia</div></div>';
    }

    var card = document.createElement('div');
    card.className = 'map-card';
    card.style.animationDelay = (idx * 0.1) + 's';
    card.innerHTML =
      '<div class="map-card-top">' +
        (mapImg ? '<img src="' + mapImg + '" alt="' + mapName + '">' : '') +
        '<div class="map-mode-badge" style="background:' + modo.bg + ';color:' + modo.cor + ';border:1px solid ' + modo.cor + '40;">' + modo.nome + '</div>' +
        '<div class="map-timer" id="' + timerId + '">‚è± --</div>' +
      '</div>' +
      '<div class="map-card-body">' +
        '<div class="map-name">' + mapName + '</div>' +
        '<div class="brawler-section"><div class="brawler-section-title best">‚úÖ MELHORES</div><div class="brawler-tags">' + melhorHTML + '</div></div>' +
        '<div class="brawler-section" style="margin-top:8px;"><div class="brawler-section-title worst">‚ùå PIORES</div><div class="brawler-tags">' + piorHTML + '</div></div>' +
        '<div class="expand-hint">üëÜ Toque para ver pr√≥ximo mapa</div>' +
        '<div class="next-preview-wrap" style="display:none;">' + proximoHTML + '</div>' +
      '</div>';

    card.addEventListener('click', (function(c){
      return function() {
        var wrap = c.querySelector('.next-preview-wrap');
        var hint = c.querySelector('.expand-hint');
        if (wrap.style.display === 'none') { wrap.style.display = 'block'; hint.style.display = 'none'; }
        else { wrap.style.display = 'none'; hint.style.display = 'block'; }
      };
    })(card));

    grid.appendChild(card);

    (function(tid, et){
      var fn = function() {
        var el = document.getElementById(tid);
        if (el) el.textContent = '‚è± ' + formatTempo(et - Date.now());
      };
      fn();
      eventTimers.push(setInterval(fn, 30000));
    })(timerId, endTime);
  }

  document.getElementById('updateInfoMapas').textContent = 'üü¢ ' + new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}

async function carregarMapas() {
  try {
    // API oficial via Netlify - formato: {active:[{slot,map:{id,name},mode:{id,name},startTime,endTime}]}
    var resOficial = await fetch('/.netlify/functions/player?type=events');
    if (!resOficial.ok) throw new Error('Erro API oficial');
    var dataOficial = await resOficial.json();
    var todos = dataOficial.active || [];

    // Brawlify brawlers para stats
    var resBrawlers = await fetch('https://api.brawlify.com/v1/brawlers');
    var dataBrawlers = resBrawlers.ok ? await resBrawlers.json() : {list:[]};
    var brawlerMap = {};
    (dataBrawlers.list || []).forEach(function(b){ brawlerMap[b.id] = b.name; });
    window._brawlerMap = brawlerMap;

    // Brawlify events para stats dos mapas
    var resBrawlify = await fetch('https://api.brawlify.com/v1/events');
    var dataBrawlify = resBrawlify.ok ? await resBrawlify.json() : {active:[]};
    var brawlifyAtivos = dataBrawlify.active || [];

    // Filtra s√≥ SOLO SHOWDOWN - API retorna como "soloShowdown"
    var showdowns = todos.filter(function(ev) {
      var m = ev.event && ev.event.mode ? ev.event.mode : 
              (ev.mode && ev.mode.name ? ev.mode.name : 
              (ev.mode ? String(ev.mode) : ''));
      return m === 'soloShowdown' || m.toUpperCase() === 'SOLO SHOWDOWN' || m.toUpperCase() === 'SOLO_SHOWDOWN';
    });

    // Busca stats dos mapas de showdown via Brawlify
    var statsCache = {};
    for (var si = 0; si < showdowns.length; si++) {
      var evStat = showdowns[si];
      var mapIdStat = evStat.event ? evStat.event.id : (evStat.map && evStat.map.id ? evStat.map.id : 0);
      var mapNameStat = evStat.event ? evStat.event.map : (evStat.map && evStat.map.name ? evStat.map.name : '');
      if (mapIdStat) {
        try {
          var resMapStats = await fetch('https://api.brawlify.com/v1/maps/' + mapIdStat);
          if (resMapStats.ok) {
            var mapData = await resMapStats.json();
            statsCache[mapIdStat] = mapData.stats || [];
          }
        } catch(e) {}
      }
      // Fallback: busca nos ativos da Brawlify pelo nome
      if (!statsCache[mapIdStat] || !statsCache[mapIdStat].length) {
        for (var j = 0; j < brawlifyAtivos.length; j++) {
          var bev = brawlifyAtivos[j];
          var bname = bev.map && bev.map.name ? bev.map.name : '';
          if (bname.toLowerCase() === mapNameStat.toLowerCase() && bev.map && bev.map.stats) {
            statsCache[mapIdStat] = bev.map.stats;
            break;
          }
        }
      }
    }

    // Monta cards - suporta formato {event:{id,mode,map}} e {map:{id,name},mode:{name}}
    var resultado = showdowns.map(function(ev) {
      var mapId = ev.event ? ev.event.id : (ev.map && ev.map.id ? ev.map.id : 0);
      var mapName = ev.event ? ev.event.map : (ev.map && ev.map.name ? ev.map.name : '');
      var modeName = ev.event ? ev.event.mode : (ev.mode && ev.mode.name ? ev.mode.name : 'Showdown');
      var imgUrl = mapId ? 'https://cdn.brawlify.com/maps/regular/' + mapId + '.png' : '';
      var endTime = ev.endTime || '';
      var stats = statsCache[mapId] || [];
      return {
        gameMode: {name: modeName},
        map: {name: mapName, imageUrl: imgUrl, stats: stats},
        endTime: endTime
      };
    });

    // Proximo mapa: usa previsao do backend baseada no historico de rotacao
    var proximos = [];
    var nextPredicted = dataOficial.nextSoloShowdown || null;
    var rotationSize = dataOficial.rotationSize || 0;
    if (nextPredicted && nextPredicted.mapId) {
      proximos = [{
        gameMode: {name: 'SOLO SHOWDOWN'},
        map: {
          name: nextPredicted.mapName || '',
          imageUrl: 'https://cdn.brawlify.com/maps/regular/' + nextPredicted.mapId + '.png'
        }
      }];
    } else {
      // Fallback: eventos futuros da API
      proximos = todos.filter(function(ev) {
        var m = ev.mode && ev.mode.name ? ev.mode.name.toUpperCase() : '';
        var start = ev.startTime ? new Date(ev.startTime).getTime() : 0;
        return m === 'SOLO SHOWDOWN' && start > Date.now();
      }).map(function(ev) {
        var mid = ev.map && ev.map.id ? ev.map.id : 0;
        return {
          gameMode: {name: 'SOLO SHOWDOWN'},
          map: {name: ev.map ? ev.map.name : '', imageUrl: mid ? 'https://cdn.brawlify.com/maps/regular/' + mid + '.png' : ''},
          startTime: ev.startTime
        };
      });
    }

    renderMapas(resultado, proximos);
  } catch(e) {
    document.getElementById('mapGrid').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>ERRO: ' + e.message + '</p></div>';
    document.getElementById('updateInfoMapas').textContent = 'üî¥ ERRO';
    console.error('carregarMapas erro:', e);
  }
}

window.carregarMapas = carregarMapas;

// Ranking Firebase
var activeCity = 'Agrestina-PE';
var allPlayers = [];
var cityBar = document.getElementById('cityBar');
var citySelect = document.getElementById('inputCity');
CITIES.forEach(function(c) {
  var btn = document.createElement('button');
  btn.className = 'city-btn' + (c === activeCity ? ' active' : '');
  btn.textContent = c;
  btn.dataset.city = c;
  btn.onclick = function(){ setCity(c); };
  cityBar.appendChild(btn);
  var opt = document.createElement('option');
  opt.value = c; opt.textContent = c;
  citySelect.appendChild(opt);
});

function setCity(city) {
  activeCity = city;
  document.querySelectorAll('.city-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.city === city); });
  document.getElementById('activeCityTag').textContent = city.toUpperCase();
  renderRanking();
}

var q = query(collection(db, 'players'), orderBy('trophies', 'desc'));
onSnapshot(q, function(snapshot) {
  allPlayers = [];
  snapshot.forEach(function(d){ allPlayers.push(Object.assign({id: d.id}, d.data())); });
  renderRanking(); renderRankingPE(); renderRankingSemana();
  var t = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('updateInfo').textContent = 'üü¢ ' + t;
  document.getElementById('updateInfoPE').textContent = 'üü¢ ' + t;
}, function() {
  document.getElementById('updateInfo').textContent = 'üî¥ OFFLINE';
  document.getElementById('updateInfoPE').textContent = 'üî¥ OFFLINE';
});

async function buscarJogador(tag) {
  var cleanTag = tag.startsWith('#') ? tag : '#' + tag;
  var res = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent(cleanTag));
  if (!res.ok) { var err = await res.json(); throw new Error(err.error || 'Erro ao buscar jogador'); }
  return await res.json();
}

async function atualizarDados() {
  // Verifica se √© domingo e reseta semanaBase para todos
  var agora = new Date();
  var isDomingo = agora.getDay() === 0;
  var horaAtual = agora.getHours();

  for (var i = 0; i < allPlayers.length; i++) {
    var player = allPlayers[i];
    try {
      var data = await buscarJogador(player.tag);
      var updates = {};
      if (data.trophies && data.trophies !== player.trophies) updates.trophies = data.trophies;
      if (data.horas && data.horas !== player.horas) updates.horas = data.horas;
      if (data.iconId && data.iconId !== player.iconId) updates.iconId = data.iconId;
      
      // Reset semanal: todo domingo entre meia-noite e 1h da manh√£
      if (isDomingo && horaAtual === 0 && player.semanaBase) {
        updates.semanaBase = data.trophies;
        updates.semanaInicio = Date.now();
      }
      if (data.brawlerCount && player.brawlerCount && data.brawlerCount > player.brawlerCount) {
        var diff = data.brawlerCount - player.brawlerCount;
        updates.newBrawlers = diff;
        updates.brawlerCount = data.brawlerCount;
        // Salva notifica√ß√£o no Firebase
        var notif = {playerName: player.name, count: diff, timestamp: Date.now()};
        addDoc(collection(db, 'notifications'), notif).catch(function(){});
      } else if (data.brawlerCount && !player.brawlerCount) {
        updates.brawlerCount = data.brawlerCount;
      }
      if (Object.keys(updates).length > 0) await updateDoc(doc(db, 'players', player.id), updates);
      // Salva hist√≥rico de trof√©us
      if (data.trophies) {
        var histRef = collection(db, 'players', player.id, 'history');
        addDoc(histRef, {trophies: data.trophies, timestamp: Date.now()}).catch(function(){});
      }
      // Salva semanaBase apenas se o jogador ainda n√£o tem
      // Nunca sobrescreve durante a semana para manter o ganho correto
      if (!player.semanaBase) {
        updates.semanaBase = data.trophies;
        updates.semanaInicio = Date.now();
      }
    } catch(e) {}
  }
}
setTimeout(atualizarDados, 5000);

// Registrar visita
(function() {
  var ua = navigator.userAgent;
  
  // Sistema operacional e vers√£o
  var so = 'Outro';
  var androidMatch = ua.match(/Android ([\d.]+)/);
  var iosMatch = ua.match(/OS ([\d_]+) like Mac/);
  if (androidMatch) so = 'ü§ñ Android ' + androidMatch[1];
  else if (iosMatch) so = 'üçé iOS ' + iosMatch[1].replace(/_/g,'.');
  else if (/Windows NT 10/i.test(ua)) so = 'üíª Windows 10/11';
  else if (/Windows/i.test(ua)) so = 'üíª Windows';
  else if (/Mac OS X/i.test(ua) && !/iPhone|iPad/i.test(ua)) so = 'üñ•Ô∏è macOS';

  // Marca do aparelho
  var marca = '';
  if (/Samsung/i.test(ua)) marca = 'Samsung';
  else if (/Xiaomi|MI |Redmi|POCO/i.test(ua)) {
    var pocMatch = ua.match(/POCO ([A-Z0-9 ]+)/i);
    var redmiMatch = ua.match(/Redmi ([A-Z0-9 ]+)/i);
    if (pocMatch) marca = 'POCO ' + pocMatch[1].trim();
    else if (redmiMatch) marca = 'Redmi ' + redmiMatch[1].trim();
    else marca = 'Xiaomi';
  }
  else if (/Motorola|moto/i.test(ua)) marca = 'Motorola';
  else if (/LG/i.test(ua)) marca = 'LG';
  else if (/Huawei/i.test(ua)) marca = 'Huawei';
  else if (/iPhone/i.test(ua)) marca = 'iPhone';
  else if (/iPad/i.test(ua)) marca = 'iPad';

  // Navegador
  var browser = '';
  if (/SamsungBrowser/i.test(ua)) browser = 'Samsung Browser';
  else if (/OPR|Opera/i.test(ua)) browser = 'Opera';
  else if (/Edg/i.test(ua)) browser = 'Edge';
  else if (/Chrome/i.test(ua)) browser = 'Chrome';
  else if (/Firefox/i.test(ua)) browser = 'Firefox';
  else if (/Safari/i.test(ua)) browser = 'Safari';

  var dispositivo = [marca, so, browser].filter(Boolean).join(' ‚Ä¢ ');
  addDoc(collection(db, 'visitas'), {
    timestamp: Date.now(),
    dispositivo: dispositivo,
    data: new Date().toLocaleDateString('pt-BR')
  }).catch(function(){});
})();
setInterval(atualizarDados, 30 * 60 * 1000);

// Listener de notifica√ß√µes - mostra novos brawlers
var qNotif = query(collection(db, 'notifications'), orderBy('timestamp', 'desc'));
onSnapshot(qNotif, function(snap) {
  var agora = Date.now();
  var validas = [];
  snap.forEach(function(d) {
    var n = Object.assign({id: d.id}, d.data());
    // S√≥ mostra notifica√ß√µes das √∫ltimas 24h
    if (agora - n.timestamp < 24 * 60 * 60 * 1000) validas.push(n);
    // Deleta notifica√ß√µes com mais de 24h
    else deleteDoc(doc(db, 'notifications', n.id)).catch(function(){});
  });

  var badge = document.getElementById('notifBadge');
  var list = document.getElementById('notifList');
  if (!badge || !list) return;

  if (validas.length > 0) {
    badge.style.display = 'inline-block';
    badge.textContent = validas.length;
    list.innerHTML = validas.map(function(n) {
      var tempo = agora - n.timestamp;
      var tempoStr = tempo < 60000 ? 'agora mesmo' :
                     tempo < 3600000 ? Math.floor(tempo/60000) + ' min atr√°s' :
                     Math.floor(tempo/3600000) + 'h atr√°s';
      return '<div class="notif-item">' +
        '<div class="notif-icon">üÜï</div>' +
        '<div class="notif-text">' +
        '<div class="notif-name">' + n.playerName + '</div>' +
        '<div class="notif-desc">desbloqueou +' + n.count + ' novo' + (n.count > 1 ? 's' : '') + ' brawler' + (n.count > 1 ? 's' : '') + '! üéâ</div>' +
        '<div class="notif-time">' + tempoStr + '</div>' +
        '</div></div>';
    }).join('');
  } else {
    badge.style.display = 'none';
    list.innerHTML = '<div class="notif-empty">NENHUMA NOVIDADE AINDA</div>';
  }
});

window.register = async function() {
  var btn = document.getElementById('btnRegister');
  var tag = document.getElementById('inputTag').value.trim().toUpperCase();
  var city = document.getElementById('inputCity').value;
  if (!tag) return showToast('Digite sua TAG!', 'error');
  if (!tag.startsWith('#')) tag = '#' + tag;
  if (allPlayers.find(function(p){ return p.tag.toUpperCase() === tag; })) return showToast('TAG j√° cadastrada!', 'error');
  btn.disabled = true; btn.textContent = 'BUSCANDO...';
  showToast('üîç Buscando dados no Brawl Stars...', 'info');
  try {
    var data = await buscarJogador(tag);
    if (!data.trophies || !data.name) throw new Error('Jogador n√£o encontrado');
    var emoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    var color = COLORS[Math.floor(Math.random()*COLORS.length)];
    var iconId = data.iconId || null;
    await addDoc(collection(db, 'players'), {name: data.name, tag: data.tag, city: city, trophies: data.trophies, horas: data.horas || 0, emoji: emoji, color: color, joined: Date.now(), brawlerCount: data.brawlerCount || 0, newBrawlers: 0, iconId: iconId});
    document.getElementById('inputTag').value = '';
    showToast('‚úì ' + data.name + ' entrou com ' + data.trophies.toLocaleString('pt-BR') + ' trof√©us!', 'success');
    setCity(city);
  } catch(e) {
    showToast('‚ùå ' + (e.message || 'Erro ao buscar jogador'), 'error');
  }
  btn.disabled = false; btn.textContent = 'ENTRAR NO RANKING';
};

function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type;
  clearTimeout(t._t); t._t = setTimeout(function(){ t.className = 'toast'; }, 5000);
}

function buildCards(players, containerId) {
  var list = document.getElementById(containerId);
  if (!players.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üéÆ</div><p>NENHUM JOGADOR AINDA</p></div>'; return; }
  list.innerHTML = '';
  players.forEach(function(p, i) {
    var pos = i+1;
    var topClass = pos===1?'top1':pos===2?'top2':pos===3?'top3':'';
    var rankClass = pos===1?'r1':pos===2?'r2':pos===3?'r3':'rn';
    var rankLabel = pos===1?'ü•á':pos===2?'ü•à':pos===3?'ü•â':'#'+pos;
    var cleanTag = p.tag.replace('#','');
    var card = document.createElement('div');
    card.className = 'player-card ' + topClass;
    card.style.animationDelay = (i*0.04) + 's';
    card.style.cursor = 'pointer';
    card.onclick = (function(player, posicao) { return function() { abrirModal(player, posicao); }; })(p, pos);
    card.innerHTML = (pos===1?'<div class="crown-icon">üëë</div><div class="shimmer"></div>':'') +
      '<div class="rank-num ' + rankClass + '">' + rankLabel + '</div>' +
      '<div class="player-avatar" style="background:' + p.color + '15;border:1px solid ' + p.color + '28;overflow:hidden;padding:0;">' +
        (p.iconId ? '<img src="https://cdn.brawlify.com/profile-icons/regular/' + p.iconId + '.png" style="width:100%;height:100%;object-fit:cover;" onerror="this.textContent=this.dataset.fb" data-fb="' + (p.emoji||'üéÆ') + '">' : (p.emoji || 'üéÆ')) +
      '</div>' +
      '<div class="player-info"><div class="player-name">' + p.name + '</div>' +
      '<div class="player-meta"><span class="player-tag">' + p.tag + '</span>' +
      '<span class="player-city">üìç ' + p.city + '</span>' +
      '<a class="verify-link" href="https://brawlify.com/stats/profile/' + cleanTag + '" target="_blank">‚Üó BRAWLIFY</a></div></div>' +
      '<div class="player-score">' +
      '<div class="trophy-num">üèÜ ' + p.trophies.toLocaleString('pt-BR') + '</div><div class="trophy-label">TROF√âUS</div>' +
      '<div class="horas-num">‚è± ' + (p.horas||'?') + 'h</div><div class="horas-label">DE JOGO</div>' +
      '</div>';
    list.appendChild(card);
  });
}
function renderRanking() { buildCards(allPlayers.filter(function(p){ return p.city === activeCity; }).sort(function(a,b){ return b.trophies-a.trophies; }), 'rankingList'); }
function renderRankingPE() { buildCards(allPlayers.slice().sort(function(a,b){ return b.trophies-a.trophies; }), 'rankingListPE'); }

window.atualizarManual = async function() {
  var btn = document.getElementById('btnAtualizarSemana');
  if (btn) { btn.textContent = '‚è≥ ATUALIZANDO...'; btn.disabled = true; }
  await atualizarDados();
  // Espera 2s para o onSnapshot atualizar o allPlayers
  setTimeout(function() {
    renderRankingSemana();
    if (btn) { btn.textContent = 'üîÑ ATUALIZAR'; btn.disabled = false; }
  }, 2000);
};

function renderMVP(comGanho) {
  var banner = document.getElementById('mvpBanner');
  if (!banner) return;
  if (!comGanho.length || comGanho[0].ganhoSemana === 0) { banner.innerHTML = ''; return; }
  
  var mvp = comGanho[0];
  var cores = ['#f5a623','#ff6b6b','#a78bfa','#2ecc71','#00c8ff'];
  var fogos = '';
  for (var f = 0; f < 12; f++) {
    var tx = (Math.random() * 120 - 60).toFixed(0);
    var ty = (Math.random() * 80 - 80).toFixed(0);
    var cor = cores[Math.floor(Math.random() * cores.length)];
    var delay = (Math.random() * 1.5).toFixed(2);
    var size = (4 + Math.random() * 6).toFixed(0);
    fogos += '<div class="firework" style="background:'+cor+';width:'+size+'px;height:'+size+'px;left:'+(20+Math.random()*60).toFixed(0)+'%;top:'+(10+Math.random()*60).toFixed(0)+'%;--tx:'+tx+'px;--ty:'+ty+'px;animation-delay:'+delay+'s;animation-duration:'+(1+Math.random()*0.8).toFixed(2)+'s;"></div>';
  }

  banner.innerHTML = '<div class="mvp-banner">' + fogos +
    '<div class="mvp-crown">üëë</div>' +
    '<div class="mvp-title">‚≠ê MVP DA SEMANA ‚≠ê</div>' +
    '<div style="display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0;">' +
      (mvp.iconId ? '<img src="https://cdn.brawlify.com/profile-icons/regular/'+mvp.iconId+'.png" style="width:48px;height:48px;border-radius:50%;border:2px solid #f5a623;">' : '<div style="font-size:2rem;">'+mvp.emoji+'</div>') +
      '<div>' +
        '<div class="mvp-name">'+mvp.name+'</div>' +
        '<div style="font-size:0.7rem;color:#f5a62399;font-family:monospace;">üìç '+mvp.city+'</div>' +
      '</div>' +
    '</div>' +
    '<div class="mvp-gain">üèÜ +'+mvp.ganhoSemana.toLocaleString('pt-BR')+' trof√©us essa semana!</div>' +
    '</div>';
}

function renderRankingSemana() {
  var lista = document.getElementById('rankingSemanaList');
  if (!lista) return;
  
  // Calcula ganho da semana para cada jogador
  var comGanho = allPlayers.map(function(p) {
    var ganho = (p.semanaBase != null && p.trophies > p.semanaBase) ? p.trophies - p.semanaBase : 0;
    return Object.assign({}, p, {ganhoSemana: ganho});
  }).sort(function(a,b){ return b.ganhoSemana - a.ganhoSemana || b.trophies - a.trophies; });

  if (!comGanho.length) {
    lista.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);font-family:Teko,sans-serif;font-size:1.1rem;letter-spacing:1px;">NENHUM JOGADOR AINDA</div>';
    return;
  }

  var medals = ['ü•á','ü•à','ü•â'];
  renderMVP(comGanho);
  verificarMVP(comGanho);
  lista.innerHTML = comGanho.map(function(p, i) {
    var medal = i < 3 ? medals[i] : '#'+(i+1);
    var cor = i===0?'#f5a623':i===1?'#aaa':i===2?'#cd7f32':'var(--text-dim)';
    return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">' +
      '<div style="font-family:Teko,sans-serif;font-size:1.3rem;color:'+cor+';min-width:32px;">'+medal+'</div>' +
      '<div style="font-size:1.6rem;">'+p.emoji+'</div>' +
      '<div style="flex:1;">' +
        '<div style="font-family:Teko,sans-serif;font-size:1.1rem;color:var(--text);">'+p.name+'</div>' +
        '<div style="font-size:0.7rem;color:var(--text-muted);">üìç '+p.city+'</div>' +
      '</div>' +
      '<div style="text-align:right;">' +
        '<div style="font-family:Teko,sans-serif;font-size:1.2rem;color:' + (p.ganhoSemana > 0 ? '#2ecc71' : '#666') + ';">' + (p.ganhoSemana > 0 ? '+' : '') + p.ganhoSemana.toLocaleString('pt-BR') + '</div>' +
        '<div style="font-size:0.6rem;color:var(--text-dim);letter-spacing:1px;">TROF√âUS</div>' +
        '<div style="font-size:0.65rem;color:var(--text-dim);">üèÜ '+p.trophies.toLocaleString('pt-BR')+' total</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

window.compartilharRanking = function(tipo) {
  var lista = tipo === 'cidade'
    ? allPlayers.filter(function(p){ return p.city === activeCity; }).sort(function(a,b){ return b.trophies-a.trophies; })
    : allPlayers.slice().sort(function(a,b){ return b.trophies-a.trophies; });
  var top = lista.slice(0,5);
  if (!top.length) { alert('Nenhum jogador no ranking ainda!'); return; }

  var canvas = document.getElementById('shareCanvas');
  var ctx = canvas.getContext('2d');
  var W = 600, H = 120 + top.length * 80 + 60;
  canvas.width = W; canvas.height = H;

  // Fundo
  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0, 0, W, H);

  // Header
  ctx.fillStyle = '#f5a623';
  ctx.font = 'bold 36px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('BrawlCity Rank', W/2, 50);
  ctx.fillStyle = '#00c8ff';
  ctx.font = '16px Arial';
  ctx.fillText(tipo === 'cidade' ? activeCity.toUpperCase() : 'PERNAMBUCO', W/2, 75);
  ctx.fillStyle = '#ffffff33';
  ctx.fillRect(40, 90, W-80, 1);

  // Jogadores
  var medalhas = ['ü•á','ü•à','ü•â','#4','#5'];
  top.forEach(function(p, i) {
    var y = 120 + i * 80;
    // Bg card
    ctx.fillStyle = i === 0 ? '#f5a62322' : '#ffffff08';
    ctx.beginPath();
    ctx.roundRect(20, y, W-40, 68, 8);
    ctx.fill();

    // Posi√ß√£o
    ctx.fillStyle = i === 0 ? '#f5a623' : '#ffffff88';
    ctx.font = 'bold 22px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(i < 3 ? ['1¬∞','2¬∞','3¬∞'][i] : '#'+(i+1), 36, y+42);

    // Emoji
    ctx.font = '28px Arial';
    ctx.fillText(p.emoji || 'üéÆ', 80, y+44);

    // Nome
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 18px Arial';
    ctx.fillText(p.name, 120, y+32);

    // Cidade
    ctx.fillStyle = '#ffffff66';
    ctx.font = '13px Arial';
    ctx.fillText('üìç ' + p.city, 120, y+52);

    // Trof√©us
    ctx.fillStyle = '#f5a623';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'right';
    ctx.fillText('üèÜ ' + p.trophies.toLocaleString('pt-BR'), W-36, y+42);
  });

  // Footer
  ctx.fillStyle = '#ffffff33';
  ctx.fillRect(40, H-50, W-80, 1);
  ctx.fillStyle = '#ffffff44';
  ctx.font = '13px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('brawlstarscity.netlify.app', W/2, H-20);

  // Compartilha via Web Share API (abre WhatsApp, Instagram, etc)
  canvas.toBlob(function(blob) {
    var file = new File([blob], 'brawlcity-ranking.png', {type: 'image/png'});
    if (navigator.share && navigator.canShare && navigator.canShare({files: [file]})) {
      navigator.share({
        title: 'BrawlCity Rank',
        text: 'Confira o ranking de Brawl Stars de Pernambuco!',
        files: [file]
      }).catch(function(){});
    } else {
      // Fallback: baixa a imagem
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'brawlcity-ranking.png';
      a.click();
      URL.revokeObjectURL(url);
    }
  }, 'image/png');
};

// Bind bot√µes
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('btnCompartilhar');
  if (btn) btn.addEventListener('click', function() { window.compartilharRanking('cidade'); });
  var btnS = document.getElementById('btnAtualizarSemana');
  if (btnS) btnS.addEventListener('click', function() { window.atualizarManual(); });
  var btnFecharAviso = document.getElementById('btnFecharAviso');
  if (btnFecharAviso) btnFecharAviso.addEventListener('click', async function() {
    document.getElementById('avisoGeral').style.display = 'none';
    try {
      var oldAvisos = await getDocs(collection(db, 'avisos'));
      for (var d of oldAvisos.docs) await deleteDoc(doc(db, 'avisos', d.id));
    } catch(e) {}
  });

  var footer = document.getElementById('adminTrigger');
  if (footer) footer.addEventListener('dblclick', function() { window.abrirAdmin(); });

  // Enviar aviso
  document.getElementById('btnEnviarAviso').addEventListener('click', async function() {
    var titulo = document.getElementById('adminAvisoTitulo').value.trim();
    var msg = document.getElementById('adminAvisoMsg').value.trim();
    var feedEl = document.getElementById('adminAvisoMsg2');
    if (!titulo || !msg) { feedEl.style.color='#e74c3c'; feedEl.textContent='Preencha t√≠tulo e mensagem!'; return; }
    try {
      // Apaga avisos antigos
      var oldAvisos = await getDocs(collection(db, 'avisos'));
      for (var d of oldAvisos.docs) await deleteDoc(doc(db, 'avisos', d.id));
      await addDoc(collection(db, 'avisos'), {titulo: titulo, mensagem: msg, timestamp: Date.now()});
      feedEl.style.color='#2ecc71'; feedEl.textContent='‚úÖ Aviso enviado para todos!';
      document.getElementById('adminAvisoTitulo').value='';
      document.getElementById('adminAvisoMsg').value='';
    } catch(e) { feedEl.style.color='#e74c3c'; feedEl.textContent='Erro ao enviar!'; }
  });

  // Resetar semana
  document.getElementById('btnResetSemana').addEventListener('click', async function() {
    var msgEl = document.getElementById('adminResetMsg');
    if (!confirm('Resetar o ranking semanal de TODOS os jogadores?')) return;
    try {
      this.textContent = '‚è≥ RESETANDO...'; this.disabled = true;
      for (var p of allPlayers) {
        var data = await buscarJogador(p.tag);
        if (data && data.trophies) {
          await updateDoc(doc(db, 'players', p.id), {semanaBase: data.trophies, semanaInicio: Date.now()});
        }
      }
      msgEl.style.color='#2ecc71'; msgEl.textContent='‚úÖ Semana resetada para todos!';
      this.textContent='‚ö†Ô∏è RESETAR SEMANA AGORA'; this.disabled=false;
    } catch(e) { msgEl.style.color='#e74c3c'; msgEl.textContent='Erro ao resetar!'; this.disabled=false; }
  });
});

window.fecharModal = function() { document.getElementById('modalPerfil').classList.remove('open'); }

var ADMIN_USER_HASH = '417dc1719a18d5120f962f4d120c23d51da607e12f31a0874130397b85a945d9';
var ADMIN_PASS_HASH = 'b24e602adf558c20edbd2d49e5ac6fa69c02f335219240472954b91b95032444';

async function sha256(str) {
  var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
}

window.abrirAdmin = function() {
  document.getElementById('adminOverlay').classList.add('open');
  document.getElementById('adminLogin').style.display = 'block';
  document.getElementById('adminPainel').style.display = 'none';
  document.getElementById('adminErr').style.display = 'none';
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
};

window.fecharAdmin = function() {
  document.getElementById('adminOverlay').classList.remove('open');
};

document.addEventListener('DOMContentLoaded', function() {
  // Login admin
  document.getElementById('btnAdminLogin').addEventListener('click', async function() {
    var user = document.getElementById('adminUser').value;
    var pass = document.getElementById('adminPass').value;
    var hashU = await sha256(user);
    var hashP = await sha256(pass);
    if (hashU === ADMIN_USER_HASH && hashP === ADMIN_PASS_HASH) {
      document.getElementById('adminLogin').style.display = 'none';
      document.getElementById('adminPainel').style.display = 'block';
      carregarAdminPlayers();
      carregarVisitas();
    } else {
      document.getElementById('adminErr').style.display = 'block';
    }
  });

  // Adicionar cidade
  document.getElementById('btnAdicionarCidade').addEventListener('click', async function() {
    var novaCidade = document.getElementById('adminNovaCidade').value.trim();
    var msg = document.getElementById('adminCidadeMsg');
    if (!novaCidade) { msg.style.color='#e74c3c'; msg.textContent='Digite o nome da cidade!'; return; }
    try {
      await addDoc(collection(db, 'cidades'), {name: novaCidade, createdAt: Date.now()});
      msg.style.color='#2ecc71';
      msg.textContent='‚úÖ Cidade adicionada!';
      document.getElementById('adminNovaCidade').value = '';
      // Adicionar √† lista de cidades do select
      var sel = document.getElementById('citySelect');
      if (sel) {
        var opt = document.createElement('option');
        opt.value = novaCidade;
        opt.textContent = novaCidade;
        sel.appendChild(opt);
      }
    } catch(e) { msg.style.color='#e74c3c'; msg.textContent='Erro ao adicionar!'; }
  });
});

// Listener de avisos
var qAvisos = query(collection(db, 'avisos'), orderBy('timestamp', 'desc'));
onSnapshot(qAvisos, function(snap) {
  if (!snap.empty) {
    var aviso = snap.docs[0].data();
    var agora = Date.now();
    if (agora - aviso.timestamp < 24 * 60 * 60 * 1000) {
      document.getElementById('avisoTitulo').textContent = 'üì¢ ' + aviso.titulo;
      document.getElementById('avisoTexto').textContent = aviso.mensagem;
      document.getElementById('avisoGeral').style.display = 'block';
    }
  }
});

async function carregarVisitas() {
  var el = document.getElementById('adminVisitas');
  if (!el) return;
  try {
    var snap = await getDocs(collection(db, 'visitas'));
    var total = snap.size;
    var por_dispositivo = {};
    var por_dia = {};
    snap.forEach(function(d) {
      var v = d.data();
      por_dispositivo[v.dispositivo] = (por_dispositivo[v.dispositivo] || 0) + 1;
      por_dia[v.data] = (por_dia[v.data] || 0) + 1;
    });

    // √öltimos 7 dias
    var diasOrdenados = Object.keys(por_dia).sort(function(a,b){
      return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
    }).slice(-7);

    el.innerHTML = '<div style="font-family:Teko,sans-serif;font-size:1.8rem;color:#f5a623;margin-bottom:8px;">'+total+' <span style="font-size:0.9rem;color:var(--text-dim);">visitas totais</span></div>' +
      '<div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:6px;font-family:monospace;">POR DISPOSITIVO</div>' +
      Object.entries(por_dispositivo).sort(function(a,b){return b[1]-a[1];}).map(function(e){
        return '<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:4px;font-family:monospace;font-size:0.8rem;"><span>'+e[0]+'</span><span style="color:#f5a623;">'+e[1]+'</span></div>';
      }).join('') +
      '<div style="font-size:0.75rem;color:var(--text-dim);margin:8px 0 6px;font-family:monospace;">√öLTIMOS 7 DIAS</div>' +
      diasOrdenados.map(function(dia){
        return '<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:4px;font-family:monospace;font-size:0.8rem;"><span>'+dia+'</span><span style="color:#2ecc71;">'+por_dia[dia]+'</span></div>';
      }).join('');
  } catch(e) { el.innerHTML = '<div style="color:#e74c3c;font-size:0.8rem;">Erro ao carregar visitas</div>'; }
}

function carregarAdminPlayers() {
  var lista = document.getElementById('adminPlayerList');
  lista.innerHTML = '';
  var sorted = allPlayers.slice().sort(function(a,b){ return a.name.localeCompare(b.name); });
  sorted.forEach(function(p) {
    var item = document.createElement('div');
    item.className = 'admin-player-item';
    item.innerHTML = '<div><span style="font-size:1rem;">'+(p.emoji||'üéÆ')+'</span> <span style="font-family:Teko,sans-serif;font-size:0.95rem;">'+p.name+'</span><br><span style="font-size:0.65rem;color:var(--text-dim);">'+p.city+' ‚Ä¢ üèÜ'+p.trophies.toLocaleString('pt-BR')+'</span></div>' +
      '<button class="admin-remove-btn" data-id="'+p.id+'" data-name="'+p.name+'">üóëÔ∏è REMOVER</button>';
    item.querySelector('.admin-remove-btn').addEventListener('click', async function() {
      var id = this.dataset.id;
      var name = this.dataset.name;
      if (!confirm('Remover ' + name + ' do ranking?')) return;
      try {
        await deleteDoc(doc(db, 'players', id));
        item.remove();
      } catch(e) { alert('Erro ao remover!'); }
    });
    lista.appendChild(item);
  });

  // Lista de bloqueio
  var blockList = document.getElementById('adminBlockList');
  if (blockList) {
    blockList.innerHTML = '';
    sorted.forEach(function(p) {
      var item2 = document.createElement('div');
      item2.className = 'admin-player-item';
      var bloqueado = p.bloqueado || false;
      item2.innerHTML = '<div><span style="font-family:Teko,sans-serif;font-size:0.95rem;">'+(bloqueado?'üîí ':'')+ p.name+'</span><br><span style="font-size:0.65rem;color:var(--text-dim);">'+p.city+'</span></div>' +
        '<button class="admin-remove-btn" style="'+(bloqueado?'background:#2ecc7122;border-color:#2ecc71;color:#2ecc71':'')+'">'+( bloqueado?'üîì DESBLOQUEAR':'üîí BLOQUEAR')+'</button>';
      item2.querySelector('button').addEventListener('click', async function() {
        var novo = !bloqueado;
        await updateDoc(doc(db, 'players', p.id), {bloqueado: novo});
        bloqueado = novo;
        this.textContent = novo ? 'üîì DESBLOQUEAR' : 'üîí BLOQUEAR';
        this.style.background = novo ? '#2ecc7122' : '';
        this.style.borderColor = novo ? '#2ecc71' : '#e74c3c';
        this.style.color = novo ? '#2ecc71' : '#e74c3c';
      });
      blockList.appendChild(item2);
    });
  }
}

window.fecharCelebracao = function() {
  document.getElementById('celebracaoMVP').classList.remove('ativa');
  // Para os fogos
  document.querySelectorAll('.fogo-celebracao').forEach(function(f){ f.remove(); });
};

function lancarFogosCelebracao() {
  var cores = ['#f5a623','#ff6b6b','#a78bfa','#2ecc71','#00c8ff','#fff','#ff69b4'];
  var container = document.getElementById('celebracaoMVP');
  for (var f = 0; f < 30; f++) {
    (function() {
      var fogo = document.createElement('div');
      fogo.className = 'fogo-celebracao';
      var tx = (Math.random() * 300 - 150).toFixed(0);
      var ty = (Math.random() * 400 - 300).toFixed(0);
      var cor = cores[Math.floor(Math.random() * cores.length)];
      var delay = (Math.random() * 2).toFixed(2);
      var dur = (0.8 + Math.random() * 1.2).toFixed(2);
      var size = (5 + Math.random() * 8).toFixed(0);
      fogo.style.cssText = 'background:'+cor+';width:'+size+'px;height:'+size+'px;left:'+(10+Math.random()*80).toFixed(0)+'%;top:'+(10+Math.random()*80).toFixed(0)+'%;--tx:'+tx+'px;--ty:'+ty+'px;animation:fogo-anim '+dur+'s '+delay+'s ease-out infinite;';
      document.body.appendChild(fogo);
    })();
  }
}

function verificarMVP(comGanho) {
  // S√≥ celebra s√°bado ap√≥s 17h
  var agora = new Date();
  var isSabado = agora.getDay() === 6;
  var isApos17h = agora.getHours() >= 17;
  if (!isSabado || !isApos17h) return;
  if (!comGanho.length || comGanho[0].ganhoSemana === 0) return;

  // Evita mostrar mais de uma vez por sess√£o
  if (sessionStorage.getItem('mvpCelebrado')) return;
  sessionStorage.setItem('mvpCelebrado', '1');

  var mvp = comGanho[0];
  document.getElementById('celebracaoNome').textContent = mvp.name;
  document.getElementById('celebracaoTrofeus').textContent = 'üèÜ +' + mvp.ganhoSemana.toLocaleString('pt-BR') + ' trof√©us essa semana!';
  
  var foto = document.getElementById('celebracaoFoto');
  if (mvp.iconId) {
    foto.src = 'https://cdn.brawlify.com/profile-icons/regular/' + mvp.iconId + '.png';
    foto.style.display = 'block';
  } else {
    foto.style.display = 'none';
  }

  document.getElementById('celebracaoMVP').classList.add('ativa');
  lancarFogosCelebracao();
}

var CORES_DISPONIVEIS = ["#e74c3c", "#e67e22", "#f1c40f", "#2ecc71", "#1abc9c", "#3498db", "#9b59b6", "#e91e63", "#00bcd4", "#ff5722", "#ffffff", "#00c8ff"];
var EMOJIS_DISPONIVEIS = ["üî•", "‚ö°", "üíÄ", "ü¶à", "üëæ", "üê∫", "ü§ñ", "üëë", "üíé", "üéØ", "ü¶Å", "üêâ", "üåô", "‚≠ê", "üéÆ", "üèÜ", "üí•", "üåä", "ü¶ä", "üêª", "üé≠", "ü¶ã"];
var _playerEditando = null;
var _corSelecionada = null;
var _emojiSelecionado = null;

window.toggleEditPerfil = function() {
  var editor = document.getElementById('perfilEditor');
  if (!editor) return;
  if (editor.style.display === 'none') {
    editor.style.display = 'block';
    // Monta paleta de cores
    var cp = document.getElementById('colorPicker');
    cp.innerHTML = CORES_DISPONIVEIS.map(function(c) {
      var sel = _playerEditando && c === _playerEditando.color ? ' selected' : '';
      return '<div class="color-opt'+sel+'" style="background:'+c+'" data-color="'+c+'" onclick="selecionarCor(this)"></div>';
    }).join('');
    // Monta paleta de emojis
    var ep = document.getElementById('emojiPicker');
    ep.innerHTML = EMOJIS_DISPONIVEIS.map(function(e) {
      var sel = _playerEditando && e === _playerEditando.emoji ? ' selected' : '';
      return '<span class="emoji-opt'+sel+'" data-emoji="'+e+'" onclick="selecionarEmoji(this)">'+e+'</span>';
    }).join('');
    _corSelecionada = _playerEditando ? _playerEditando.color : null;
    _emojiSelecionado = _playerEditando ? _playerEditando.emoji : null;
  } else {
    editor.style.display = 'none';
  }
};

window.selecionarCor = function(el) {
  document.querySelectorAll('.color-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  _corSelecionada = el.dataset.color;
};

window.selecionarEmoji = function(el) {
  document.querySelectorAll('.emoji-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  _emojiSelecionado = el.dataset.emoji;
};

async function abrirModal(p, pos) {
  // Preenche dados b√°sicos
  var avatarEl = document.getElementById('modalAvatar');
  if (p.iconId) {
    var fbEmoji = p.emoji || 'üéÆ';
    avatarEl.innerHTML = '<img src="https://cdn.brawlify.com/profile-icons/regular/' + p.iconId + '.png" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" data-fb="' + fbEmoji + '" onerror="this.parentNode.textContent=this.dataset.fb">';
  } else {
    avatarEl.textContent = p.emoji || 'üéÆ';
  }
  document.getElementById('modalNome').textContent = p.name;
  document.getElementById('modalTag').textContent = p.tag;
  document.getElementById('modalCidade').textContent = 'üìç ' + p.city;
  document.getElementById('modalTrofeus').textContent = p.trophies.toLocaleString('pt-BR');
  document.getElementById('modalHoras').textContent = (p.horas || '?') + 'h';
  document.getElementById('modalPosicao').textContent = '#' + pos;
  document.getElementById('modalBrawlify').href = 'https://brawlify.com/stats/profile/' + p.tag.replace('#','');
  document.getElementById('modalPerfil').classList.add('open');
  document.getElementById('perfilEditor').style.display = 'none';
  _playerEditando = p;
  _corSelecionada = p.color;
  _emojiSelecionado = p.emoji;

  // Bot√£o salvar perfil
  var btnSalvar = document.getElementById('btnSalvarPerfil');
  if (btnSalvar) {
    btnSalvar.onclick = async function() {
      if (!_playerEditando || !_playerEditando.id) return;
      var updates = {};
      if (_corSelecionada) updates.color = _corSelecionada;
      if (_emojiSelecionado) updates.emoji = _emojiSelecionado;
      if (Object.keys(updates).length === 0) return;
      try {
        btnSalvar.textContent = 'SALVANDO...';
        await updateDoc(doc(db, 'players', _playerEditando.id), updates);
        btnSalvar.textContent = '‚úÖ SALVO!';
        document.getElementById('modalAvatar').textContent = _emojiSelecionado || _playerEditando.emoji;
        setTimeout(function(){ btnSalvar.textContent = 'üíæ SALVAR'; }, 2000);
      } catch(e) {
        btnSalvar.textContent = '‚ùå ERRO';
        setTimeout(function(){ btnSalvar.textContent = 'üíæ SALVAR'; }, 2000);
      }
    };
  }

  // Busca hist√≥rico de trof√©us do Firebase
  var chartArea = document.getElementById('chartArea');
  chartArea.innerHTML = '<div class="chart-empty">Carregando hist√≥rico...</div>';

  try {
    var { collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var hRef = collection(db, 'players', p.id, 'history');
    var hQuery = query(hRef, orderBy('timestamp', 'desc'), limit(14));
    var snap = await getDocs(hQuery);
    var pontos = [];
    snap.forEach(function(d) { pontos.push(d.data()); });
    pontos.reverse();

    if (pontos.length < 2) {
      chartArea.innerHTML = '<div class="chart-empty">Coletando dados...<br>Volte amanh√£ para ver o gr√°fico!</div>';
      document.getElementById('modalVariacao').textContent = '-';
      return;
    }

    // Varia√ß√£o 24h
    var ultimo = pontos[pontos.length-1].trophies;
    var penultimo = pontos[pontos.length-2].trophies;
    var variacao = ultimo - penultimo;
    var varEl = document.getElementById('modalVariacao');
    varEl.textContent = (variacao >= 0 ? '+' : '') + variacao.toLocaleString('pt-BR');
    varEl.style.color = variacao >= 0 ? '#2ecc71' : '#e74c3c';

    // Desenha gr√°fico SVG
    var min = Math.min.apply(null, pontos.map(function(p){return p.trophies;}));
    var max = Math.max.apply(null, pontos.map(function(p){return p.trophies;}));
    var range = max - min || 1;
    var w = 100, h = 100;
    var pts = pontos.map(function(p, i) {
      var x = (i / (pontos.length-1)) * w;
      var y = h - ((p.trophies - min) / range) * (h * 0.8) - h*0.1;
      return x + ',' + y;
    });
    var polyline = pts.join(' ');
    var lastPt = pts[pts.length-1].split(',');

    chartArea.innerHTML = '<svg viewBox="0 0 100 100" style="width:100%;height:150px;" preserveAspectRatio="none">' +
      '<defs><linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00c8ff" stop-opacity="0.3"/><stop offset="100%" stop-color="#00c8ff" stop-opacity="0"/></linearGradient></defs>' +
      '<polygon points="0,100 ' + polyline + ' 100,100" fill="url(#g1)"/>' +
      '<polyline points="' + polyline + '" fill="none" stroke="#00c8ff" stroke-width="2"/>' +
      '<circle cx="' + lastPt[0] + '" cy="' + lastPt[1] + '" r="3" fill="#00c8ff"/>' +
      '</svg>' +
      '<div style="display:flex;justify-content:space-between;font-family:JetBrains Mono,monospace;font-size:0.6rem;color:var(--text-dim);margin-top:4px;">' +
      '<span>' + pontos[0].trophies.toLocaleString('pt-BR') + '</span>' +
      '<span style="color:#00c8ff">' + pontos[pontos.length-1].trophies.toLocaleString('pt-BR') + '</span>' +
      '</div>';

  } catch(e) {
    chartArea.innerHTML = '<div class="chart-empty">Erro ao carregar hist√≥rico</div>';
  }
}
</script>


<script>

window.togglePlayerRadio = function() {
  var modal = document.getElementById('radioModal');
  var frame = document.getElementById('radioFrame');
  if (modal.style.display === 'none') {
    modal.style.display = 'block';
    // Radio Garden embed - esta√ß√£o de cl√°ssicos 80/90
    frame.src = 'https://radio.garden/embed/radio-classicos-rock/YpZUAKJP';
    document.getElementById('musicBtn').style.color = '#f5a623';
  } else {
    fecharRadio();
  }
};

window.fecharRadio = function() {
  var modal = document.getElementById('radioModal');
  var frame = document.getElementById('radioFrame');
  modal.style.display = 'none';
  frame.src = '';
  document.getElementById('musicBtn').style.color = '';
};

function toggleMusic() {
  var music = document.getElementById('bgMusic');
  var btn = document.getElementById('musicBtn');
  if (music.paused) { music.volume = 0.4; music.play(); btn.textContent = 'üîä M√öSICA'; }
  else { music.pause(); btn.textContent = 'üîá M√öSICA'; }
}
function switchTab(tab, el) {
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  document.getElementById('tab-'+tab).classList.add('active');
  el.classList.add('active');
  document.getElementById('cityBar').style.display = tab==='cidade' ? 'flex' : 'none';
  if (tab === 'mapas' && !window._mapaCarregado) {
    window._mapaCarregado = true;
    setTimeout(function(){
      if (typeof window.carregarMapas === 'function') {
        window.carregarMapas();
        setInterval(window.carregarMapas, 5 * 60 * 1000);
      }
    }, 200);
  }
}
</script>
</body>
</html>
