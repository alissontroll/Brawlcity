<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BrawlCity Rank</title>
<link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Barlow:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#060608;--bg2:#0a0a0f;--surface:#0f0f18;--surface2:#141420;
  --border:rgba(255,255,255,0.06);--gold:#FFD000;--gold2:#FF9500;
  --silver:#A8B8C8;--bronze:#C87840;--accent:#00C8FF;
  --green:#00FF88;--red:#FF3355;--text:#D8D8E8;
  --text-dim:rgba(216,216,232,0.45);--text-muted:rgba(216,216,232,0.22);
  --pe:#FF4400;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,200,255,0.025) 1px,transparent 1px),linear-gradient(90deg,rgba(0,200,255,0.025) 1px,transparent 1px);background-size:50px 50px;pointer-events:none;z-index:0;}
body::after{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 70% 35% at 50% 0%,rgba(0,120,255,0.07) 0%,transparent 70%),radial-gradient(ellipse 40% 25% at 90% 90%,rgba(255,208,0,0.04) 0%,transparent 60%);pointer-events:none;z-index:0;}
header{position:relative;z-index:10;padding:36px 20px 18px;text-align:center;border-bottom:1px solid var(--border);}
.logo{font-family:'Teko',sans-serif;font-size:clamp(3.5rem,13vw,7rem);font-weight:700;letter-spacing:6px;line-height:0.9;background:linear-gradient(180deg,#fff 0%,var(--gold) 55%,var(--gold2) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 40px rgba(255,208,0,0.25));animation:logoIn 0.8s cubic-bezier(.16,1,.3,1) both;}
@keyframes logoIn{from{transform:translateY(-15px);opacity:0}to{transform:translateY(0);opacity:1}}
.logo-sub{font-family:'JetBrains Mono',monospace;font-size:0.6rem;letter-spacing:5px;color:var(--accent);text-transform:uppercase;opacity:0.7;margin-top:4px;}
.live-badge{display:inline-flex;align-items:center;gap:6px;background:rgba(0,255,136,0.07);border:1px solid rgba(0,255,136,0.18);border-radius:3px;padding:3px 10px;font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--green);letter-spacing:3px;margin-top:10px;}
.live-dot{width:5px;height:5px;background:var(--green);border-radius:50%;box-shadow:0 0 8px var(--green);animation:blink 1.2s infinite;}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
.tab-bar{position:relative;z-index:10;display:flex;max-width:780px;margin:0 auto;padding:16px 16px 0;gap:4px;}
.tab-btn{flex:1;background:var(--surface);border:1px solid var(--border);border-bottom:none;color:var(--text-dim);padding:10px 8px;font-family:'Teko',sans-serif;font-size:1rem;letter-spacing:1px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;border-radius:4px 4px 0 0;}
.tab-btn:hover{color:var(--text);background:var(--surface2);}
.tab-btn.active{background:var(--surface2);border-color:rgba(0,200,255,0.2);color:var(--accent);border-bottom:2px solid var(--accent);}
.tab-btn.pe-tab.active{color:var(--pe);border-bottom-color:var(--pe);border-color:rgba(255,68,0,0.2);}
.tab-btn.map-tab.active{color:var(--green);border-bottom-color:var(--green);border-color:rgba(0,255,136,0.2);}
.city-bar{position:relative;z-index:10;display:flex;gap:6px;padding:14px 16px 0;overflow-x:auto;scrollbar-width:none;max-width:780px;margin:0 auto;}
.city-bar::-webkit-scrollbar{display:none;}
.city-btn{flex-shrink:0;background:var(--surface);border:1px solid var(--border);color:var(--text-dim);padding:6px 14px;border-radius:3px;font-family:'Barlow',sans-serif;font-weight:700;font-size:0.78rem;cursor:pointer;transition:all 0.2s;text-transform:uppercase;white-space:nowrap;}
.city-btn:hover,.city-btn.active{background:rgba(255,208,0,0.08);border-color:var(--gold);color:var(--gold);}
main{position:relative;z-index:10;max-width:780px;margin:0 auto;padding:16px 16px 80px;background:var(--surface2);border:1px solid var(--border);border-top:none;border-radius:0 0 4px 4px;}
.tab-content{display:none;}
.tab-content.active{display:block;}
.register-card{background:var(--surface);border:1px solid var(--border);border-top:2px solid var(--accent);border-radius:4px;padding:22px;margin-bottom:24px;}
.section-label{font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:16px;display:flex;align-items:center;gap:10px;}
.section-label::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(0,200,255,0.2),transparent);}
.section-label.green{color:var(--green);}
.section-label.green::after{background:linear-gradient(90deg,rgba(0,255,136,0.2),transparent);}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-grid .full{grid-column:1/-1;}
.input-wrap{display:flex;flex-direction:column;gap:4px;}
.input-wrap label{font-size:0.62rem;font-weight:700;letter-spacing:2px;color:var(--text-muted);text-transform:uppercase;}
.input-wrap input,.input-wrap select{background:var(--bg2);border:1px solid var(--border);border-radius:3px;color:var(--text);font-family:'Barlow',sans-serif;font-size:0.95rem;font-weight:600;padding:10px 12px;outline:none;transition:all 0.2s;width:100%;}
.input-wrap input::placeholder{color:var(--text-muted);}
.input-wrap input:focus,.input-wrap select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,200,255,0.07);}
.input-wrap select option{background:#0a0a0f;}
.hint{font-size:0.63rem;color:var(--text-muted);font-weight:500;margin-top:2px;}
.btn-register{background:linear-gradient(135deg,var(--gold),var(--gold2));border:none;border-radius:3px;color:#000;font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:3px;padding:11px 24px;cursor:pointer;transition:all 0.2s;width:100%;font-weight:600;}
.btn-register:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(255,208,0,0.25);}
.btn-register:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.toast{display:none;padding:10px 14px;border-radius:3px;margin-top:12px;font-size:0.85rem;font-weight:700;animation:toastIn 0.3s ease;}
.toast.success{display:block;background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.25);color:var(--green);}
.toast.error{display:block;background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.25);color:var(--red);}
.toast.info{display:block;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.25);color:var(--accent);}
@keyframes toastIn{from{transform:translateY(-6px);opacity:0}to{transform:translateY(0);opacity:1}}
.ranking-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.ranking-title{font-family:'Teko',sans-serif;font-size:1.5rem;letter-spacing:3px;display:flex;align-items:center;gap:10px;}
.city-pill{font-family:'JetBrains Mono',monospace;font-size:0.58rem;background:rgba(0,200,255,0.08);border:1px solid rgba(0,200,255,0.2);color:var(--accent);padding:3px 8px;border-radius:2px;letter-spacing:1px;}
.pe-pill{font-family:'JetBrains Mono',monospace;font-size:0.58rem;background:rgba(255,68,0,0.08);border:1px solid rgba(255,68,0,0.2);color:var(--pe);padding:3px 8px;border-radius:2px;letter-spacing:1px;}
.update-info{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text-muted);letter-spacing:1px;}
.player-card{background:var(--surface);border:1px solid var(--border);border-radius:4px;padding:13px 16px;margin-bottom:7px;display:flex;align-items:center;gap:14px;transition:all 0.18s;animation:cardIn 0.35s ease both;position:relative;overflow:hidden;}
.player-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--border);transition:background 0.2s;}
.player-card:hover{background:var(--surface2);transform:translateX(2px);}
.player-card:hover::before{background:var(--accent);}
.player-card.top1{border-color:rgba(255,208,0,0.18);background:linear-gradient(135deg,rgba(255,208,0,0.04),var(--surface));}
.player-card.top1::before{background:var(--gold);box-shadow:0 0 12px rgba(255,208,0,0.4);}
.player-card.top2{border-color:rgba(168,184,200,0.18);}
.player-card.top2::before{background:var(--silver);}
.player-card.top3{border-color:rgba(200,120,64,0.18);}
.player-card.top3::before{background:var(--bronze);}
@keyframes cardIn{from{transform:translateX(-12px);opacity:0}to{transform:translateX(0);opacity:1}}
.rank-num{font-family:'Teko',sans-serif;font-size:1.7rem;font-weight:600;min-width:42px;text-align:center;line-height:1;}
.r1{color:var(--gold);text-shadow:0 0 16px rgba(255,208,0,0.4);}
.r2{color:var(--silver);}
.r3{color:var(--bronze);}
.rn{color:var(--text-muted);font-size:1rem;}
.player-avatar{width:42px;height:42px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;}
.player-info{flex:1;min-width:0;}
.player-name{font-weight:800;font-size:1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.2;}
.player-meta{display:flex;align-items:center;gap:8px;margin-top:3px;flex-wrap:wrap;}
.player-tag{font-family:'JetBrains Mono',monospace;font-size:0.62rem;color:var(--text-muted);}
.player-city{font-size:0.68rem;color:var(--text-dim);font-weight:700;}
.verify-link{font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--accent);text-decoration:none;opacity:0.6;transition:opacity 0.2s;}
.verify-link:hover{opacity:1;}
.player-score{display:flex;flex-direction:column;align-items:flex-end;flex-shrink:0;gap:4px;}
.trophy-num{font-family:'Teko',sans-serif;font-size:1.45rem;font-weight:600;color:var(--gold);letter-spacing:1px;line-height:1;}
.trophy-label{font-family:'JetBrains Mono',monospace;font-size:0.52rem;color:var(--text-muted);letter-spacing:2px;}
.horas-num{font-family:'Teko',sans-serif;font-size:1rem;font-weight:600;color:var(--accent);letter-spacing:1px;line-height:1;}
.horas-label{font-family:'JetBrains Mono',monospace;font-size:0.48rem;color:var(--text-muted);letter-spacing:2px;}
.crown-icon{position:absolute;top:-5px;right:12px;font-size:1rem;animation:float 2.5s ease-in-out infinite;filter:drop-shadow(0 0 6px rgba(255,208,0,0.6));}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
.shimmer{position:absolute;inset:0;background:linear-gradient(105deg,transparent 40%,rgba(255,208,0,0.03) 50%,transparent 60%);animation:sweep 4s infinite;}
@keyframes sweep{0%{transform:translateX(-100%)}100%{transform:translateX(200%)}}
.pe-banner{background:linear-gradient(135deg,rgba(255,68,0,0.08),rgba(255,208,0,0.05));border:1px solid rgba(255,68,0,0.15);border-radius:4px;padding:14px 18px;margin-bottom:18px;display:flex;align-items:center;gap:12px;}
.pe-flag{font-size:1.8rem;}
.pe-title{font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:2px;color:var(--pe);}
.pe-desc{font-size:0.72rem;color:var(--text-dim);font-weight:600;margin-top:1px;}
.empty-state,.loading-state{text-align:center;padding:60px 20px;color:var(--text-muted);}
.empty-icon{font-size:2rem;margin-bottom:10px;opacity:0.4;}
.empty-state p,.loading-state p{font-family:'JetBrains Mono',monospace;font-size:0.7rem;letter-spacing:2px;}
.info-bar{background:rgba(0,200,255,0.04);border:1px solid rgba(0,200,255,0.08);border-radius:3px;padding:10px 14px;margin-bottom:18px;font-size:0.73rem;color:var(--text-muted);font-weight:600;line-height:1.5;}
.info-bar span{color:var(--accent);}
footer{position:relative;z-index:10;text-align:center;padding:18px;font-family:'JetBrains Mono',monospace;font-size:0.58rem;color:var(--text-muted);letter-spacing:2px;border-top:1px solid var(--border);max-width:780px;margin:0 auto;}

/* MAPAS */
.map-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:14px;margin-top:4px;}
.map-card{background:var(--surface);border:1px solid var(--border);border-radius:6px;overflow:hidden;animation:cardIn 0.35s ease both;transition:all 0.2s;}
.map-card:hover{transform:translateY(-2px);border-color:rgba(0,255,136,0.2);}
.map-card-top{position:relative;height:160px;overflow:hidden;background:var(--bg2);}
.map-card-top img{width:100%;height:100%;object-fit:cover;opacity:0.9;}
.map-mode-badge{position:absolute;top:8px;left:8px;padding:3px 10px;border-radius:3px;font-family:'Teko',sans-serif;font-size:0.85rem;letter-spacing:2px;font-weight:600;backdrop-filter:blur(8px);}
.map-timer{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.1);border-radius:3px;padding:3px 8px;font-family:'JetBrains Mono',monospace;font-size:0.65rem;color:var(--gold);letter-spacing:1px;}
.map-card-body{padding:12px 14px;}
.map-name{font-family:'Teko',sans-serif;font-size:1.2rem;letter-spacing:2px;font-weight:600;line-height:1.2;margin-bottom:10px;}
.brawler-section{margin-top:8px;}
.brawler-section-title{font-family:'JetBrains Mono',monospace;font-size:0.58rem;letter-spacing:2px;margin-bottom:6px;font-weight:700;}
.brawler-section-title.best{color:var(--green);}
.brawler-section-title.worst{color:var(--red);}
.brawler-tags{display:flex;flex-wrap:wrap;gap:4px;}
.brawler-tag{font-size:0.72rem;font-weight:700;padding:2px 8px;border-radius:3px;}
.brawler-tag.best{background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.2);color:var(--green);}
.brawler-tag.worst{background:rgba(255,51,85,0.08);border:1px solid rgba(255,51,85,0.2);color:var(--red);}
.next-section{margin-top:28px;}
.next-section-title{font-family:'Teko',sans-serif;font-size:1.1rem;letter-spacing:3px;color:var(--text-dim);margin-bottom:12px;display:flex;align-items:center;gap:8px;}
.next-section-title::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,rgba(255,255,255,0.06),transparent);}

@media(max-width:480px){
  .form-grid{grid-template-columns:1fr;}
  .form-grid .full{grid-column:1;}
  .tab-btn{font-size:0.8rem;padding:8px 6px;letter-spacing:0px;}
  .map-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<header>
  <div class="logo">BrawlCity</div>
  <div class="logo-sub">Ranking Competitivo ‚Ä¢ Pernambuco</div>
  <div class="live-badge"><span class="live-dot"></span> AO VIVO</div>
  <button id="musicBtn" onclick="toggleMusic()" style="margin-top:12px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:var(--text);padding:5px 14px;border-radius:3px;font-family:'Barlow',sans-serif;font-size:0.8rem;font-weight:700;cursor:pointer;letter-spacing:1px;">üîá M√öSICA</button>
</header>
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('cidade',this)">üèô Cidade</button>
  <button class="tab-btn pe-tab" onclick="switchTab('pe',this)">üèÜ Pernambuco</button>
  <button class="tab-btn map-tab" onclick="switchTab('mapas',this)">üó∫Ô∏è Mapas</button>
</div>
<div class="city-bar" id="cityBar"></div>
<main>
  <div class="tab-content active" id="tab-cidade">
    <div class="info-bar">‚ö° <span>Autom√°tico:</span> Digite s√≥ sua TAG e o sistema busca seu nome e trof√©us direto do Brawl Stars! Verific√°vel em brawlify.com üåê</div>
    <div class="register-card">
      <div class="section-label">Entrar no Ranking</div>
      <div class="form-grid">
        <div class="input-wrap full"><label>TAG do Brawl Stars</label><input type="text" id="inputTag" placeholder="#JQ2UUJLP" maxlength="15"><div class="hint">Encontre sua TAG no perfil do jogo. Verific√°vel em <a href="https://brawlify.com" target="_blank" style="color:var(--accent)">brawlify.com</a></div></div>
        <div class="input-wrap full"><label>Cidade</label><select id="inputCity"></select></div>
        <div class="input-wrap full"><button class="btn-register" id="btnRegister" onclick="register()">ENTRAR NO RANKING</button></div>
      </div>
      <div class="toast" id="toast"></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">TOP <span class="city-pill" id="activeCityTag">AGRESTINA-PE</span></div>
      <div class="update-info" id="updateInfo">CONECTANDO...</div>
    </div>
    <div id="rankingList"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
  </div>

  <div class="tab-content" id="tab-pe">
    <div class="pe-banner">
      <div class="pe-flag">ü¶Å</div>
      <div><div class="pe-title">TOP PERNAMBUCO</div><div class="pe-desc">Os melhores jogadores de todo o estado ‚Äî todas as cidades</div></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">RANKING <span class="pe-pill">PERNAMBUCO</span></div>
      <div class="update-info" id="updateInfoPE">AO VIVO</div>
    </div>
    <div id="rankingListPE"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
  </div>

  <div class="tab-content" id="tab-mapas">
    <div class="ranking-header">
      <div class="ranking-title" style="color:var(--green)">üó∫Ô∏è <span style="font-size:1rem;font-family:'JetBrains Mono',monospace;font-size:0.7rem;background:rgba(0,255,136,0.08);border:1px solid rgba(0,255,136,0.2);color:var(--green);padding:3px 8px;border-radius:2px;">EVENTOS ATIVOS</span></div>
      <div class="update-info" id="updateInfoMapas">CARREGANDO...</div>
    </div>
    <div id="mapGrid" class="map-grid"><div class="loading-state" style="grid-column:1/-1"><div class="empty-icon">üó∫Ô∏è</div><p>CARREGANDO MAPAS...</p></div></div>
    <div class="next-section">
      <div class="next-section-title">‚è≠ PR√ìXIMOS MAPAS</div>
      <div id="nextMaps"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
    </div>
  </div>
</main>
<footer>BRAWLCITY RANK ‚Ä¢ PERNAMBUCO ‚Ä¢ VERIFIQUE EM BRAWLIFY.COM</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAi05OMG44jmNm_HUEtv9LS_wa-tBvErd8",
  authDomain: "brawlcity-rank.firebaseapp.com",
  projectId: "brawlcity-rank",
  storageBucket: "brawlcity-rank.firebasestorage.app",
  messagingSenderId: "929168855194",
  appId: "1:929168855194:web:c41092248e5863f5dc0f23"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CITIES = ['Agrestina-PE','Altinho-PE','Cupira-PE','Caruaru-PE','Petrolina-PE','Recife-PE','Garanhuns-PE','Vit√≥ria de Santo Ant√£o-PE'];
const EMOJIS = ['ü¶Å','üêØ','ü¶ä','üê∫','ü¶Ö','üêâ','ü¶à','üêª','ü¶ù','ü¶â','üî•','‚ö°','üíé'];
const COLORS = ['#FF6B00','#7B2FBE','#00BFFF','#FF3D5A','#00E676','#FFD000','#FF69B4'];

// Tradu√ß√µes dos modos de jogo
const MODOS = {
  'gemgrab': { nome: 'Pique-Gema', cor: '#9B59B6', bg: 'rgba(155,89,182,0.15)' },
  'brawlball': { nome: 'Futebol Brawl', cor: '#27AE60', bg: 'rgba(39,174,96,0.15)' },
  'heist': { nome: 'Assalto ao Cofre', cor: '#E74C3C', bg: 'rgba(231,76,60,0.15)' },
  'bounty': { nome: 'Ca√ßa-Estrelas', cor: '#F39C12', bg: 'rgba(243,156,18,0.15)' },
  'hotzone': { nome: 'Zona Quente', cor: '#E67E22', bg: 'rgba(230,126,34,0.15)' },
  'knockout': { nome: 'Nocaute', cor: '#E74C3C', bg: 'rgba(231,76,60,0.15)' },
  'showdown': { nome: 'Sobreviv√™ncia', cor: '#2ECC71', bg: 'rgba(46,204,113,0.15)' },
  'soloshowdown': { nome: 'Sobreviv√™ncia Solo', cor: '#2ECC71', bg: 'rgba(46,204,113,0.15)' },
  'duoshowdown': { nome: 'Sobreviv√™ncia Dupla', cor: '#1ABC9C', bg: 'rgba(26,188,156,0.15)' },
  'duels': { nome: 'Duelos', cor: '#E74C3C', bg: 'rgba(231,76,60,0.15)' },
  'wipeout': { nome: 'Aniquila√ß√£o', cor: '#C0392B', bg: 'rgba(192,57,43,0.15)' },
  'siege': { nome: 'Cerco', cor: '#2980B9', bg: 'rgba(41,128,185,0.15)' },
  'unknown': { nome: 'Modo Especial', cor: '#95A5A6', bg: 'rgba(149,165,166,0.15)' }
};

const BRAWLERS_POR_MODO = {
  'gemgrab': { best: ['Poco', 'Gene', 'Max', 'Tara', 'Sandy'], worst: ['Shelly', 'Colt', 'El Primo', 'Bull', 'Darryl'] },
  'brawlball': { best: ['El Primo', 'Rosa', 'Frank', 'Bibi', 'Jacky'], worst: ['Piper', 'Brock', 'Tick', 'Barley', 'Dynamike'] },
  'heist': { best: ['Colt', 'Brock', 'Dynamike', 'Tick', 'Piper'], worst: ['Poco', 'Gene', 'Sandy', 'Frank', 'Rosa'] },
  'bounty': { best: ['Piper', 'Brock', 'Colt', 'Bo', '8-Bit'], worst: ['El Primo', 'Rosa', 'Bull', 'Darryl', 'Frank'] },
  'hotzone': { best: ['Sandy', 'Poco', 'Gene', 'Max', 'Sprout'], worst: ['Piper', 'Brock', 'Sniper', 'Colt', 'Tick'] },
  'knockout': { best: ['Brock', 'Piper', 'Colt', 'Bo', 'Spike'], worst: ['El Primo', 'Rosa', 'Bull', 'Frank', 'Darryl'] },
  'showdown': { best: ['Shelly', 'Bull', 'El Primo', 'Rosa', 'Brock'], worst: ['Poco', 'Gene', 'Sandy', 'Sprout', 'Tara'] },
  'soloshowdown': { best: ['Shelly', 'Bull', 'El Primo', 'Brock', 'Piper'], worst: ['Poco', 'Gene', 'Sandy', 'Sprout', 'Tara'] },
  'duoshowdown': { best: ['Poco', 'Gene', 'Sandy', 'Max', 'Shelly'], worst: ['Tick', 'Dynamike', 'Barley', 'Piper', 'Brock'] },
  'unknown': { best: ['‚Äî'], worst: ['‚Äî'] }
};

function getModo(name) {
  if(!name) return MODOS['unknown'];
  const cleanName = name.toLowerCase().replace(/\s+/g, '');
  return MODOS[cleanName] || MODOS['unknown'];
}

function getBrawlers(name) {
  if(!name) return BRAWLERS_POR_MODO['unknown'];
  const cleanName = name.toLowerCase().replace(/\s+/g, '');
  return BRAWLERS_POR_MODO[cleanName] || BRAWLERS_POR_MODO['unknown'];
}

function formatTempo(ms) {
  if (!ms || ms <= 0) return 'Encerrando...';
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  if (h > 0) return h + 'h ' + m + 'm';
  return m + 'm';
}

let eventTimers = [];

function renderMapas(eventos) {
  const grid = document.getElementById('mapGrid');
  const nextDiv = document.getElementById('nextMaps');
  
  eventTimers.forEach(t => clearInterval(t));
  eventTimers = [];

  if (!eventos || !eventos.length) {
    grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üó∫Ô∏è</div><p>NENHUM EVENTO ENCONTRADO</p></div>';
    nextDiv.innerHTML = '<div class="empty-state"><p>SEM PR√ìXIMOS EVENTOS</p></div>';
    return;
  }

  grid.innerHTML = '';
  
  // Como a API do Brawlify entrega eventos prontos em "data.active"
  eventos.forEach((ev, idx) => {
    const mapInfo = ev.map;
    const modoRawName = mapInfo.mode ? mapInfo.mode.name : 'unknown';
    const modo = getModo(modoRawName);
    const brawlers = getBrawlers(modoRawName);
    
    const mapName = mapInfo.name || 'Mapa';
    const imgUrl = mapInfo.imageUrl || 'https://cdn.brawlify.com/map/regular/default.png';
    const endTime = ev.endTime ? new Date(ev.endTime).getTime() : 0;

    const card = document.createElement('div');
    card.className = 'map-card';
    card.style.animationDelay = (idx * 0.07) + 's';

    const timerId = 'timer_' + idx;

    card.innerHTML = `
      <div class="map-card-top">
        <img src="${imgUrl}" onerror="this.src='https://cdn.brawlify.com/map/regular/default.png'" alt="${mapName}">
        <div class="map-mode-badge" style="background:${modo.bg};color:${modo.cor};border:1px solid ${modo.cor}40;">${modo.nome}</div>
        <div class="map-timer" id="${timerId}">‚è± --</div>
      </div>
      <div class="map-card-body">
        <div class="map-name">${mapName}</div>
        <div class="brawler-section">
          <div class="brawler-section-title best">‚úÖ MELHORES</div>
          <div class="brawler-tags">${brawlers.best.map(b => `<span class="brawler-tag best">${b}</span>`).join('')}</div>
        </div>
        <div class="brawler-section" style="margin-top:8px;">
          <div class="brawler-section-title worst">‚ùå PIORES</div>
          <div class="brawler-tags">${brawlers.worst.map(b => `<span class="brawler-tag worst">${b}</span>`).join('')}</div>
        </div>
      </div>`;
    grid.appendChild(card);

    const updateTimer = () => {
      const el = document.getElementById(timerId);
      if (!el) return;
      const diff = endTime - Date.now();
      el.textContent = '‚è± ' + formatTempo(diff);
    };
    updateTimer();
    const t = setInterval(updateTimer, 30000);
    eventTimers.push(t);
  });

  // Limpa se√ß√£o "Pr√≥ximos" pois a API do Brawlify para isso √© separada
  nextDiv.innerHTML = '<div style="font-family:JetBrains Mono,monospace;font-size:0.7rem;color:var(--text-muted);text-align:center;padding:20px;">Confira os pr√≥ximos eventos dispon√≠veis no jogo</div>';

  const t = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
  document.getElementById('updateInfoMapas').textContent = 'üü¢ ' + t;
}

async function carregarMapas() {
  try {
    const res = await fetch('/.netlify/functions/player?type=events');
    if (!res.ok) throw new Error('Erro ao buscar eventos');
    const data = await res.json();
    renderMapas(data);
  } catch(e) {
    document.getElementById('mapGrid').innerHTML = '<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">‚ö†Ô∏è</div><p>ERRO AO CARREGAR MAPAS</p></div>';
    document.getElementById('updateInfoMapas').textContent = 'üî¥ ERRO';
  }
}

let mapaCarregado = false;

// Ranking Firebase
let activeCity = 'Agrestina-PE';
let allPlayers = [];
const cityBar = document.getElementById('cityBar');
const citySelect = document.getElementById('inputCity');
CITIES.forEach(c => {
  const btn = document.createElement('button');
  btn.className = 'city-btn' + (c === activeCity ? ' active' : '');
  btn.textContent = c; btn.dataset.city = c;
  btn.onclick = () => setCity(c);
  cityBar.appendChild(btn);
  const opt = document.createElement('option');
  opt.value = c; opt.textContent = c;
  citySelect.appendChild(opt);
});

function setCity(city) {
  activeCity = city;
  document.querySelectorAll('.city-btn').forEach(b => b.classList.toggle('active', b.dataset.city === city));
  document.getElementById('activeCityTag').textContent = city.toUpperCase();
  renderRanking();
}

const q = query(collection(db, 'players'), orderBy('trophies', 'desc'));
onSnapshot(q, snapshot => {
  allPlayers = [];
  snapshot.forEach(d => allPlayers.push({ id: d.id, ...d.data() }));
  renderRanking(); renderRankingPE();
  const t = new Date().toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit'});
  document.getElementById('updateInfo').textContent = 'üü¢ ' + t;
  document.getElementById('updateInfoPE').textContent = 'üü¢ ' + t;
}, () => {
  document.getElementById('updateInfo').textContent = 'üî¥ OFFLINE';
  document.getElementById('updateInfoPE').textContent = 'üî¥ OFFLINE';
});

async function buscarJogador(tag) {
  const cleanTag = tag.startsWith('#') ? tag : '#' + tag;
  const res = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent(cleanTag));
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error || 'Erro ao buscar jogador');
  }
  return await res.json();
}

async function atualizarDados() {
  if (!allPlayers.length) return;
  for (const player of allPlayers) {
    try {
      const data = await buscarJogador(player.tag);
      const updates = {};
      if (data.trophies && data.trophies !== player.trophies) updates.trophies = data.trophies;
      if (data.horas && data.horas !== player.horas) updates.horas = data.horas;
      if (Object.keys(updates).length > 0) {
        await updateDoc(doc(db, 'players', player.id), updates);
      }
    } catch(e) {}
  }
}
setTimeout(atualizarDados, 5000);
setInterval(atualizarDados, 30 * 60 * 1000);

function tagValida(tag) {
  const semHash = tag.replace('#','');
  return /^[0289PYLQGRJCUV]{4,12}$/i.test(semHash);
}

window.register = async function() {
  const btn = document.getElementById('btnRegister');
  let tag = document.getElementById('inputTag').value.trim().toUpperCase();
  const city = document.getElementById('inputCity').value;
  if (!tag) return showToast('Digite sua TAG!', 'error');
  if (!tag.startsWith('#')) tag = '#' + tag;
  if (!tagValida(tag)) return showToast('TAG inv√°lida! Use sua TAG real do Brawl Stars.', 'error');
  if (allPlayers.find(p => p.tag.toUpperCase() === tag)) return showToast('TAG j√° cadastrada!', 'error');
  btn.disabled = true; btn.textContent = 'BUSCANDO...';
  showToast('üîç Buscando dados no Brawl Stars...', 'info');
  try {
    const data = await buscarJogador(tag);
    if (!data.trophies || !data.name) throw new Error('Jogador n√£o encontrado');
    const name = data.name;
    const trophies = data.trophies;
    const horas = data.horas || 0;
    const emoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    const color = COLORS[Math.floor(Math.random()*COLORS.length)];
    await addDoc(collection(db, 'players'), { name, tag, city, trophies, horas, emoji, color, joined: Date.now() });
    document.getElementById('inputTag').value = '';
    showToast('‚úì ' + name + ' entrou com ' + trophies.toLocaleString('pt-BR') + ' trof√©us!', 'success');
    setCity(city);
  } catch(e) {
    showToast('‚ùå ' + (e.message || 'Erro ao buscar jogador. Verifique a TAG!'), 'error');
  }
  btn.disabled = false; btn.textContent = 'ENTRAR NO RANKING';
};

function showToast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type;
  clearTimeout(t._t); t._t = setTimeout(() => t.className = 'toast', 5000);
}

function buildCards(players, containerId) {
  const list = document.getElementById(containerId);
  if (!players.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üéÆ</div><p>NENHUM JOGADOR AINDA</p></div>'; return; }
  list.innerHTML = '';
  players.forEach((p, i) => {
    const pos = i+1;
    const topClass = pos===1?'top1':pos===2?'top2':pos===3?'top3':'';
    const rankClass = pos===1?'r1':pos===2?'r2':pos===3?'r3':'rn';
    const rankLabel = pos===1?'ü•á':pos===2?'ü•à':pos===3?'ü•â':'#'+pos;
    const cleanTag = p.tag.replace('#','');
    const horas = p.horas || '?';
    const card = document.createElement('div');
    card.className = 'player-card ' + topClass;
    card.style.animationDelay = (i*0.04) + 's';
    card.innerHTML = (pos===1?'<div class="crown-icon">üëë</div><div class="shimmer"></div>':'') +
      '<div class="rank-num ' + rankClass + '">' + rankLabel + '</div>' +
      '<div class="player-avatar" style="background:' + p.color + '15;border:1px solid ' + p.color + '28;">' + p.emoji + '</div>' +
      '<div class="player-info"><div class="player-name">' + p.name + '</div>' +
      '<div class="player-meta"><span class="player-tag">' + p.tag + '</span>' +
      '<span class="player-city">üìç ' + p.city + '</span>' +
      '<a class="verify-link" href="https://brawlify.com/stats/profile/' + cleanTag + '" target="_blank">‚Üó BRAWLIFY</a></div></div>' +
      '<div class="player-score">' +
      '<div class="trophy-num">üèÜ ' + p.trophies.toLocaleString('pt-BR') + '</div><div class="trophy-label">TROF√âUS</div>' +
      '<div class="horas-num">‚è± ' + horas + 'h</div><div class="horas-label">DE JOGO</div>' +
      '</div>';
    list.appendChild(card);
  });
}

function renderRanking() { buildCards(allPlayers.filter(p => p.city === activeCity).sort((a,b) => b.trophies-a.trophies), 'rankingList'); }
function renderRankingPE() { buildCards([...allPlayers].sort((a,b) => b.trophies-a.trophies), 'rankingListPE'); }

window.carregarMapas = carregarMapas;
</script>

<audio id="bgMusic" src="song.mp3" loop preload="auto"></audio>
<script>
document.addEventListener('click', function startMusic() {
  const music = document.getElementById('bgMusic');
  if (music.paused) { music.volume = 0.4; music.play(); }
  document.removeEventListener('click', startMusic);
}, { once: false });

function toggleMusic() {
  const music = document.getElementById('bgMusic');
  const btn = document.getElementById('musicBtn');
  if (music.paused) { music.play(); btn.textContent = 'üîä'; }
  else { music.pause(); btn.textContent = 'üîá'; }
}

function switchTab(tab, el) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-'+tab).classList.add('active');
  el.classList.add('active');
  document.getElementById('cityBar').style.display = tab==='cidade'?'flex':'none';
  if (tab === 'mapas' && !window._mapaCarregado) {
    window._mapaCarregado = true;
    setTimeout(function() {
      if (typeof window.carregarMapas === 'function') {
        window.carregarMapas();
        setInterval(window.carregarMapas, 5 * 60 * 1000);
      }
    }, 300);
  }
}
</script>
</body>
</html>
