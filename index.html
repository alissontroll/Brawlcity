<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BrawlCity Rank</title>
<link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;500;600;700&family=Barlow:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
/* ===== BRAWLCITY v4 ‚Äî SUPERCELL NEON ===== */
@import url('https://fonts.googleapis.com/css2?family=Lilita+One&family=Nunito:wght@700;800;900&family=JetBrains+Mono:wght@400;700&display=swap');

:root {
  --bg: #0a0612;
  --bg2: #0f0a1a;
  --surface: #16102a;
  --surface2: #1e1638;
  --surface3: #261e46;
  --border: rgba(138,43,226,0.18);
  --border2: rgba(138,43,226,0.35);
  --purple: #8a2be2;
  --purple2: #b44fff;
  --purple3: #d580ff;
  --neon: #c940ff;
  --neon2: #e040fb;
  --gold: #FFD000;
  --gold2: #FF9500;
  --silver: #c0d0e0;
  --bronze: #cd7f32;
  --green: #00e676;
  --red: #ff1744;
  --cyan: #00e5ff;
  --pe: #ff6d00;
  --text: #f0eaff;
  --text-dim: rgba(240,234,255,0.55);
  --text-muted: rgba(240,234,255,0.3);
  --glow-purple: rgba(138,43,226,0.4);
  --glow-gold: rgba(255,208,0,0.4);
  --r: 14px;
}

*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* Fundo neon com nebulosa */
body::before {
  content: '';
  position: fixed;
  inset: 0;
  background:
    radial-gradient(ellipse 80% 60% at 50% -10%, rgba(138,43,226,0.15) 0%, transparent 60%),
    radial-gradient(ellipse 50% 40% at 90% 100%, rgba(201,64,255,0.1) 0%, transparent 55%),
    radial-gradient(ellipse 40% 30% at 0% 80%, rgba(0,229,255,0.06) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
}

/* Estrelas de fundo */
body::after {
  content: '';
  position: fixed;
  inset: 0;
  background-image:
    radial-gradient(1px 1px at 15% 20%, rgba(255,255,255,0.4) 0%, transparent 100%),
    radial-gradient(1px 1px at 75% 10%, rgba(255,255,255,0.3) 0%, transparent 100%),
    radial-gradient(1px 1px at 40% 60%, rgba(255,255,255,0.25) 0%, transparent 100%),
    radial-gradient(1px 1px at 90% 45%, rgba(255,255,255,0.35) 0%, transparent 100%),
    radial-gradient(1px 1px at 25% 85%, rgba(255,255,255,0.2) 0%, transparent 100%),
    radial-gradient(2px 2px at 60% 30%, rgba(201,64,255,0.5) 0%, transparent 100%),
    radial-gradient(2px 2px at 10% 55%, rgba(0,229,255,0.4) 0%, transparent 100%);
  pointer-events: none;
  z-index: 0;
}

/* ===== HEADER ===== */
header {
  position: relative;
  z-index: 10;
  padding: 32px 20px 24px;
  text-align: center;
  border-bottom: 1px solid var(--border);
  background: linear-gradient(180deg, rgba(138,43,226,0.12) 0%, transparent 100%);
}

.logo {
  font-family: 'Lilita One', cursive;
  font-size: clamp(3rem, 13vw, 6.5rem);
  letter-spacing: 2px;
  line-height: 1;
  background: linear-gradient(135deg, #fff 0%, var(--purple3) 30%, var(--neon) 60%, var(--gold) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 40px rgba(201,64,255,0.5));
  animation: logoIn 0.8s cubic-bezier(.16,1,.3,1) both;
}

@keyframes logoIn {
  from { transform: translateY(-30px) scale(0.9); opacity: 0; filter: blur(15px) drop-shadow(0 0 40px rgba(201,64,255,0.5)); }
  to   { transform: translateY(0) scale(1); opacity: 1; filter: drop-shadow(0 0 40px rgba(201,64,255,0.5)); }
}

.logo-sub {
  font-size: 0.65rem;
  font-weight: 900;
  letter-spacing: 6px;
  color: var(--text-dim);
  text-transform: uppercase;
  margin-top: 6px;
  animation: fadeUp 0.7s 0.25s both;
}

@keyframes fadeUp { from { transform:translateY(10px); opacity:0 } to { transform:translateY(0); opacity:1 } }

.live-badge {
  display: inline-flex;
  align-items: center;
  gap: 7px;
  background: rgba(0,230,118,0.08);
  border: 1px solid rgba(0,230,118,0.22);
  border-radius: 30px;
  padding: 5px 14px;
  font-weight: 900;
  font-size: 0.62rem;
  color: var(--green);
  letter-spacing: 3px;
  text-transform: uppercase;
  margin-top: 12px;
  animation: fadeUp 0.7s 0.4s both;
}

.live-dot {
  width: 7px; height: 7px;
  background: var(--green);
  border-radius: 50%;
  box-shadow: 0 0 10px var(--green);
  animation: blink 1.4s infinite;
}

@keyframes blink {
  0%,100% { opacity:1; box-shadow:0 0 10px var(--green); }
  50% { opacity:0.3; box-shadow:none; }
}

/* ===== TABS ===== */
.tab-bar {
  position: relative;
  z-index: 10;
  display: flex;
  max-width: 780px;
  margin: 0 auto;
  padding: 14px 12px 0;
  gap: 6px;
  overflow-x: auto;
  scrollbar-width: none;
}
.tab-bar::-webkit-scrollbar { display: none; }

.tab-btn {
  flex-shrink: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 9px 16px;
  font-family: 'Nunito', sans-serif;
  font-weight: 900;
  font-size: 0.78rem;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  border-radius: 30px;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

.tab-btn:hover { color: var(--text); background: var(--surface2); border-color: var(--border2); }

.tab-btn.active {
  background: linear-gradient(135deg, var(--purple), var(--neon));
  border-color: var(--neon);
  color: #fff;
  box-shadow: 0 4px 20px var(--glow-purple);
}

.tab-btn.pe-tab.active {
  background: linear-gradient(135deg, #e65100, var(--pe));
  border-color: var(--pe);
  box-shadow: 0 4px 20px rgba(255,109,0,0.4);
}

.tab-btn.map-tab.active {
  background: linear-gradient(135deg, #00897b, var(--green));
  border-color: var(--green);
  color: #000;
  box-shadow: 0 4px 20px rgba(0,230,118,0.35);
}

.tab-btn.notif-tab.active {
  background: linear-gradient(135deg, #e65100, #ff9800);
  border-color: #ff9800;
  color: #000;
  box-shadow: 0 4px 20px rgba(255,152,0,0.35);
}

.notif-badge {
  display: inline-block;
  background: #f44336;
  color: #fff;
  border-radius: 50%;
  width: 16px; height: 16px;
  font-size: 0.6rem;
  text-align: center;
  line-height: 16px;
  margin-left: 4px;
  animation: pulse 1.5s infinite;
}

@keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.2)} }

/* ===== CITY BAR ===== */
.city-bar {
  position: relative;
  z-index: 10;
  display: flex;
  gap: 8px;
  padding: 12px 12px 0;
  overflow-x: auto;
  scrollbar-width: none;
  max-width: 780px;
  margin: 0 auto;
}
.city-bar::-webkit-scrollbar { display: none; }

.city-btn {
  flex-shrink: 0;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text-dim);
  padding: 6px 16px;
  border-radius: 30px;
  font-family: 'Nunito', sans-serif;
  font-weight: 800;
  font-size: 0.75rem;
  cursor: pointer;
  transition: all 0.2s;
  text-transform: uppercase;
  white-space: nowrap;
}

.city-btn:hover { border-color: var(--purple2); color: var(--purple3); }
.city-btn.active {
  background: rgba(138,43,226,0.15);
  border-color: var(--purple2);
  color: var(--purple3);
  box-shadow: 0 0 16px rgba(138,43,226,0.2);
}

/* ===== MAIN ===== */
main {
  position: relative;
  z-index: 10;
  max-width: 780px;
  margin: 0 auto;
  padding: 16px 12px 80px;
  background: rgba(10,6,18,0.6);
  border: 1px solid var(--border);
  border-top: none;
  border-radius: 0 0 var(--r) var(--r);
  backdrop-filter: blur(8px);
}

.tab-content { display: none; }
.tab-content.active { display: block; }

/* ===== FORM ===== */
.register-card {
  background: var(--surface);
  border: 1px solid var(--border2);
  border-radius: var(--r);
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.4), inset 0 1px 0 rgba(201,64,255,0.1);
}

.section-label {
  font-family: 'Lilita One', cursive;
  font-size: 1.1rem;
  letter-spacing: 2px;
  color: var(--purple3);
  text-transform: uppercase;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  gap: 10px;
}
.section-label::after { content:''; flex:1; height:1px; background:linear-gradient(90deg,var(--border2),transparent); }

.form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-grid .full { grid-column: 1/-1; }
.input-wrap { display: flex; flex-direction: column; gap: 5px; }
.input-wrap label { font-size: 0.62rem; font-weight: 900; letter-spacing: 2px; color: var(--text-muted); text-transform: uppercase; }

.input-wrap input, .input-wrap select {
  background: var(--bg2);
  border: 1.5px solid var(--border);
  border-radius: 10px;
  color: var(--text);
  font-family: 'Nunito', sans-serif;
  font-size: 0.95rem;
  font-weight: 700;
  padding: 11px 14px;
  outline: none;
  transition: all 0.2s;
  width: 100%;
}
.input-wrap input::placeholder { color: var(--text-muted); }
.input-wrap input:focus, .input-wrap select:focus {
  border-color: var(--purple2);
  box-shadow: 0 0 0 3px rgba(138,43,226,0.2);
}
.input-wrap select option { background: #0f0a1a; }
.hint { font-size: 0.63rem; color: var(--text-muted); font-weight: 700; margin-top: 2px; }

.btn-register {
  background: linear-gradient(135deg, var(--purple), var(--neon2));
  border: none;
  border-radius: 10px;
  color: #fff;
  font-family: 'Lilita One', cursive;
  font-size: 1.1rem;
  letter-spacing: 2px;
  padding: 13px 24px;
  cursor: pointer;
  transition: all 0.2s;
  width: 100%;
  text-transform: uppercase;
  box-shadow: 0 4px 20px var(--glow-purple);
}
.btn-register:hover { transform: translateY(-2px); box-shadow: 0 8px 30px var(--glow-purple); }
.btn-register:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

.toast { display:none; padding:11px 14px; border-radius:10px; margin-top:12px; font-size:0.85rem; font-weight:800; }
.toast.success { display:block; background:rgba(0,230,118,0.08); border:1px solid rgba(0,230,118,0.25); color:var(--green); }
.toast.error { display:block; background:rgba(255,23,68,0.08); border:1px solid rgba(255,23,68,0.2); color:#ff8a80; }
.toast.info { display:block; background:rgba(138,43,226,0.08); border:1px solid rgba(138,43,226,0.25); color:var(--purple3); }

/* ===== RANKING HEADER ===== */
.ranking-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}
.ranking-title { font-family:'Lilita One',cursive; font-size:1.3rem; letter-spacing:1px; display:flex; align-items:center; gap:10px; }

.city-pill {
  font-size: 0.6rem; font-weight: 900;
  background: rgba(138,43,226,0.15);
  border: 1px solid rgba(138,43,226,0.3);
  color: var(--purple3);
  padding: 3px 10px; border-radius: 20px; letter-spacing: 1px;
}
.pe-pill {
  font-size: 0.6rem; font-weight: 900;
  background: rgba(255,109,0,0.12);
  border: 1px solid rgba(255,109,0,0.3);
  color: #ffab40;
  padding: 3px 10px; border-radius: 20px; letter-spacing: 1px;
}
.update-info { font-size: 0.62rem; font-weight: 800; color: var(--text-muted); letter-spacing: 1px; text-transform: uppercase; }

/* ===== PLAYER CARDS ‚Äî BRAWLER ATR√ÅS ===== */
.player-card {
  position: relative;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 0;
  margin-bottom: 10px;
  overflow: hidden;
  transition: all 0.25s cubic-bezier(.4,0,.2,1);
  animation: cardIn 0.45s ease both;
  cursor: pointer;
  min-height: 80px;
}

.player-card:hover {
  transform: translateY(-3px) scale(1.01);
  border-color: var(--border2);
  box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 0 20px rgba(138,43,226,0.15);
}

/* Imagem do brawler no fundo */
.card-brawler-bg {
  position: absolute;
  right: -10px;
  top: 50%;
  transform: translateY(-50%);
  width: 110px;
  height: 110px;
  object-fit: contain;
  opacity: 0.18;
  filter: saturate(1.5);
  pointer-events: none;
  transition: opacity 0.3s;
}
.player-card:hover .card-brawler-bg { opacity: 0.28; }

/* Gradiente sobre o brawler */
.card-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(90deg, var(--surface) 55%, transparent 100%);
  pointer-events: none;
}

.card-content {
  position: relative;
  z-index: 2;
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 16px;
}

/* Top 1 especial */
.player-card.top1 {
  border-color: rgba(255,208,0,0.3);
  background: linear-gradient(135deg, rgba(255,208,0,0.07) 0%, var(--surface) 60%);
}
.player-card.top1 .card-overlay {
  background: linear-gradient(90deg, rgba(20,15,35,0.97) 50%, transparent 100%);
}
.player-card.top1 .card-brawler-bg { opacity: 0.25; }
.player-card.top1:hover .card-brawler-bg { opacity: 0.4; }

.player-card.top2 { border-color: rgba(192,208,224,0.2); }
.player-card.top3 { border-color: rgba(205,127,50,0.2); }

@keyframes cardIn { from{transform:translateY(20px);opacity:0} to{transform:translateY(0);opacity:1} }

/* Rank */
.rank-num {
  font-family: 'Lilita One', cursive;
  font-size: 1.6rem;
  min-width: 40px;
  text-align: center;
  line-height: 1;
  flex-shrink: 0;
}
.r1 {
  background: linear-gradient(135deg, #fff 0%, var(--gold) 50%, var(--gold2) 100%);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  filter: drop-shadow(0 0 10px rgba(255,208,0,0.6));
}
.r2 { color: var(--silver); }
.r3 { color: var(--bronze); }
.rn { color: var(--text-muted); font-size: 1rem; font-family: 'Nunito',sans-serif; font-weight: 900; }

/* Avatar */
.player-avatar {
  width: 48px; height: 48px;
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 1.5rem;
  flex-shrink: 0;
  background: var(--surface2);
  border: 2.5px solid var(--border2);
  overflow: hidden;
  transition: border-color 0.2s, box-shadow 0.2s;
}
.player-card:hover .player-avatar { border-color: var(--purple2); box-shadow: 0 0 16px var(--glow-purple); }
.player-card.top1 .player-avatar { border-color: rgba(255,208,0,0.5); box-shadow: 0 0 16px var(--glow-gold); }
.player-avatar img { width:100%; height:100%; object-fit:cover; }

/* Info */
.player-info { flex: 1; min-width: 0; }
.player-name {
  font-family: 'Nunito', sans-serif;
  font-weight: 900;
  font-size: 1rem;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #fff;
  line-height: 1.2;
}
.player-meta { display:flex; align-items:center; gap:6px; margin-top:5px; flex-wrap:wrap; }
.player-tag { font-family: 'JetBrains Mono',monospace; font-size:0.58rem; color:var(--text-muted); }
.player-city {
  font-size: 0.65rem; font-weight: 800;
  color: var(--text-dim);
  background: rgba(255,255,255,0.06);
  padding: 2px 8px; border-radius: 20px;
}
.verify-link {
  font-weight: 800; font-size: 0.58rem;
  color: var(--purple3); text-decoration: none;
  opacity: 0.5; transition: opacity 0.2s;
}
.verify-link:hover { opacity: 1; }

/* Score */
.player-score { display:flex; flex-direction:column; align-items:flex-end; flex-shrink:0; gap:3px; }
.trophy-num {
  font-family: 'Lilita One', cursive;
  font-size: 1.4rem;
  color: var(--gold);
  filter: drop-shadow(0 0 8px rgba(255,208,0,0.4));
  line-height: 1;
}
.trophy-label { font-size:0.5rem; font-weight:900; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }
.horas-num { font-size:0.9rem; font-weight:900; color:var(--cyan); line-height:1; }
.horas-label { font-size:0.48rem; font-weight:900; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase; }

/* Coroa top1 */
.crown-icon {
  position:absolute; top:-2px; right:16px;
  font-size:1.1rem;
  animation: floatCrown 2.5s ease-in-out infinite;
  filter: drop-shadow(0 0 10px rgba(255,208,0,0.8));
  z-index: 3;
}
@keyframes floatCrown {
  0%,100% { transform:translateY(0) rotate(-8deg); }
  50% { transform:translateY(-7px) rotate(8deg); }
}

/* Brilho sweeping top1 */
.shimmer {
  position:absolute; inset:0;
  background:linear-gradient(105deg,transparent 30%,rgba(255,208,0,0.05) 50%,transparent 70%);
  animation:sweep 3s infinite;
  z-index:1;
}
@keyframes sweep { 0%{transform:translateX(-100%)} 100%{transform:translateX(200%)} }

/* ===== SKELETON LOADING ===== */
.skeleton {
  background: linear-gradient(90deg, var(--surface) 25%, var(--surface2) 50%, var(--surface) 75%);
  background-size: 200% 100%;
  animation: skwave 1.6s infinite;
  border-radius: 8px;
}
@keyframes skwave { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

.skeleton-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r);
  padding: 14px 16px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 12px;
  min-height: 80px;
}
.skeleton-rank { width:40px; height:32px; border-radius:6px; flex-shrink:0; }
.skeleton-avatar { width:48px; height:48px; border-radius:50%; flex-shrink:0; }
.skeleton-info { flex:1; display:flex; flex-direction:column; gap:8px; }
.skeleton-name { height:16px; width:55%; }
.skeleton-meta { height:12px; width:35%; }
.skeleton-score { display:flex; flex-direction:column; align-items:flex-end; gap:6px; }
.skeleton-trofeus { width:65px; height:22px; }
.skeleton-horas { width:45px; height:13px; }

/* ===== BANNERS & MISC ===== */
.pe-banner {
  background: linear-gradient(135deg, rgba(255,109,0,0.1), rgba(255,152,0,0.06));
  border: 1px solid rgba(255,109,0,0.22);
  border-radius: var(--r);
  padding: 16px 20px;
  margin-bottom: 20px;
  display: flex; align-items:center; gap:14px;
}
.pe-flag { font-size: 2rem; }
.pe-title { font-family:'Lilita One',cursive; font-size:1.3rem; letter-spacing:2px; color:var(--pe); }
.pe-desc { font-size:0.73rem; font-weight:800; color:var(--text-dim); margin-top:2px; }

.info-bar {
  background: rgba(138,43,226,0.05);
  border: 1px solid rgba(138,43,226,0.12);
  border-radius: 10px;
  padding:10px 14px; margin-bottom:18px;
  font-size:0.75rem; font-weight:800; color:var(--text-muted); line-height:1.5;
}
.info-bar span { color: var(--purple3); }

.empty-state, .loading-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
.empty-icon { font-size:2.5rem; margin-bottom:12px; opacity:0.4; }
.empty-state p, .loading-state p { font-weight:900; font-size:0.75rem; letter-spacing:2px; text-transform:uppercase; }

/* ===== MAPAS ===== */
.map-card {
  background:var(--surface); border:1px solid var(--border); border-radius:var(--r);
  overflow:hidden; margin-bottom:14px; animation:cardIn 0.4s ease both;
  transition:all 0.22s; cursor:pointer;
}
.map-card:hover { transform:translateY(-3px); border-color:rgba(0,230,118,0.3); box-shadow:0 10px 36px rgba(0,0,0,0.4); }
.map-card-top { position:relative; height:200px; overflow:hidden; background:var(--bg2); }
.map-card-top img { width:100%; height:100%; object-fit:cover; transition:transform 0.3s; }
.map-card:hover .map-card-top img { transform:scale(1.04); }
.map-mode-badge { position:absolute; top:10px; left:10px; padding:4px 14px; border-radius:30px; font-weight:900; font-size:0.78rem; letter-spacing:1px; backdrop-filter:blur(10px); }
.map-timer { position:absolute; bottom:10px; right:10px; background:rgba(0,0,0,0.8); border:1px solid rgba(255,255,255,0.1); border-radius:30px; padding:4px 12px; font-family:'JetBrains Mono',monospace; font-weight:700; font-size:0.68rem; color:var(--gold); letter-spacing:1px; }
.map-card-body { padding:14px 16px; }
.map-name { font-family:'Lilita One',cursive; font-size:1.4rem; letter-spacing:1px; margin-bottom:12px; }
.brawler-section { margin-top:8px; }
.brawler-section-title { font-weight:900; font-size:0.6rem; letter-spacing:2px; margin-bottom:6px; text-transform:uppercase; }
.brawler-section-title.best { color:var(--green); }
.brawler-section-title.worst { color:#ff8a80; }
.brawler-tags { display:flex; flex-wrap:wrap; gap:4px; }
.brawler-tag { font-size:0.72rem; font-weight:800; padding:3px 10px; border-radius:20px; }
.brawler-tag.best { background:rgba(0,230,118,0.1); border:1px solid rgba(0,230,118,0.25); color:var(--green); }
.brawler-tag.worst { background:rgba(255,23,68,0.08); border:1px solid rgba(255,23,68,0.2); color:#ff8a80; }
.expand-hint { font-weight:800; font-size:0.6rem; color:var(--text-muted); letter-spacing:1px; margin-top:12px; text-align:center; padding:6px; border:1px dashed rgba(255,255,255,0.08); border-radius:8px; }
.next-preview { background:var(--bg2); border:1px solid rgba(0,230,118,0.15); border-radius:10px; padding:12px; margin-top:12px; }
.next-preview-title { font-weight:900; font-size:0.6rem; color:var(--green); letter-spacing:2px; margin-bottom:8px; text-transform:uppercase; }
.next-preview-img { width:100%; height:110px; object-fit:cover; border-radius:8px; margin-bottom:8px; }
.next-preview-name { font-weight:900; font-size:1rem; }
.next-preview-mode { font-size:0.72rem; color:var(--text-dim); margin-top:2px; font-weight:800; }

/* ===== SHARE BTN ===== */
.share-btn { background:linear-gradient(135deg,#1a5c30,#25d366); border:none; color:#fff; padding:11px 20px; border-radius:30px; font-weight:900; font-size:0.9rem; letter-spacing:1px; cursor:pointer; display:flex; align-items:center; gap:8px; margin:16px auto; width:100%; justify-content:center; transition:all 0.2s; }
.share-btn:hover { opacity:0.9; transform:translateY(-1px); }
#shareCanvas { display:none; }

/* ===== FOOTER ===== */
footer { position:relative; z-index:10; text-align:center; padding:18px; font-weight:900; font-size:0.6rem; color:var(--text-muted); letter-spacing:2px; border-top:1px solid var(--border); max-width:780px; margin:0 auto; text-transform:uppercase; }

/* ===== NOTIF ===== */
.notif-item { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:14px; margin-bottom:10px; display:flex; align-items:flex-start; gap:12px; }
.notif-icon { font-size:1.5rem; }
.notif-text { flex:1; }
.notif-name { font-family:'Lilita One',cursive; font-size:1.1rem; color:var(--purple3); letter-spacing:1px; }
.notif-desc { font-size:0.8rem; color:var(--text-muted); margin-top:2px; font-weight:700; }
.notif-time { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-dim); margin-top:4px; }
.notif-empty { text-align:center; padding:40px; color:var(--text-dim); font-family:'Lilita One',cursive; font-size:1.2rem; letter-spacing:2px; }

/* ===== PERFIL ===== */
.perfil-hero { background:linear-gradient(135deg,rgba(138,43,226,0.1),rgba(201,64,255,0.05)); border:1px solid rgba(138,43,226,0.2); border-radius:var(--r); padding:20px; margin-bottom:16px; display:flex; align-items:center; gap:16px; }
.perfil-avatar-big { width:72px; height:72px; border-radius:50%; border:3px solid var(--purple2); display:flex; align-items:center; justify-content:center; font-size:2.2rem; flex-shrink:0; overflow:hidden; background:var(--surface2); box-shadow:0 0 24px var(--glow-purple); }
.perfil-avatar-big img { width:100%; height:100%; object-fit:cover; }
.perfil-hero-info { flex:1; min-width:0; }
.perfil-hero-name { font-family:'Lilita One',cursive; font-size:1.8rem; letter-spacing:1px; color:#fff; line-height:1; }
.perfil-hero-tag { font-family:'JetBrains Mono',monospace; font-size:0.65rem; color:var(--text-muted); margin-top:2px; }
.perfil-hero-city { font-size:0.75rem; color:var(--text-dim); font-weight:800; margin-top:4px; }
.perfil-stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:16px; }
.perfil-stat { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:10px; text-align:center; }
.perfil-stat-val { font-family:'Lilita One',cursive; font-size:1.3rem; color:var(--gold); line-height:1; }
.perfil-stat-lbl { font-size:0.58rem; font-weight:900; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; margin-top:2px; }
.perfil-section-title { font-family:'Lilita One',cursive; font-size:1rem; letter-spacing:2px; color:var(--purple3); margin-bottom:10px; padding-bottom:6px; border-bottom:1px solid rgba(138,43,226,0.15); }
.brawler-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:16px; }
.brawler-card { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:8px; text-align:center; position:relative; overflow:hidden; transition:all 0.2s; }
.brawler-card:hover { border-color:var(--border2); transform:translateY(-2px); }
.brawler-card-img { width:52px; height:52px; object-fit:contain; display:block; margin:0 auto 4px; }
.brawler-card-name { font-weight:900; font-size:0.85rem; letter-spacing:1px; color:var(--text); line-height:1.1; }
.brawler-card-trofeus { font-family:'JetBrains Mono',monospace; font-size:0.62rem; color:var(--gold); }
.brawler-card-power { position:absolute; top:4px; right:4px; font-size:0.6rem; background:rgba(138,43,226,0.15); border:1px solid rgba(138,43,226,0.3); border-radius:4px; padding:1px 4px; color:var(--purple3); }
.perfil-victories { display:grid; grid-template-columns:repeat(3,1fr); gap:8px; margin-bottom:16px; }
.victory-box { background:var(--surface2); border:1px solid var(--border); border-radius:10px; padding:10px; text-align:center; }
.victory-val { font-family:'Lilita One',cursive; font-size:1.4rem; color:var(--green); }
.victory-lbl { font-size:0.58rem; font-weight:900; color:var(--text-dim); letter-spacing:1px; }
.perfil-loading { text-align:center; padding:30px; color:var(--text-dim); font-size:0.7rem; letter-spacing:2px; font-weight:800; }

/* ===== MVP BANNER ===== */
.mvp-banner { background:linear-gradient(135deg,#1a0f2e,#2d1f4a); border:2px solid rgba(201,64,255,0.4); border-radius:var(--r); padding:20px; margin-bottom:20px; text-align:center; position:relative; overflow:hidden; }
.mvp-banner::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse 80% 50% at 50% 0%,rgba(201,64,255,0.15) 0%,transparent 70%); pointer-events:none; }
.mvp-crown { font-size:2.5rem; animation:floatCrown 2s ease-in-out infinite; }
.mvp-title { font-family:'Lilita One',cursive; font-size:0.85rem; letter-spacing:3px; color:var(--purple3); margin:4px 0; text-transform:uppercase; }
.mvp-name { font-family:'Lilita One',cursive; font-size:2rem; color:#fff; letter-spacing:2px; margin:4px 0; }
.mvp-gain { font-family:'JetBrains Mono',monospace; font-size:1rem; color:var(--green); margin:4px 0; }
.mvp-emoji { font-size:2rem; }
.firework { position:absolute; width:6px; height:6px; border-radius:50%; animation:firework 1.5s ease-out infinite; }
@keyframes firework { 0%{transform:translate(0,0) scale(1);opacity:1} 100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0} }

/* ===== CELEBRA√á√ÉO ===== */
.celebracao-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:2000; align-items:center; justify-content:center; flex-direction:column; text-align:center; padding:20px; }
.celebracao-overlay.ativa { display:flex; }
.celebracao-titulo { font-family:'Lilita One',cursive; font-size:3.5rem; color:var(--neon); letter-spacing:4px; animation:pulse 1s ease-in-out infinite; }
.celebracao-sub { font-family:'Lilita One',cursive; font-size:1.2rem; color:#fff; letter-spacing:3px; margin-bottom:20px; }
.celebracao-nome { font-family:'Lilita One',cursive; font-size:2.8rem; color:#fff; letter-spacing:2px; margin:10px 0; }
.celebracao-trofeus { font-family:'JetBrains Mono',monospace; font-size:1.1rem; color:var(--green); margin:10px 0; }
.celebracao-foto { width:80px; height:80px; border-radius:50%; border:3px solid var(--neon); margin:10px auto; box-shadow:0 0 30px var(--glow-purple); }
.celebracao-fechar { margin-top:24px; background:none; border:1px solid var(--neon); color:var(--neon); padding:10px 30px; border-radius:30px; font-family:'Lilita One',cursive; font-size:1rem; letter-spacing:2px; cursor:pointer; }
.fogo-celebracao { position:fixed; width:8px; height:8px; border-radius:50%; pointer-events:none; z-index:2001; }
@keyframes fogo-anim { 0%{transform:translate(0,0) scale(1);opacity:1} 100%{transform:translate(var(--tx),var(--ty)) scale(0);opacity:0} }

/* ===== IA ===== */
.ia-section { background:var(--surface2); border-radius:10px; padding:14px; margin-bottom:16px; border:1px solid rgba(138,43,226,0.18); }
.ia-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
.ia-title { font-family:'Lilita One',cursive; font-size:1.05rem; letter-spacing:1px; color:var(--purple3); }
.ia-status { display:flex; align-items:center; gap:5px; font-size:0.55rem; font-weight:900; color:var(--green); letter-spacing:2px; }
.ia-dot { width:6px; height:6px; background:var(--green); border-radius:50%; box-shadow:0 0 6px var(--green); animation:blink 1.4s infinite; }
.ia-messages { max-height:260px; overflow-y:auto; display:flex; flex-direction:column; gap:10px; margin-bottom:10px; padding-right:2px; scrollbar-width:thin; scrollbar-color:rgba(138,43,226,0.2) transparent; }
.ia-messages::-webkit-scrollbar { width:4px; }
.ia-messages::-webkit-scrollbar-thumb { background:rgba(138,43,226,0.2); border-radius:4px; }
.ia-msg { display:flex; gap:8px; align-items:flex-end; }
.ia-msg-bot { flex-direction:row; }
.ia-msg-user { flex-direction:row-reverse; }
.ia-msg-avatar { font-size:1.2rem; flex-shrink:0; margin-bottom:2px; }
.ia-msg-bubble { padding:9px 12px; border-radius:12px; font-size:0.82rem; font-weight:700; line-height:1.55; max-width:85%; word-break:break-word; }
.ia-msg-bot .ia-msg-bubble { background:var(--surface); border:1px solid rgba(138,43,226,0.15); color:var(--text); border-bottom-left-radius:3px; }
.ia-msg-user .ia-msg-bubble { background:linear-gradient(135deg,rgba(138,43,226,0.2),rgba(201,64,255,0.15)); border:1px solid rgba(138,43,226,0.3); color:var(--text); border-bottom-right-radius:3px; }
.ia-typing { display:flex; gap:4px; align-items:center; padding:10px 14px; }
.ia-typing-dot { width:6px; height:6px; background:var(--purple2); border-radius:50%; animation:typing-bounce 1.2s infinite; }
.ia-typing-dot:nth-child(2) { animation-delay:0.2s; }
.ia-typing-dot:nth-child(3) { animation-delay:0.4s; }
@keyframes typing-bounce { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-6px)} }
.ia-suggestions { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:10px; }
.ia-chip { background:rgba(138,43,226,0.08); border:1px solid rgba(138,43,226,0.22); color:var(--purple3); font-size:0.72rem; font-weight:800; padding:5px 12px; border-radius:20px; cursor:pointer; transition:all 0.18s; white-space:nowrap; }
.ia-chip:hover { background:rgba(138,43,226,0.18); border-color:var(--purple2); }
.ia-input-row { display:flex; gap:8px; }
.ia-input { flex:1; background:var(--bg2); border:1.5px solid var(--border); border-radius:10px; color:var(--text); font-size:0.88rem; font-weight:700; padding:9px 12px; outline:none; transition:border 0.2s; }
.ia-input:focus { border-color:var(--purple2); box-shadow:0 0 0 3px rgba(138,43,226,0.15); }
.ia-send-btn { background:linear-gradient(135deg,var(--purple),var(--neon)); border:none; border-radius:10px; color:#fff; font-size:1.1rem; width:40px; height:40px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; transition:opacity 0.2s; font-weight:bold; }
.ia-send-btn:disabled { opacity:0.4; cursor:not-allowed; }
.ia-send-btn:hover:not(:disabled) { opacity:0.85; }

/* ===== ADMIN ===== */
.admin-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:3000; align-items:center; justify-content:center; padding:16px; }
.admin-overlay.open { display:flex; }
.admin-box { background:#0d0e17; border:1px solid rgba(138,43,226,0.4); border-radius:var(--r); width:100%; max-width:420px; max-height:90vh; overflow-y:auto; padding:24px; }
.admin-title { font-family:'Lilita One',cursive; font-size:1.5rem; color:var(--purple3); letter-spacing:2px; margin-bottom:20px; text-align:center; }
.admin-input { width:100%; background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:8px; font-family:monospace; font-size:0.9rem; margin-bottom:10px; box-sizing:border-box; }
.admin-btn { width:100%; padding:10px; border-radius:8px; font-family:'Lilita One',cursive; font-size:1rem; letter-spacing:1px; cursor:pointer; border:none; margin-bottom:8px; }
.admin-btn-primary { background:linear-gradient(135deg,var(--purple),var(--neon)); color:#fff; }
.admin-btn-secondary { background:var(--surface2); border:1px solid var(--border); color:var(--text); }
.admin-section { margin-bottom:20px; padding-bottom:20px; border-bottom:1px solid var(--border); }
.admin-section-title { font-family:'Lilita One',cursive; font-size:1rem; color:var(--purple3); letter-spacing:1px; margin-bottom:10px; }
.admin-player-item { display:flex; align-items:center; justify-content:space-between; padding:8px; background:var(--surface2); border-radius:8px; margin-bottom:6px; }
.admin-remove-btn { background:rgba(255,23,68,0.1); border:1px solid rgba(255,23,68,0.3); color:#ff8a80; padding:4px 10px; border-radius:6px; font-size:0.75rem; cursor:pointer; font-family:monospace; }

/* ===== MODAL PERFIL ===== */
.modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:1000; align-items:center; justify-content:center; padding:16px; }
.modal-overlay.open { display:flex; }
.modal-box { background:var(--surface); border:1px solid var(--border2); border-radius:var(--r); width:100%; max-width:500px; max-height:85vh; overflow-y:auto; padding:20px; box-shadow:0 20px 60px rgba(0,0,0,0.6); }
.modal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; }
.modal-title { font-family:'Lilita One',cursive; font-size:1.4rem; letter-spacing:2px; color:var(--purple3); }
.modal-close { background:none; border:1px solid var(--border); color:var(--text); border-radius:8px; padding:4px 10px; cursor:pointer; font-size:1rem; }
.modal-player-info { display:flex; align-items:center; gap:12px; margin-bottom:20px; padding:12px; background:var(--surface2); border-radius:10px; }
.modal-avatar { font-size:2rem; }
.modal-name { font-family:'Lilita One',cursive; font-size:1.3rem; color:var(--text); }
.modal-tag { font-family:'JetBrains Mono',monospace; font-size:0.7rem; color:var(--text-muted); }
.chart-container { background:var(--surface2); border-radius:10px; padding:16px; margin-bottom:16px; }
.chart-title { font-family:'Lilita One',cursive; font-size:1rem; letter-spacing:1px; color:var(--text-dim); margin-bottom:12px; }
.chart-canvas { width:100%; height:160px; position:relative; }
.chart-empty { text-align:center; padding:30px; color:var(--text-dim); font-size:0.8rem; font-weight:800; }
.stat-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stat-box { background:var(--surface2); border-radius:10px; padding:12px; text-align:center; }
.stat-val { font-family:'Lilita One',cursive; font-size:1.4rem; color:var(--gold); }
.stat-lbl { font-size:0.65rem; font-weight:900; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase; }

/* ===== PERFIL EDIT ===== */
.perfil-edit { margin-bottom:16px; background:var(--surface2); border-radius:10px; padding:14px; }
.perfil-edit-title { font-weight:900; font-size:0.95rem; letter-spacing:1px; color:var(--text-dim); margin-bottom:10px; }
.color-picker { display:flex; flex-wrap:wrap; gap:8px; margin-bottom:12px; }
.color-opt { width:28px; height:28px; border-radius:50%; cursor:pointer; border:2px solid transparent; transition:transform 0.1s; }
.color-opt.selected, .color-opt:hover { transform:scale(1.2); border-color:#fff; }
.emoji-picker { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px; }
.emoji-opt { font-size:1.4rem; cursor:pointer; padding:4px; border-radius:6px; border:2px solid transparent; transition:transform 0.1s; }
.emoji-opt.selected, .emoji-opt:hover { transform:scale(1.2); background:var(--surface); border-color:var(--purple2); }
.save-perfil-btn { background:linear-gradient(135deg,var(--purple),var(--neon)); color:#fff; border:none; padding:8px 20px; border-radius:8px; font-weight:900; font-size:1rem; letter-spacing:1px; cursor:pointer; width:100%; }

@media(max-width:480px) {
  .form-grid { grid-template-columns:1fr; }
  .form-grid .full { grid-column:1; }
  .tab-btn { font-size:0.72rem; padding:7px 11px; }
}
</style>
</head>
<body>
<div id="avisoGeral" style="display:none;background:#e67e22;color:#fff;padding:10px 16px;text-align:center;font-family:Teko,sans-serif;letter-spacing:1px;position:relative;z-index:100;">
  <div id="avisoTitulo" style="font-size:1rem;"></div>
  <div id="avisoTexto" style="font-size:0.8rem;font-family:monospace;"></div>
  <button id="btnFecharAviso" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:none;border:none;color:#fff;cursor:pointer;font-size:1rem;">‚úï</button>
</div>
<header>
  <div class="logo">BrawlCity</div>
  <div class="logo-sub">Ranking Competitivo ‚Ä¢ Pernambuco</div>
  <div class="live-badge"><span class="live-dot"></span> AO VIVO</div>
  <button id="musicBtn" onclick="toggleMusic()" style="margin-top:12px;background:rgba(138,43,226,0.1);border:1px solid rgba(138,43,226,0.3);color:var(--purple3);padding:6px 16px;border-radius:30px;font-family:'Nunito',sans-serif;font-size:0.8rem;font-weight:900;cursor:pointer;letter-spacing:1px;">üîá M√öSICA</button>
</header>
<div class="tab-bar">
  <button class="tab-btn active" onclick="switchTab('cidade',this)">üèô Cidade</button>
  <button class="tab-btn pe-tab" onclick="switchTab('pe',this)">üèÜ PE</button>
  <button class="tab-btn map-tab" onclick="switchTab('mapas',this)">üó∫Ô∏è Mapas</button>
  <button class="tab-btn notif-tab" id="btnNotif" onclick="switchTab('notif',this)">üîî<span id="notifBadge" style="display:none" class="notif-badge">0</span></button>
  <button class="tab-btn" style="color:#a78bfa;" onclick="switchTab('semana',this)">üìÖ Semana</button>
  <button class="tab-btn" id="tabBtnPerfil" style="color:#00ff88;display:none;" onclick="switchTab('perfil',this)">üë§ Perfil</button>
</div>
<div class="city-bar" id="cityBar"></div>
<main>
  <div class="tab-content active" id="tab-cidade">
    <div class="info-bar">‚ö° <span>Autom√°tico:</span> Digite s√≥ sua TAG e o sistema busca seu nome e trof√©us direto do Brawl Stars!</div>
    <div class="register-card">
      <div class="section-label">Entrar no Ranking</div>
      <div class="form-grid">
        <div class="input-wrap full"><label>TAG do Brawl Stars</label><input type="text" id="inputTag" placeholder="#JQ2UUJLP" maxlength="15"><div class="hint">Encontre sua TAG no perfil do jogo</div></div>
        <div class="input-wrap full"><label>Cidade</label><select id="inputCity"></select></div>
        <div class="input-wrap full"><button class="btn-register" id="btnRegister" onclick="register()">ENTRAR NO RANKING</button></div>
      </div>
      <div class="toast" id="toast"></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">TOP <span class="city-pill" id="activeCityTag">AGRESTINA-PE</span></div>
      <div class="update-info" id="updateInfo">CONECTANDO...</div>
    </div>
    <div id="rankingList" class="ranking-list-container"></div>
    <button class="share-btn" id="btnCompartilhar">üì§ COMPARTILHAR RANKING</button>
    <canvas id="shareCanvas"></canvas>
  </div>
  <div class="tab-content" id="tab-pe">
    <div class="pe-banner">
      <div class="pe-flag">ü¶Å</div>
      <div><div class="pe-title">TOP PERNAMBUCO</div><div class="pe-desc">Os melhores jogadores de todo o estado</div></div>
    </div>
    <div class="ranking-header">
      <div class="ranking-title">RANKING <span class="pe-pill">PERNAMBUCO</span></div>
      <div class="update-info" id="updateInfoPE">AO VIVO</div>
    </div>
    <div id="rankingListPE" class="ranking-list-container"></div>
  </div>
  <div class="tab-content" id="tab-mapas">
    <div class="ranking-header">
      <div class="ranking-title" style="color:var(--green);font-size:1.1rem;">üó∫Ô∏è SHOWDOWN AO VIVO</div>
      <div class="update-info" id="updateInfoMapas">CARREGANDO...</div>
    </div>
    <div id="mapGrid"><div class="loading-state"><div class="empty-icon">üó∫Ô∏è</div><p>CARREGANDO MAPAS...</p></div></div>
  </div>
</main>
  <div class="tab-content" id="tab-perfil">
    <div style="padding:4px 0 16px;">
      <button onclick="fecharPerfilTab()" style="display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);color:var(--text-dim);padding:8px 14px;border-radius:6px;font-family:Teko,sans-serif;font-size:0.9rem;letter-spacing:1px;cursor:pointer;margin-bottom:12px;">‚Üê VOLTAR AO RANKING</button>
      <div id="perfilTabContent">
        <div class="perfil-loading">‚ö° SELECIONE UM JOGADOR NO RANKING PARA VER O PERFIL</div>
      </div>
    </div>
  </div>

  <div class="tab-content" id="tab-semana">
    <div style="padding:16px;">
      <div style="font-family:Teko,sans-serif;font-size:1.3rem;color:#a78bfa;letter-spacing:2px;margin-bottom:4px;">üìÖ RANKING SEMANAL</div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-size:0.7rem;color:var(--text-dim);font-family:JetBrains Mono,monospace;">QUEM MAIS GANHOU TROF√âUS ESSA SEMANA</div>
        <button id="btnAtualizarSemana" style="background:var(--surface2);border:1px solid var(--border);color:var(--accent);padding:6px 12px;border-radius:6px;font-family:Teko,sans-serif;font-size:0.85rem;cursor:pointer;">üîÑ ATUALIZAR</button>
      </div>
      <div id="mvpBanner"></div>
      <div id="rankingSemanaList"><div class="loading-state"><div class="empty-icon">‚è≥</div><p>CARREGANDO...</p></div></div>
    </div>
  </div>

  <div class="tab-content" id="tab-notif">
    <div style="padding:16px;">
      <div style="font-family:Teko,sans-serif;font-size:1.3rem;color:#f39c12;letter-spacing:2px;margin-bottom:16px;">üîî NOVIDADES</div>
      <div id="notifList"><div class="notif-empty">NENHUMA NOVIDADE AINDA</div></div>
    </div>
  </div>

<!-- CELEBRA√á√ÉO MVP -->
<div class="celebracao-overlay" id="celebracaoMVP">
  <div style="font-size:3rem;animation:float 1s ease-in-out infinite;">üëë</div>
  <div class="celebracao-titulo">PARAB√âNS!</div>
  <div class="celebracao-sub">üèÜ MVP DA SEMANA üèÜ</div>
  <img id="celebracaoFoto" class="celebracao-foto" src="" style="display:none">
  <div class="celebracao-nome" id="celebracaoNome"></div>
  <div class="celebracao-trofeus" id="celebracaoTrofeus"></div>
  <div style="color:#ffffff88;font-size:0.75rem;font-family:monospace;margin-top:8px;">pela conquista desta semana!</div>
  <button class="celebracao-fechar" onclick="fecharCelebracao()">‚úï FECHAR</button>
</div>

<!-- MODAL PERFIL -->
<div class="modal-overlay" id="modalPerfil" onclick="if(event.target===this)fecharModal()">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title" id="modalTitulo">PERFIL</div>
      <button class="modal-close" onclick="fecharModal()">‚úï</button>
    </div>
    <div class="modal-player-info">
      <div class="modal-avatar" id="modalAvatar">üéÆ</div>
      <div>
        <div class="modal-name" id="modalNome">-</div>
        <div class="modal-tag" id="modalTag">-</div>
        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;" id="modalCidade">-</div>
      </div>
    </div>
    <div class="stat-grid" style="margin-bottom:16px;">
      <div class="stat-box"><div class="stat-val" id="modalTrofeus">-</div><div class="stat-lbl">Trof√©us</div></div>
      <div class="stat-box"><div class="stat-val" id="modalHoras">-</div><div class="stat-lbl">Horas de jogo</div></div>
      <div class="stat-box"><div class="stat-val" id="modalPosicao">-</div><div class="stat-lbl">Posi√ß√£o PE</div></div>
      <div class="stat-box"><div class="stat-val" id="modalVariacao">-</div><div class="stat-lbl">Varia√ß√£o 24h</div></div>
    </div>
    <div class="chart-container">
      <div class="chart-title">üìà EVOLU√á√ÉO DE TROF√âUS</div>
      <div class="chart-canvas" id="chartArea"><div class="chart-empty">Coletando dados...<br>Volte amanh√£!</div></div>
    </div>


    <!-- IA BRAWL STARS -->
    <div class="ia-section" id="iaSection">
      <div class="ia-header">
        <div class="ia-title">ü§ñ ASSISTENTE IA</div>
        <div class="ia-status"><span class="ia-dot"></span>ONLINE</div>
      </div>
      <div class="ia-messages" id="iaMessages">
        <div class="ia-msg ia-msg-bot">
          <div class="ia-msg-avatar">ü§ñ</div>
          <div class="ia-msg-bubble">Oi! Seus dados j√° est√£o carregados. Me pergunte qualquer coisa sobre o jogo ou sobre seu perfil! üéÆ</div>
        </div>
      </div>
      <div class="ia-suggestions" id="iaSuggestions">
        <button class="ia-chip" onclick="iaEnviarSugestao(this)">Analise meu perfil</button>
        <button class="ia-chip" onclick="iaEnviarSugestao(this)">Como ganhar mais trof√©us?</button>
        <button class="ia-chip" onclick="iaEnviarSugestao(this)">Qual brawler usar no Showdown?</button>
        <button class="ia-chip" onclick="iaEnviarSugestao(this)">Dicas para subir no ranking</button>
      </div>
      <div class="ia-input-row">
        <input class="ia-input" id="iaInput" type="text" placeholder="Pergunte sobre Brawl Stars..." maxlength="400" onkeydown="if(event.key==='Enter')iaEnviar()">
        <button class="ia-send-btn" id="iaSendBtn" onclick="iaEnviar()">‚û§</button>
      </div>
    </div>

    <div class="perfil-edit" id="perfilEditor" style="display:none;">
      <div class="perfil-edit-title">üé® PERSONALIZAR PERFIL</div>
      <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">COR DO CARD</div>
      <div class="color-picker" id="colorPicker"></div>
      <div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">AVATAR</div>
      <div class="emoji-picker" id="emojiPicker"></div>
      <button class="save-perfil-btn" id="btnSalvarPerfil">üíæ SALVAR</button>
    </div>
    <div style="display:flex;gap:8px;margin-bottom:12px;">
      <button onclick="toggleEditPerfil()" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;font-family:Teko,sans-serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;">‚úèÔ∏è EDITAR PERFIL</button>
      <a id="modalBrawlify" href="#" target="_blank" style="flex:1;display:block;text-align:center;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-family:Teko,sans-serif;letter-spacing:2px;text-decoration:none;">‚Üó BRAWLIFY</a>
    </div>
  </div>
</div>

<audio id="bgMusic" src="song.mp3" loop preload="auto"></audio>


<!-- ADMIN -->
<div class="admin-overlay" id="adminOverlay">
  <div class="admin-box">
    <div class="admin-title">üîê ADMIN</div>
    <div id="adminLogin">
      <input class="admin-input" id="adminUser" type="text" placeholder="Usu√°rio">
      <input class="admin-input" id="adminPass" type="password" placeholder="Senha">
      <div id="adminErr" style="color:#e74c3c;font-size:0.75rem;margin-bottom:8px;display:none;">Usu√°rio ou senha incorretos!</div>
      <button class="admin-btn admin-btn-primary" id="btnAdminLogin">ENTRAR</button>
      <button class="admin-btn admin-btn-secondary" onclick="fecharAdmin()">CANCELAR</button>
    </div>
    <div id="adminPainel" style="display:none;">
      <div class="admin-section">
        <div class="admin-section-title">üóëÔ∏è REMOVER JOGADOR</div>
        <div id="adminPlayerList"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üèôÔ∏è ADICIONAR CIDADE</div>
        <input class="admin-input" id="adminNovaCidade" type="text" placeholder="Nome da cidade (ex: Caruaru-PE)">
        <button class="admin-btn admin-btn-primary" id="btnAdicionarCidade">ADICIONAR CIDADE</button>
        <div id="adminCidadeMsg" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üì¢ ENVIAR AVISO GERAL</div>
        <input class="admin-input" id="adminAvisoTitulo" type="text" placeholder="T√≠tulo do aviso (ex: Manuten√ß√£o)">
        <textarea class="admin-input" id="adminAvisoMsg" placeholder="Mensagem do aviso..." style="height:80px;resize:none;"></textarea>
        <button class="admin-btn admin-btn-primary" id="btnEnviarAviso">üì¢ ENVIAR AVISO</button>
        <button class="admin-btn" style="background:#e74c3c22;border:1px solid #e74c3c;color:#e74c3c;" id="btnApagarAviso">üóëÔ∏è APAGAR AVISO ATUAL</button>
        <div id="adminAvisoMsg2" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üèÜ RESETAR RANKING SEMANAL</div>
        <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;font-family:monospace;">Reseta os trof√©us base de todos os jogadores para iniciar uma nova semana.</div>
        <button class="admin-btn" style="background:#e67e2222;border:1px solid #e67e22;color:#e67e22;" id="btnResetSemana">‚ö†Ô∏è RESETAR SEMANA AGORA</button>
        <div id="adminResetMsg" style="font-size:0.75rem;margin-top:6px;"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üîí BLOQUEAR JOGADOR</div>
        <div id="adminBlockList"></div>
      </div>
      <div class="admin-section">
        <div class="admin-section-title">üìä VISITAS DO SITE</div>
        <div id="adminVisitas"><div style="color:var(--text-dim);font-size:0.8rem;">Carregando...</div></div>
      </div>
      <button class="admin-btn admin-btn-secondary" onclick="fecharAdmin()">FECHAR PAINEL</button>
    </div>
  </div>
</div>

<footer id="adminTrigger" style="cursor:default;">BRAWLCITY RANK ‚Ä¢ PERNAMBUCO ‚Ä¢ VERIFIQUE EM BRAWLIFY.COM</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAi05OMG44jmNm_HUEtv9LS_wa-tBvErd8",
  authDomain: "brawlcity-rank.firebaseapp.com",
  projectId: "brawlcity-rank",
  storageBucket: "brawlcity-rank.firebasestorage.app",
  messagingSenderId: "929168855194",
  appId: "1:929168855194:web:c41092248e5863f5dc0f23"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const CITIES = ['Agrestina-PE','Altinho-PE','Cupira-PE','Caruaru-PE','Petrolina-PE','Recife-PE','Garanhuns-PE','Vit√≥ria de Santo Ant√£o-PE'];
const EMOJIS = ['ü¶Å','üêØ','ü¶ä','üê∫','ü¶Ö','üêâ','ü¶à','üêª','ü¶ù','ü¶â','üî•','‚ö°','üíé'];
const COLORS = ['#FF6B00','#7B2FBE','#00BFFF','#FF3D5A','#00E676','#FFD000','#FF69B4'];

const MODOS = {
  'Solo Showdown': {nome:'Sobreviv√™ncia Solo',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'},
  'Duo Showdown': {nome:'Sobreviv√™ncia Dupla',cor:'#1ABC9C',bg:'rgba(26,188,156,0.15)'},
  'Showdown': {nome:'Sobreviv√™ncia',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'},
};

function getModo(name) {
  if (!name) return {nome:'Showdown',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'};
  const n = name.trim();
  if (MODOS[n]) return MODOS[n];
  const lower = n.toLowerCase();
  if (lower.includes('duo')) return MODOS['Duo Showdown'];
  if (lower.includes('trio')) return {nome:'Sobreviv√™ncia em Trio',cor:'#1ABC9C',bg:'rgba(26,188,156,0.15)'};
  return {nome:'Sobreviv√™ncia',cor:'#2ECC71',bg:'rgba(46,204,113,0.15)'};
}

function formatTempo(ms) {
  if (!ms || ms <= 0) return 'Encerrando...';
  const s = Math.floor(ms / 1000);
  const h = Math.floor(s / 3600);
  const m = Math.floor((s % 3600) / 60);
  return h > 0 ? h + 'h ' + m + 'm' : m + 'm';
}

let eventTimers = [];

function renderMapas(ativos, proximos) {
  const grid = document.getElementById('mapGrid');
  eventTimers.forEach(function(t){ clearInterval(t); });
  eventTimers = [];

  if (!ativos.length) {
    grid.innerHTML = '<div class="empty-state"><div class="empty-icon">üó∫Ô∏è</div><p>SEM SHOWDOWN ATIVO</p></div>';
    document.getElementById('updateInfoMapas').textContent = 'üü¢ ' + new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    return;
  }

  grid.innerHTML = '';

  for (var idx = 0; idx < ativos.length; idx++) {
    var ev = ativos[idx];
    var modeName = '';
    if (ev.gameMode && ev.gameMode.name) modeName = ev.gameMode.name;
    else if (ev.map && ev.map.gameMode && ev.map.gameMode.name) modeName = ev.map.gameMode.name;
    var modo = getModo(modeName);
    var mapName = (ev.map && ev.map.name) ? ev.map.name : 'Mapa';
    var mapImg = (ev.map && ev.map.imageUrl) ? ev.map.imageUrl : '';
    var endTime = 0;
    if (ev.endTime) {
      var rawEnd = String(ev.endTime);
      // Tenta parsear direto primeiro
      var et = new Date(rawEnd).getTime();
      // Se falhou, tenta converter formato "20260222T200000.000Z" -> "2026-02-22T20:00:00.000Z"
      if (!et || isNaN(et)) {
        var r = rawEnd.replace(/^(\d{4})(\d{2})(\d{2})T(\d{2})(\d{2})(\d{2})/, '$1-$2-$3T$4:$5:$6');
        et = new Date(r).getTime();
      }
      endTime = (!et || isNaN(et)) ? 0 : et;
    }
    var timerId = 'timer_' + idx;

    // Melhores e piores por winrate real - converte ID para nome
    var bmap = window._brawlerMap || {};
    var stats = (ev.map && ev.map.stats) ? ev.map.stats : [];
    var sorted = stats.filter(function(s){ return s.winRate > 0; }).sort(function(a,b){ return b.winRate - a.winRate; });
    var melhores = sorted.slice(0,5);
    var piores = sorted.slice(-5).reverse();

    // Converte ID para nome usando brawlerMap
    if (melhores.length && typeof melhores[0].brawler === 'number') {
      // IDs numericos - ja converte na exibicao
    }
    // Fallback: lista manual quando nao tiver stats reais
    var FALLBACK = {
      solo: {best:['Bull','Shelly','Frank','Brock','Piper'], worst:['Poco','Sprout','Gene','Sandy','Tara']},
      duo:  {best:['Poco','Gene','Max','Sandy','Rosa'],      worst:['Piper','Brock','Tick','Dynamike','Barley']},
      trio: {best:['Poco','Gene','Max','Sandy','Rosa'],      worst:['Piper','Brock','Tick','Dynamike','Barley']}
    };
    if (!melhores.length) {
      var modeKey = modeName.toUpperCase().includes('DUO') ? 'duo' : modeName.toUpperCase().includes('TRIO') ? 'trio' : 'solo';
      melhores = FALLBACK[modeKey].best.map(function(n){ return {brawler: n}; });
      piores   = FALLBACK[modeKey].worst.map(function(n){ return {brawler: n}; });
    }

    // Pr√≥ximo mapa - pega o do mesmo √≠ndice ou o primeiro dispon√≠vel
    var proximo = proximos[idx] || proximos[0] || null;
    var proximoNome = (proximo && proximo.map) ? proximo.map.name : '';
    var proximoImg = (proximo && proximo.map && proximo.map.imageUrl) ? proximo.map.imageUrl : '';
    var proximoModoNome = proximo && proximo.gameMode ? getModo(proximo.gameMode.name).nome : '';

    var melhorHTML = '';
    if (melhores.length) {
      for (var k = 0; k < melhores.length; k++) {
        var bid = melhores[k].brawler || melhores[k].id || '';
        var nome = bmap[bid] || bmap[parseInt(bid)] || (typeof bid === 'string' ? bid : '?');
        melhorHTML += '<span class="brawler-tag best">' + nome + '</span>';
      }
    } else {
      melhorHTML = '<span style="color:var(--text-muted);font-size:0.7rem;">Sem dados</span>';
    }

    var piorHTML = '';
    if (piores.length) {
      for (var k = 0; k < piores.length; k++) {
        var bid2 = piores[k].brawler || piores[k].id || '';
        var nome2 = bmap[bid2] || bmap[parseInt(bid2)] || (typeof bid2 === 'string' ? bid2 : '?');
        piorHTML += '<span class="brawler-tag worst">' + nome2 + '</span>';
      }
    } else {
      piorHTML = '<span style="color:var(--text-muted);font-size:0.7rem;">Sem dados</span>';
    }

    // Proximo mapa: da lista upcoming da Brawlify
    var outroShowdown = null;
    for (var oi = 0; oi < ativos.length; oi++) {
      if (oi !== idx) { outroShowdown = ativos[oi]; break; }
    }
    if (!outroShowdown) outroShowdown = proximos[0] || null;
    var proximoHTML = '';
    if (proximoNome) {
      proximoHTML = '<div class="next-preview">' +
        '<div class="next-preview-title">‚è≠ PR√ìXIMO MAPA DE SHOWDOWN</div>' +
        (proximoImg ? '<img class="next-preview-img" src="' + proximoImg + '" alt="' + proximoNome + '">' : '') +
        '<div class="next-preview-name">' + proximoNome + '</div>' +
        (proximoModoNome ? '<div class="next-preview-mode">' + proximoModoNome + '</div>' : '') +

        '</div>';
    } else if (outroShowdown && outroShowdown.map) {
      var onome = outroShowdown.map.name || '';
      var oimg = outroShowdown.map.imageUrl || '';
      var omodo = getModo((outroShowdown.gameMode && outroShowdown.gameMode.name) ? outroShowdown.gameMode.name : '').nome;
      proximoHTML = '<div class="next-preview">' +
        '<div class="next-preview-title">‚è≠ PR√ìXIMO MAPA DE SHOWDOWN</div>' +
        (oimg ? '<img class="next-preview-img" src="' + oimg + '" alt="' + onome + '">' : '') +
        '<div class="next-preview-name">' + onome + '</div>' +
        '<div class="next-preview-mode">' + omodo + '</div>' +
        '</div>';
    } else {
      proximoHTML = '<div class="next-preview"><div class="next-preview-title">‚è≠ PR√ìXIMO MAPA</div><div style="color:var(--text-muted);font-size:0.75rem;margin-top:6px;">A API n√£o divulga o pr√≥ximo mapa com anteced√™ncia</div></div>';
    }

    var card = document.createElement('div');
    card.className = 'map-card';
    card.style.animationDelay = (idx * 0.1) + 's';
    card.innerHTML =
      '<div class="map-card-top">' +
        (mapImg ? '<img src="' + mapImg + '" alt="' + mapName + '">' : '') +
        '<div class="map-mode-badge" style="background:' + modo.bg + ';color:' + modo.cor + ';border:1px solid ' + modo.cor + '40;">' + modo.nome + '</div>' +
        '<div class="map-timer" id="' + timerId + '">‚è± --</div>' +
      '</div>' +
      '<div class="map-card-body">' +
        '<div class="map-name">' + mapName + '</div>' +
        '<div class="brawler-section"><div class="brawler-section-title best">‚úÖ MELHORES</div><div class="brawler-tags">' + melhorHTML + '</div></div>' +
        '<div class="brawler-section" style="margin-top:8px;"><div class="brawler-section-title worst">‚ùå PIORES</div><div class="brawler-tags">' + piorHTML + '</div></div>' +
        '<div class="expand-hint">üëÜ Toque para ver pr√≥ximo mapa</div>' +
        '<div class="next-preview-wrap" style="display:none;">' + proximoHTML + '</div>' +
      '</div>';

    card.addEventListener('click', (function(c){
      return function() {
        var wrap = c.querySelector('.next-preview-wrap');
        var hint = c.querySelector('.expand-hint');
        if (wrap.style.display === 'none') { wrap.style.display = 'block'; hint.style.display = 'none'; }
        else { wrap.style.display = 'none'; hint.style.display = 'block'; }
      };
    })(card));

    grid.appendChild(card);

    (function(tid, et){
      var fn = function() {
        var el = document.getElementById(tid);
        if (el) el.textContent = '‚è± ' + formatTempo(et - Date.now());
      };
      fn();
      eventTimers.push(setInterval(fn, 30000));
    })(timerId, endTime);
  }

  document.getElementById('updateInfoMapas').textContent = 'üü¢ ' + new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
}

async function carregarMapas() {
  try {
    // API oficial via Netlify - formato: {active:[{slot,map:{id,name},mode:{id,name},startTime,endTime}]}
    var resOficial = await fetch('/.netlify/functions/player?type=events');
    if (!resOficial.ok) throw new Error('Erro API oficial');
    var dataOficial = await resOficial.json();
    var todos = dataOficial.active || [];

    // Brawlify brawlers para stats
    var resBrawlers = await fetch('https://api.brawlify.com/v1/brawlers');
    var dataBrawlers = resBrawlers.ok ? await resBrawlers.json() : {list:[]};
    var brawlerMap = {};
    (dataBrawlers.list || []).forEach(function(b){ brawlerMap[b.id] = b.name; });
    window._brawlerMap = brawlerMap;

    // Brawlify events para stats dos mapas
    var resBrawlify = await fetch('https://api.brawlify.com/v1/events');
    var dataBrawlify = resBrawlify.ok ? await resBrawlify.json() : {active:[]};
    var brawlifyAtivos = dataBrawlify.active || [];

    // Filtra s√≥ SOLO SHOWDOWN - API retorna como "soloShowdown"
    var showdowns = todos.filter(function(ev) {
      var m = ev.event && ev.event.mode ? ev.event.mode : 
              (ev.mode && ev.mode.name ? ev.mode.name : 
              (ev.mode ? String(ev.mode) : ''));
      return m === 'soloShowdown' || m.toUpperCase() === 'SOLO SHOWDOWN' || m.toUpperCase() === 'SOLO_SHOWDOWN';
    });

    // Busca stats dos mapas de showdown via Brawlify
    var statsCache = {};
    for (var si = 0; si < showdowns.length; si++) {
      var evStat = showdowns[si];
      var mapIdStat = evStat.event ? evStat.event.id : (evStat.map && evStat.map.id ? evStat.map.id : 0);
      var mapNameStat = evStat.event ? evStat.event.map : (evStat.map && evStat.map.name ? evStat.map.name : '');
      if (mapIdStat) {
        try {
          var resMapStats = await fetch('https://api.brawlify.com/v1/maps/' + mapIdStat);
          if (resMapStats.ok) {
            var mapData = await resMapStats.json();
            statsCache[mapIdStat] = mapData.stats || [];
          }
        } catch(e) {}
      }
      // Fallback: busca nos ativos da Brawlify pelo nome
      if (!statsCache[mapIdStat] || !statsCache[mapIdStat].length) {
        for (var j = 0; j < brawlifyAtivos.length; j++) {
          var bev = brawlifyAtivos[j];
          var bname = bev.map && bev.map.name ? bev.map.name : '';
          if (bname.toLowerCase() === mapNameStat.toLowerCase() && bev.map && bev.map.stats) {
            statsCache[mapIdStat] = bev.map.stats;
            break;
          }
        }
      }
    }

    // Monta cards - suporta formato {event:{id,mode,map}} e {map:{id,name},mode:{name}}
    var resultado = showdowns.map(function(ev) {
      var mapId = ev.event ? ev.event.id : (ev.map && ev.map.id ? ev.map.id : 0);
      var mapName = ev.event ? ev.event.map : (ev.map && ev.map.name ? ev.map.name : '');
      var modeName = ev.event ? ev.event.mode : (ev.mode && ev.mode.name ? ev.mode.name : 'Showdown');
      var imgUrl = mapId ? 'https://cdn.brawlify.com/maps/regular/' + mapId + '.png' : '';
      var endTime = ev.endTime || '';
      var stats = statsCache[mapId] || [];
      return {
        gameMode: {name: modeName},
        map: {name: mapName, imageUrl: imgUrl, stats: stats},
        endTime: endTime
      };
    });

    // Proximo mapa: usa previsao do backend baseada no historico de rotacao
    var proximos = [];
    var nextPredicted = dataOficial.nextSoloShowdown || null;
    var rotationSize = dataOficial.rotationSize || 0;
    if (nextPredicted && nextPredicted.mapId) {
      proximos = [{
        gameMode: {name: 'SOLO SHOWDOWN'},
        map: {
          name: nextPredicted.mapName || '',
          imageUrl: 'https://cdn.brawlify.com/maps/regular/' + nextPredicted.mapId + '.png'
        }
      }];
    } else {
      // Fallback: eventos futuros da API
      proximos = todos.filter(function(ev) {
        var m = ev.mode && ev.mode.name ? ev.mode.name.toUpperCase() : '';
        var start = ev.startTime ? new Date(ev.startTime).getTime() : 0;
        return m === 'SOLO SHOWDOWN' && start > Date.now();
      }).map(function(ev) {
        var mid = ev.map && ev.map.id ? ev.map.id : 0;
        return {
          gameMode: {name: 'SOLO SHOWDOWN'},
          map: {name: ev.map ? ev.map.name : '', imageUrl: mid ? 'https://cdn.brawlify.com/maps/regular/' + mid + '.png' : ''},
          startTime: ev.startTime
        };
      });
    }

    renderMapas(resultado, proximos);
  } catch(e) {
    document.getElementById('mapGrid').innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div><p>ERRO: ' + e.message + '</p></div>';
    document.getElementById('updateInfoMapas').textContent = 'üî¥ ERRO';
    console.error('carregarMapas erro:', e);
  }
}

window.carregarMapas = carregarMapas;

// Ranking Firebase
var activeCity = 'Agrestina-PE';
var allPlayers = [];
var cityBar = document.getElementById('cityBar');
var citySelect = document.getElementById('inputCity');
CITIES.forEach(function(c) {
  var btn = document.createElement('button');
  btn.className = 'city-btn' + (c === activeCity ? ' active' : '');
  btn.textContent = c;
  btn.dataset.city = c;
  btn.onclick = function(){ setCity(c); };
  cityBar.appendChild(btn);
  var opt = document.createElement('option');
  opt.value = c; opt.textContent = c;
  citySelect.appendChild(opt);
});

function setCity(city) {
  activeCity = city;
  document.querySelectorAll('.city-btn').forEach(function(b){ b.classList.toggle('active', b.dataset.city === city); });
  document.getElementById('activeCityTag').textContent = city.toUpperCase();
  renderRanking();
}

var q = query(collection(db, 'players'), orderBy('trophies', 'desc'));
onSnapshot(q, function(snapshot) {
  allPlayers = [];
  snapshot.forEach(function(d){ allPlayers.push(Object.assign({id: d.id}, d.data())); });
  renderRanking(); renderRankingPE(); renderRankingSemana();
  var t = new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  document.getElementById('updateInfo').textContent = 'üü¢ ' + t;
  document.getElementById('updateInfoPE').textContent = 'üü¢ ' + t;
}, function() {
  document.getElementById('updateInfo').textContent = 'üî¥ OFFLINE';
  document.getElementById('updateInfoPE').textContent = 'üî¥ OFFLINE';
});

async function buscarJogador(tag) {
  var cleanTag = tag.startsWith('#') ? tag : '#' + tag;
  var res = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent(cleanTag));
  if (!res.ok) { var err = await res.json(); throw new Error(err.error || 'Erro ao buscar jogador'); }
  return await res.json();
}

async function atualizarDados() {
  // Verifica se √© domingo e reseta semanaBase para todos
  var agora = new Date();
  var isDomingo = agora.getDay() === 0;
  var horaAtual = agora.getHours();

  for (var i = 0; i < allPlayers.length; i++) {
    var player = allPlayers[i];
    try {
      var data = await buscarJogador(player.tag);
      var updates = {};
      if (data.trophies && data.trophies !== player.trophies) updates.trophies = data.trophies;
      if (data.horas && data.horas !== player.horas) updates.horas = data.horas;
      if (data.iconId && data.iconId !== player.iconId) updates.iconId = data.iconId;
      // Salva imagem do brawler com mais trof√©us (para o fundo do card)
      if (data.brawlers && data.brawlers.length > 0) {
        var topB = data.brawlers.slice().sort(function(a,b){ return (b.trophies||0)-(a.trophies||0); })[0];
        if (topB && topB.imageUrl && topB.imageUrl !== player.topBrawlerImg) {
          updates.topBrawlerImg = topB.imageUrl;
        }
      }
      
      // Reset semanal: todo domingo entre meia-noite e 1h da manh√£
      if (isDomingo && horaAtual === 0 && player.semanaBase) {
        updates.semanaBase = data.trophies;
        updates.semanaInicio = Date.now();
      }
      if (data.brawlerCount && player.brawlerCount && data.brawlerCount > player.brawlerCount) {
        var diff = data.brawlerCount - player.brawlerCount;
        updates.newBrawlers = diff;
        updates.brawlerCount = data.brawlerCount;
        // Salva notifica√ß√£o no Firebase
        var notif = {playerName: player.name, count: diff, timestamp: Date.now()};
        addDoc(collection(db, 'notifications'), notif).catch(function(){});
      } else if (data.brawlerCount && !player.brawlerCount) {
        updates.brawlerCount = data.brawlerCount;
      }
      if (Object.keys(updates).length > 0) await updateDoc(doc(db, 'players', player.id), updates);
      // Salva hist√≥rico de trof√©us
      if (data.trophies) {
        var histRef = collection(db, 'players', player.id, 'history');
        addDoc(histRef, {trophies: data.trophies, timestamp: Date.now()}).catch(function(){});
      }
      // Salva semanaBase apenas se o jogador ainda n√£o tem
      // Nunca sobrescreve durante a semana para manter o ganho correto
      if (!player.semanaBase) {
        updates.semanaBase = data.trophies;
        updates.semanaInicio = Date.now();
      }
    } catch(e) {}
  }
}
setTimeout(atualizarDados, 5000);

// Registrar visita
(function() {
  var ua = navigator.userAgent;
  
  // Sistema operacional e vers√£o
  var so = 'Outro';
  var androidMatch = ua.match(/Android ([\d.]+)/);
  var iosMatch = ua.match(/OS ([\d_]+) like Mac/);
  if (androidMatch) so = 'ü§ñ Android ' + androidMatch[1];
  else if (iosMatch) so = 'üçé iOS ' + iosMatch[1].replace(/_/g,'.');
  else if (/Windows NT 10/i.test(ua)) so = 'üíª Windows 10/11';
  else if (/Windows/i.test(ua)) so = 'üíª Windows';
  else if (/Mac OS X/i.test(ua) && !/iPhone|iPad/i.test(ua)) so = 'üñ•Ô∏è macOS';

  // Marca do aparelho
  var marca = '';
  if (/Samsung/i.test(ua)) marca = 'Samsung';
  else if (/Xiaomi|MI |Redmi|POCO/i.test(ua)) {
    var pocMatch = ua.match(/POCO ([A-Z0-9 ]+)/i);
    var redmiMatch = ua.match(/Redmi ([A-Z0-9 ]+)/i);
    if (pocMatch) marca = 'POCO ' + pocMatch[1].trim();
    else if (redmiMatch) marca = 'Redmi ' + redmiMatch[1].trim();
    else marca = 'Xiaomi';
  }
  else if (/Motorola|moto/i.test(ua)) marca = 'Motorola';
  else if (/LG/i.test(ua)) marca = 'LG';
  else if (/Huawei/i.test(ua)) marca = 'Huawei';
  else if (/iPhone/i.test(ua)) marca = 'iPhone';
  else if (/iPad/i.test(ua)) marca = 'iPad';

  // Navegador
  var browser = '';
  if (/SamsungBrowser/i.test(ua)) browser = 'Samsung Browser';
  else if (/OPR|Opera/i.test(ua)) browser = 'Opera';
  else if (/Edg/i.test(ua)) browser = 'Edge';
  else if (/Chrome/i.test(ua)) browser = 'Chrome';
  else if (/Firefox/i.test(ua)) browser = 'Firefox';
  else if (/Safari/i.test(ua)) browser = 'Safari';

  var dispositivo = [marca, so, browser].filter(Boolean).join(' ‚Ä¢ ');
  addDoc(collection(db, 'visitas'), {
    timestamp: Date.now(),
    dispositivo: dispositivo,
    data: new Date().toLocaleDateString('pt-BR')
  }).catch(function(){});
})();
setInterval(atualizarDados, 30 * 60 * 1000);

// Listener de notifica√ß√µes - mostra novos brawlers
var qNotif = query(collection(db, 'notifications'), orderBy('timestamp', 'desc'));
onSnapshot(qNotif, function(snap) {
  var agora = Date.now();
  var validas = [];
  snap.forEach(function(d) {
    var n = Object.assign({id: d.id}, d.data());
    // S√≥ mostra notifica√ß√µes das √∫ltimas 24h
    if (agora - n.timestamp < 24 * 60 * 60 * 1000) validas.push(n);
    // Deleta notifica√ß√µes com mais de 24h
    else deleteDoc(doc(db, 'notifications', n.id)).catch(function(){});
  });

  var badge = document.getElementById('notifBadge');
  var list = document.getElementById('notifList');
  if (!badge || !list) return;

  if (validas.length > 0) {
    badge.style.display = 'inline-block';
    badge.textContent = validas.length;
    list.innerHTML = validas.map(function(n) {
      var tempo = agora - n.timestamp;
      var tempoStr = tempo < 60000 ? 'agora mesmo' :
                     tempo < 3600000 ? Math.floor(tempo/60000) + ' min atr√°s' :
                     Math.floor(tempo/3600000) + 'h atr√°s';
      return '<div class="notif-item">' +
        '<div class="notif-icon">üÜï</div>' +
        '<div class="notif-text">' +
        '<div class="notif-name">' + n.playerName + '</div>' +
        '<div class="notif-desc">desbloqueou +' + n.count + ' novo' + (n.count > 1 ? 's' : '') + ' brawler' + (n.count > 1 ? 's' : '') + '! üéâ</div>' +
        '<div class="notif-time">' + tempoStr + '</div>' +
        '</div></div>';
    }).join('');
  } else {
    badge.style.display = 'none';
    list.innerHTML = '<div class="notif-empty">NENHUMA NOVIDADE AINDA</div>';
  }
});

window.register = async function() {
  var btn = document.getElementById('btnRegister');
  var tag = document.getElementById('inputTag').value.trim().toUpperCase();
  var city = document.getElementById('inputCity').value;
  if (!tag) return showToast('Digite sua TAG!', 'error');
  if (!tag.startsWith('#')) tag = '#' + tag;
  if (allPlayers.find(function(p){ return p.tag.toUpperCase() === tag; })) return showToast('TAG j√° cadastrada!', 'error');
  btn.disabled = true; btn.textContent = 'BUSCANDO...';
  showToast('üîç Buscando dados no Brawl Stars...', 'info');
  try {
    var data = await buscarJogador(tag);
    if (!data.trophies || !data.name) throw new Error('Jogador n√£o encontrado');
    var emoji = EMOJIS[Math.floor(Math.random()*EMOJIS.length)];
    var color = COLORS[Math.floor(Math.random()*COLORS.length)];
    var iconId = data.iconId || null;
    await addDoc(collection(db, 'players'), {name: data.name, tag: data.tag, city: city, trophies: data.trophies, horas: data.horas || 0, emoji: emoji, color: color, joined: Date.now(), brawlerCount: data.brawlerCount || 0, newBrawlers: 0, iconId: iconId});
    document.getElementById('inputTag').value = '';
    showToast('‚úì ' + data.name + ' entrou com ' + data.trophies.toLocaleString('pt-BR') + ' trof√©us!', 'success');
    setCity(city);
  } catch(e) {
    showToast('‚ùå ' + (e.message || 'Erro ao buscar jogador'), 'error');
  }
  btn.disabled = false; btn.textContent = 'ENTRAR NO RANKING';
};

function showToast(msg, type) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.className = 'toast ' + type;
  clearTimeout(t._t); t._t = setTimeout(function(){ t.className = 'toast'; }, 5000);
}

function buildCards(players, containerId) {
  var list = document.getElementById(containerId);
  if (!players.length) { list.innerHTML = '<div class="empty-state"><div class="empty-icon">üéÆ</div><p>NENHUM JOGADOR AINDA</p></div>'; return; }
  list.innerHTML = '';
  players.forEach(function(p, i) {
    var pos = i+1;
    var topClass = pos===1?'top1':pos===2?'top2':pos===3?'top3':'';
    var rankClass = pos===1?'r1':pos===2?'r2':pos===3?'r3':'rn';
    var rankLabel = pos===1?'ü•á':pos===2?'ü•à':pos===3?'ü•â':'#'+pos;
    var cleanTag = p.tag.replace('#','');
    var card = document.createElement('div');
    card.className = 'player-card ' + topClass;
    card.style.animationDelay = (i*0.05) + 's';
    card.onclick = (function(player, posicao) { return function() { abrirPerfilTab(player, posicao); }; })(p, pos);

    // Imagem do brawler favorito atr√°s
    var brawlerBgHtml = '';
    if (p.topBrawlerImg) {
      brawlerBgHtml = '<img class="card-brawler-bg" src="' + p.topBrawlerImg + '" onerror="this.style.display=\'none\'">';
    }

    card.innerHTML =
      (pos===1 ? '<div class="crown-icon">üëë</div><div class="shimmer"></div>' : '') +
      brawlerBgHtml +
      '<div class="card-overlay"></div>' +
      '<div class="card-content">' +
        '<div class="rank-num ' + rankClass + '">' + rankLabel + '</div>' +
        '<div class="player-avatar" style="border-color:' + (p.color||'rgba(138,43,226,0.4)') + '55;">' +
          (p.iconId ? '<img src="https://cdn.brawlify.com/profile-icons/regular/' + p.iconId + '.png" style="width:100%;height:100%;object-fit:cover;" onerror="this.textContent=\'' + (p.emoji||'üéÆ') + '\'" data-fb="' + (p.emoji||'üéÆ') + '">' : (p.emoji || 'üéÆ')) +
        '</div>' +
        '<div class="player-info">' +
          '<div class="player-name">' + p.name + '</div>' +
          '<div class="player-meta">' +
            '<span class="player-tag">' + p.tag + '</span>' +
            '<span class="player-city">üìç ' + p.city + '</span>' +
            '<a class="verify-link" href="https://brawlify.com/stats/profile/' + cleanTag + '" target="_blank" onclick="event.stopPropagation()">‚Üó BRAWLIFY</a>' +
          '</div>' +
        '</div>' +
        '<div class="player-score">' +
          '<div class="trophy-num">üèÜ ' + p.trophies.toLocaleString('pt-BR') + '</div>' +
          '<div class="trophy-label">TROF√âUS</div>' +
          '<div class="horas-num">‚è± ' + (p.horas||'?') + 'h</div>' +
          '<div class="horas-label">DE JOGO</div>' +
        '</div>' +
      '</div>';
    list.appendChild(card);
  });
}
function renderRanking() { buildCards(allPlayers.filter(function(p){ return p.city === activeCity; }).sort(function(a,b){ return b.trophies-a.trophies; }), 'rankingList'); }
function renderRankingPE() { buildCards(allPlayers.slice().sort(function(a,b){ return b.trophies-a.trophies; }), 'rankingListPE'); }

window.atualizarManual = async function() {
  var btn = document.getElementById('btnAtualizarSemana');
  if (btn) { btn.textContent = '‚è≥ ATUALIZANDO...'; btn.disabled = true; }
  await atualizarDados();
  // Espera 2s para o onSnapshot atualizar o allPlayers
  setTimeout(function() {
    renderRankingSemana();
    if (btn) { btn.textContent = 'üîÑ ATUALIZAR'; btn.disabled = false; }
  }, 2000);
};

function renderMVP(comGanho) {
  var banner = document.getElementById('mvpBanner');
  if (!banner) return;
  if (!comGanho.length || comGanho[0].ganhoSemana === 0) { banner.innerHTML = ''; return; }
  
  var mvp = comGanho[0];
  var cores = ['#f5a623','#ff6b6b','#a78bfa','#2ecc71','#00c8ff'];
  var fogos = '';
  for (var f = 0; f < 12; f++) {
    var tx = (Math.random() * 120 - 60).toFixed(0);
    var ty = (Math.random() * 80 - 80).toFixed(0);
    var cor = cores[Math.floor(Math.random() * cores.length)];
    var delay = (Math.random() * 1.5).toFixed(2);
    var size = (4 + Math.random() * 6).toFixed(0);
    fogos += '<div class="firework" style="background:'+cor+';width:'+size+'px;height:'+size+'px;left:'+(20+Math.random()*60).toFixed(0)+'%;top:'+(10+Math.random()*60).toFixed(0)+'%;--tx:'+tx+'px;--ty:'+ty+'px;animation-delay:'+delay+'s;animation-duration:'+(1+Math.random()*0.8).toFixed(2)+'s;"></div>';
  }

  banner.innerHTML = '<div class="mvp-banner">' + fogos +
    '<div class="mvp-crown">üëë</div>' +
    '<div class="mvp-title">‚≠ê MVP DA SEMANA ‚≠ê</div>' +
    '<div style="display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0;">' +
      (mvp.iconId ? '<img src="https://cdn.brawlify.com/profile-icons/regular/'+mvp.iconId+'.png" style="width:48px;height:48px;border-radius:50%;border:2px solid #f5a623;">' : '<div style="font-size:2rem;">'+mvp.emoji+'</div>') +
      '<div>' +
        '<div class="mvp-name">'+mvp.name+'</div>' +
        '<div style="font-size:0.7rem;color:#f5a62399;font-family:monospace;">üìç '+mvp.city+'</div>' +
      '</div>' +
    '</div>' +
    '<div class="mvp-gain">üèÜ +'+mvp.ganhoSemana.toLocaleString('pt-BR')+' trof√©us essa semana!</div>' +
    '</div>';
}

function renderRankingSemana() {
  var lista = document.getElementById('rankingSemanaList');
  if (!lista) return;
  
  // Calcula ganho da semana para cada jogador
  var comGanho = allPlayers.map(function(p) {
    var ganho = (p.semanaBase != null && p.trophies > p.semanaBase) ? p.trophies - p.semanaBase : 0;
    return Object.assign({}, p, {ganhoSemana: ganho});
  }).sort(function(a,b){ return b.ganhoSemana - a.ganhoSemana || b.trophies - a.trophies; });

  if (!comGanho.length) {
    lista.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-dim);font-family:Teko,sans-serif;font-size:1.1rem;letter-spacing:1px;">NENHUM JOGADOR AINDA</div>';
    return;
  }

  var medals = ['ü•á','ü•à','ü•â'];
  renderMVP(comGanho);
  verificarMVP(comGanho);
  lista.innerHTML = comGanho.map(function(p, i) {
    var medal = i < 3 ? medals[i] : '#'+(i+1);
    var cor = i===0?'#f5a623':i===1?'#aaa':i===2?'#cd7f32':'var(--text-dim)';
    return '<div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">' +
      '<div style="font-family:Teko,sans-serif;font-size:1.3rem;color:'+cor+';min-width:32px;">'+medal+'</div>' +
      '<div style="font-size:1.6rem;">'+p.emoji+'</div>' +
      '<div style="flex:1;">' +
        '<div style="font-family:Teko,sans-serif;font-size:1.1rem;color:var(--text);">'+p.name+'</div>' +
        '<div style="font-size:0.7rem;color:var(--text-muted);">üìç '+p.city+'</div>' +
      '</div>' +
      '<div style="text-align:right;">' +
        '<div style="font-family:Teko,sans-serif;font-size:1.2rem;color:' + (p.ganhoSemana > 0 ? '#2ecc71' : '#666') + ';">' + (p.ganhoSemana > 0 ? '+' : '') + p.ganhoSemana.toLocaleString('pt-BR') + '</div>' +
        '<div style="font-size:0.6rem;color:var(--text-dim);letter-spacing:1px;">TROF√âUS</div>' +
        '<div style="font-size:0.65rem;color:var(--text-dim);">üèÜ '+p.trophies.toLocaleString('pt-BR')+' total</div>' +
      '</div>' +
    '</div>';
  }).join('');
}

window.compartilharRanking = function(tipo) {
  var lista = tipo === 'cidade'
    ? allPlayers.filter(function(p){ return p.city === activeCity; }).sort(function(a,b){ return b.trophies-a.trophies; })
    : allPlayers.slice().sort(function(a,b){ return b.trophies-a.trophies; });
  var top = lista.slice(0,5);
  if (!top.length) { alert('Nenhum jogador no ranking ainda!'); return; }

  var canvas = document.getElementById('shareCanvas');
  var ctx = canvas.getContext('2d');
  var W = 600, H = 120 + top.length * 80 + 60;
  canvas.width = W; canvas.height = H;

  // Fundo
  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0, 0, W, H);

  // Header
  ctx.fillStyle = '#f5a623';
  ctx.font = 'bold 36px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('BrawlCity Rank', W/2, 50);
  ctx.fillStyle = '#00c8ff';
  ctx.font = '16px Arial';
  ctx.fillText(tipo === 'cidade' ? activeCity.toUpperCase() : 'PERNAMBUCO', W/2, 75);
  ctx.fillStyle = '#ffffff33';
  ctx.fillRect(40, 90, W-80, 1);

  // Jogadores
  var medalhas = ['ü•á','ü•à','ü•â','#4','#5'];
  top.forEach(function(p, i) {
    var y = 120 + i * 80;
    // Bg card
    ctx.fillStyle = i === 0 ? '#f5a62322' : '#ffffff08';
    ctx.beginPath();
    ctx.roundRect(20, y, W-40, 68, 8);
    ctx.fill();

    // Posi√ß√£o
    ctx.fillStyle = i === 0 ? '#f5a623' : '#ffffff88';
    ctx.font = 'bold 22px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(i < 3 ? ['1¬∞','2¬∞','3¬∞'][i] : '#'+(i+1), 36, y+42);

    // Emoji
    ctx.font = '28px Arial';
    ctx.fillText(p.emoji || 'üéÆ', 80, y+44);

    // Nome
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 18px Arial';
    ctx.fillText(p.name, 120, y+32);

    // Cidade
    ctx.fillStyle = '#ffffff66';
    ctx.font = '13px Arial';
    ctx.fillText('üìç ' + p.city, 120, y+52);

    // Trof√©us
    ctx.fillStyle = '#f5a623';
    ctx.font = 'bold 20px Arial';
    ctx.textAlign = 'right';
    ctx.fillText('üèÜ ' + p.trophies.toLocaleString('pt-BR'), W-36, y+42);
  });

  // Footer
  ctx.fillStyle = '#ffffff33';
  ctx.fillRect(40, H-50, W-80, 1);
  ctx.fillStyle = '#ffffff44';
  ctx.font = '13px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('brawlstarscity.netlify.app', W/2, H-20);

  // Compartilha via Web Share API (abre WhatsApp, Instagram, etc)
  canvas.toBlob(function(blob) {
    var file = new File([blob], 'brawlcity-ranking.png', {type: 'image/png'});
    if (navigator.share && navigator.canShare && navigator.canShare({files: [file]})) {
      navigator.share({
        title: 'BrawlCity Rank',
        text: 'Confira o ranking de Brawl Stars de Pernambuco!',
        files: [file]
      }).catch(function(){});
    } else {
      // Fallback: baixa a imagem
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'brawlcity-ranking.png';
      a.click();
      URL.revokeObjectURL(url);
    }
  }, 'image/png');
};

// Bind bot√µes
document.addEventListener('DOMContentLoaded', function() {
  var btn = document.getElementById('btnCompartilhar');
  if (btn) btn.addEventListener('click', function() { window.compartilharRanking('cidade'); });
  var btnS = document.getElementById('btnAtualizarSemana');
  if (btnS) btnS.addEventListener('click', function() { window.atualizarManual(); });
  var btnFecharAviso = document.getElementById('btnFecharAviso');
  if (btnFecharAviso) btnFecharAviso.addEventListener('click', async function() {
    document.getElementById('avisoGeral').style.display = 'none';
    try {
      var oldAvisos = await getDocs(collection(db, 'avisos'));
      for (var d of oldAvisos.docs) await deleteDoc(doc(db, 'avisos', d.id));
    } catch(e) {}
  });

  var footer = document.getElementById('adminTrigger');
  if (footer) footer.addEventListener('dblclick', function() { window.abrirAdmin(); });

  // Enviar aviso
  document.getElementById('btnEnviarAviso').addEventListener('click', async function() {
    var titulo = document.getElementById('adminAvisoTitulo').value.trim();
    var msg = document.getElementById('adminAvisoMsg').value.trim();
    var feedEl = document.getElementById('adminAvisoMsg2');
    if (!titulo || !msg) { feedEl.style.color='#e74c3c'; feedEl.textContent='Preencha t√≠tulo e mensagem!'; return; }
    try {
      // Apaga avisos antigos
      var oldAvisos = await getDocs(collection(db, 'avisos'));
      for (var d of oldAvisos.docs) await deleteDoc(doc(db, 'avisos', d.id));
      await addDoc(collection(db, 'avisos'), {titulo: titulo, mensagem: msg, timestamp: Date.now()});
      feedEl.style.color='#2ecc71'; feedEl.textContent='‚úÖ Aviso enviado para todos!';
      document.getElementById('adminAvisoTitulo').value='';
      document.getElementById('adminAvisoMsg').value='';
    } catch(e) { feedEl.style.color='#e74c3c'; feedEl.textContent='Erro ao enviar!'; }
  });

  // Resetar semana
  document.getElementById('btnResetSemana').addEventListener('click', async function() {
    var msgEl = document.getElementById('adminResetMsg');
    if (!confirm('Resetar o ranking semanal de TODOS os jogadores?')) return;
    try {
      this.textContent = '‚è≥ RESETANDO...'; this.disabled = true;
      for (var p of allPlayers) {
        var data = await buscarJogador(p.tag);
        if (data && data.trophies) {
          await updateDoc(doc(db, 'players', p.id), {semanaBase: data.trophies, semanaInicio: Date.now()});
        }
      }
      msgEl.style.color='#2ecc71'; msgEl.textContent='‚úÖ Semana resetada para todos!';
      this.textContent='‚ö†Ô∏è RESETAR SEMANA AGORA'; this.disabled=false;
    } catch(e) { msgEl.style.color='#e74c3c'; msgEl.textContent='Erro ao resetar!'; this.disabled=false; }
  });
});

window.fecharModal = function() { document.getElementById('modalPerfil').classList.remove('open'); }

var ADMIN_USER_HASH = '417dc1719a18d5120f962f4d120c23d51da607e12f31a0874130397b85a945d9';
var ADMIN_PASS_HASH = 'b24e602adf558c20edbd2d49e5ac6fa69c02f335219240472954b91b95032444';

async function sha256(str) {
  var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  return Array.from(new Uint8Array(buf)).map(function(b){ return b.toString(16).padStart(2,'0'); }).join('');
}

window.abrirAdmin = function() {
  document.getElementById('adminOverlay').classList.add('open');
  document.getElementById('adminLogin').style.display = 'block';
  document.getElementById('adminPainel').style.display = 'none';
  document.getElementById('adminErr').style.display = 'none';
  document.getElementById('adminUser').value = '';
  document.getElementById('adminPass').value = '';
};

window.fecharAdmin = function() {
  document.getElementById('adminOverlay').classList.remove('open');
};

document.addEventListener('DOMContentLoaded', function() {
  // Login admin
  document.getElementById('btnAdminLogin').addEventListener('click', async function() {
    var user = document.getElementById('adminUser').value;
    var pass = document.getElementById('adminPass').value;
    var hashU = await sha256(user);
    var hashP = await sha256(pass);
    if (hashU === ADMIN_USER_HASH && hashP === ADMIN_PASS_HASH) {
      document.getElementById('adminLogin').style.display = 'none';
      document.getElementById('adminPainel').style.display = 'block';
      carregarAdminPlayers();
      carregarVisitas();
    } else {
      document.getElementById('adminErr').style.display = 'block';
    }
  });

  // Adicionar cidade
  document.getElementById('btnAdicionarCidade').addEventListener('click', async function() {
    var novaCidade = document.getElementById('adminNovaCidade').value.trim();
    var msg = document.getElementById('adminCidadeMsg');
    if (!novaCidade) { msg.style.color='#e74c3c'; msg.textContent='Digite o nome da cidade!'; return; }
    try {
      await addDoc(collection(db, 'cidades'), {name: novaCidade, createdAt: Date.now()});
      msg.style.color='#2ecc71';
      msg.textContent='‚úÖ Cidade adicionada!';
      document.getElementById('adminNovaCidade').value = '';
      // Adicionar √† lista de cidades do select
      var sel = document.getElementById('citySelect');
      if (sel) {
        var opt = document.createElement('option');
        opt.value = novaCidade;
        opt.textContent = novaCidade;
        sel.appendChild(opt);
      }
    } catch(e) { msg.style.color='#e74c3c'; msg.textContent='Erro ao adicionar!'; }
  });
});

// Listener de avisos
var qAvisos = query(collection(db, 'avisos'), orderBy('timestamp', 'desc'));
onSnapshot(qAvisos, function(snap) {
  if (!snap.empty) {
    var aviso = snap.docs[0].data();
    var agora = Date.now();
    if (agora - aviso.timestamp < 24 * 60 * 60 * 1000) {
      document.getElementById('avisoTitulo').textContent = 'üì¢ ' + aviso.titulo;
      document.getElementById('avisoTexto').textContent = aviso.mensagem;
      document.getElementById('avisoGeral').style.display = 'block';
    }
  }
});

async function carregarVisitas() {
  var el = document.getElementById('adminVisitas');
  if (!el) return;
  try {
    var snap = await getDocs(collection(db, 'visitas'));
    var total = snap.size;
    var por_dispositivo = {};
    var por_dia = {};
    snap.forEach(function(d) {
      var v = d.data();
      por_dispositivo[v.dispositivo] = (por_dispositivo[v.dispositivo] || 0) + 1;
      por_dia[v.data] = (por_dia[v.data] || 0) + 1;
    });

    // √öltimos 7 dias
    var diasOrdenados = Object.keys(por_dia).sort(function(a,b){
      return new Date(a.split('/').reverse().join('-')) - new Date(b.split('/').reverse().join('-'));
    }).slice(-7);

    el.innerHTML = '<div style="font-family:Teko,sans-serif;font-size:1.8rem;color:#f5a623;margin-bottom:8px;">'+total+' <span style="font-size:0.9rem;color:var(--text-dim);">visitas totais</span></div>' +
      '<div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:6px;font-family:monospace;">POR DISPOSITIVO</div>' +
      Object.entries(por_dispositivo).sort(function(a,b){return b[1]-a[1];}).map(function(e){
        return '<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:4px;font-family:monospace;font-size:0.8rem;"><span>'+e[0]+'</span><span style="color:#f5a623;">'+e[1]+'</span></div>';
      }).join('') +
      '<div style="font-size:0.75rem;color:var(--text-dim);margin:8px 0 6px;font-family:monospace;">√öLTIMOS 7 DIAS</div>' +
      diasOrdenados.map(function(dia){
        return '<div style="display:flex;justify-content:space-between;padding:4px 8px;background:var(--surface);border-radius:4px;margin-bottom:4px;font-family:monospace;font-size:0.8rem;"><span>'+dia+'</span><span style="color:#2ecc71;">'+por_dia[dia]+'</span></div>';
      }).join('');
  } catch(e) { el.innerHTML = '<div style="color:#e74c3c;font-size:0.8rem;">Erro ao carregar visitas</div>'; }
}

function carregarAdminPlayers() {
  var lista = document.getElementById('adminPlayerList');
  lista.innerHTML = '';
  var sorted = allPlayers.slice().sort(function(a,b){ return a.name.localeCompare(b.name); });
  sorted.forEach(function(p) {
    var item = document.createElement('div');
    item.className = 'admin-player-item';
    item.innerHTML = '<div><span style="font-size:1rem;">'+(p.emoji||'üéÆ')+'</span> <span style="font-family:Teko,sans-serif;font-size:0.95rem;">'+p.name+'</span><br><span style="font-size:0.65rem;color:var(--text-dim);">'+p.city+' ‚Ä¢ üèÜ'+p.trophies.toLocaleString('pt-BR')+'</span></div>' +
      '<button class="admin-remove-btn" data-id="'+p.id+'" data-name="'+p.name+'">üóëÔ∏è REMOVER</button>';
    item.querySelector('.admin-remove-btn').addEventListener('click', async function() {
      var id = this.dataset.id;
      var name = this.dataset.name;
      if (!confirm('Remover ' + name + ' do ranking?')) return;
      try {
        await deleteDoc(doc(db, 'players', id));
        item.remove();
      } catch(e) { alert('Erro ao remover!'); }
    });
    lista.appendChild(item);
  });

  // Lista de bloqueio
  var blockList = document.getElementById('adminBlockList');
  if (blockList) {
    blockList.innerHTML = '';
    sorted.forEach(function(p) {
      var item2 = document.createElement('div');
      item2.className = 'admin-player-item';
      var bloqueado = p.bloqueado || false;
      item2.innerHTML = '<div><span style="font-family:Teko,sans-serif;font-size:0.95rem;">'+(bloqueado?'üîí ':'')+ p.name+'</span><br><span style="font-size:0.65rem;color:var(--text-dim);">'+p.city+'</span></div>' +
        '<button class="admin-remove-btn" style="'+(bloqueado?'background:#2ecc7122;border-color:#2ecc71;color:#2ecc71':'')+'">'+( bloqueado?'üîì DESBLOQUEAR':'üîí BLOQUEAR')+'</button>';
      item2.querySelector('button').addEventListener('click', async function() {
        var novo = !bloqueado;
        await updateDoc(doc(db, 'players', p.id), {bloqueado: novo});
        bloqueado = novo;
        this.textContent = novo ? 'üîì DESBLOQUEAR' : 'üîí BLOQUEAR';
        this.style.background = novo ? '#2ecc7122' : '';
        this.style.borderColor = novo ? '#2ecc71' : '#e74c3c';
        this.style.color = novo ? '#2ecc71' : '#e74c3c';
      });
      blockList.appendChild(item2);
    });
  }
}

window.fecharCelebracao = function() {
  document.getElementById('celebracaoMVP').classList.remove('ativa');
  // Para os fogos
  document.querySelectorAll('.fogo-celebracao').forEach(function(f){ f.remove(); });
};

function lancarFogosCelebracao() {
  var cores = ['#f5a623','#ff6b6b','#a78bfa','#2ecc71','#00c8ff','#fff','#ff69b4'];
  var container = document.getElementById('celebracaoMVP');
  for (var f = 0; f < 30; f++) {
    (function() {
      var fogo = document.createElement('div');
      fogo.className = 'fogo-celebracao';
      var tx = (Math.random() * 300 - 150).toFixed(0);
      var ty = (Math.random() * 400 - 300).toFixed(0);
      var cor = cores[Math.floor(Math.random() * cores.length)];
      var delay = (Math.random() * 2).toFixed(2);
      var dur = (0.8 + Math.random() * 1.2).toFixed(2);
      var size = (5 + Math.random() * 8).toFixed(0);
      fogo.style.cssText = 'background:'+cor+';width:'+size+'px;height:'+size+'px;left:'+(10+Math.random()*80).toFixed(0)+'%;top:'+(10+Math.random()*80).toFixed(0)+'%;--tx:'+tx+'px;--ty:'+ty+'px;animation:fogo-anim '+dur+'s '+delay+'s ease-out infinite;';
      document.body.appendChild(fogo);
    })();
  }
}

function verificarMVP(comGanho) {
  // S√≥ celebra s√°bado ap√≥s 17h
  var agora = new Date();
  var isSabado = agora.getDay() === 6;
  var isApos17h = agora.getHours() >= 17;
  if (!isSabado || !isApos17h) return;
  if (!comGanho.length || comGanho[0].ganhoSemana === 0) return;

  // Evita mostrar mais de uma vez por sess√£o
  if (sessionStorage.getItem('mvpCelebrado')) return;
  sessionStorage.setItem('mvpCelebrado', '1');

  var mvp = comGanho[0];
  document.getElementById('celebracaoNome').textContent = mvp.name;
  document.getElementById('celebracaoTrofeus').textContent = 'üèÜ +' + mvp.ganhoSemana.toLocaleString('pt-BR') + ' trof√©us essa semana!';
  
  var foto = document.getElementById('celebracaoFoto');
  if (mvp.iconId) {
    foto.src = 'https://cdn.brawlify.com/profile-icons/regular/' + mvp.iconId + '.png';
    foto.style.display = 'block';
  } else {
    foto.style.display = 'none';
  }

  document.getElementById('celebracaoMVP').classList.add('ativa');
  lancarFogosCelebracao();
}

var CORES_DISPONIVEIS = ["#e74c3c", "#e67e22", "#f1c40f", "#2ecc71", "#1abc9c", "#3498db", "#9b59b6", "#e91e63", "#00bcd4", "#ff5722", "#ffffff", "#00c8ff"];
var EMOJIS_DISPONIVEIS = ["üî•", "‚ö°", "üíÄ", "ü¶à", "üëæ", "üê∫", "ü§ñ", "üëë", "üíé", "üéØ", "ü¶Å", "üêâ", "üåô", "‚≠ê", "üéÆ", "üèÜ", "üí•", "üåä", "ü¶ä", "üêª", "üé≠", "ü¶ã"];
var _playerEditando = null;
var _corSelecionada = null;
var _emojiSelecionado = null;

window.toggleEditPerfil = function() {
  var editor = document.getElementById('perfilEditor');
  if (!editor) return;
  if (editor.style.display === 'none') {
    editor.style.display = 'block';
    // Monta paleta de cores
    var cp = document.getElementById('colorPicker');
    cp.innerHTML = CORES_DISPONIVEIS.map(function(c) {
      var sel = _playerEditando && c === _playerEditando.color ? ' selected' : '';
      return '<div class="color-opt'+sel+'" style="background:'+c+'" data-color="'+c+'" onclick="selecionarCor(this)"></div>';
    }).join('');
    // Monta paleta de emojis
    var ep = document.getElementById('emojiPicker');
    ep.innerHTML = EMOJIS_DISPONIVEIS.map(function(e) {
      var sel = _playerEditando && e === _playerEditando.emoji ? ' selected' : '';
      return '<span class="emoji-opt'+sel+'" data-emoji="'+e+'" onclick="selecionarEmoji(this)">'+e+'</span>';
    }).join('');
    _corSelecionada = _playerEditando ? _playerEditando.color : null;
    _emojiSelecionado = _playerEditando ? _playerEditando.emoji : null;
  } else {
    editor.style.display = 'none';
  }
};

window.selecionarCor = function(el) {
  document.querySelectorAll('.color-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  _corSelecionada = el.dataset.color;
};

window.selecionarEmoji = function(el) {
  document.querySelectorAll('.emoji-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected');
  _emojiSelecionado = el.dataset.emoji;
};

async function abrirPerfilTab(p, pos) {
  // Mostra a aba e o bot√£o
  var btn = document.getElementById('tabBtnPerfil');
  if (btn) { btn.style.display = ''; btn.textContent = 'üë§ ' + (p.name || 'Perfil').split(' ')[0].toUpperCase(); }

  // Muda para a aba perfil
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  document.getElementById('tab-perfil').classList.add('active');
  document.getElementById('cityBar').style.display = 'none';
  if (btn) btn.classList.add('active');

  var container = document.getElementById('perfilTabContent');
  container.innerHTML = '<div class="perfil-loading">‚è≥ CARREGANDO PERFIL...</div>';

  // Busca dados completos - tenta Netlify function primeiro, fallback Brawlify
  var apiData = null;
  var cleanTag = (p.tag || '').replace('#','');
  try {
    var res = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent('#' + cleanTag));
    if (res.ok) {
      var d = await res.json();
      // Verifica se veio dados √∫teis (brawlers, vit√≥rias)
      if (d && (d.brawlers || d.soloVictories || d.expLevel)) {
        apiData = d;
      }
    }
  } catch(e) {}

  // Busca Brawlify para imagens dos brawlers (sempre, pois tem imageUrl correto)
  try {
    var resBw = await fetch('https://api.brawlify.com/v1/players/' + encodeURIComponent('#' + cleanTag));
    if (resBw.ok) {
      var dBw = await resBw.json();
      if (dBw) {
        apiData = apiData || {};
        // Brawlify retorna brawlers com imageUrl correto - sempre usar
        if (dBw.brawlers && dBw.brawlers.length) {
          apiData.brawlers = (dBw.brawlers || []).map(function(b) {
            var brawlerInfo = b.brawler || {};
            return {
              id: brawlerInfo.id || b.id,
              name: brawlerInfo.name || b.name,
              imageUrl: brawlerInfo.imageUrl || brawlerInfo.iconUrl || '',
              power: b.power,
              rank: b.rank,
              trophies: b.trophies,
              highestTrophies: b.highestTrophies
            };
          });
        }
        // Preenche campos que vieram vazios da API oficial
        if (!apiData.trophies && dBw.trophies) apiData.trophies = dBw.trophies;
        if (!apiData.highestTrophies && dBw.highestTrophies) apiData.highestTrophies = dBw.highestTrophies;
        if (!apiData.expLevel && dBw.expLevel) apiData.expLevel = dBw.expLevel;
        if (!apiData.soloVictories && dBw.soloVictories) apiData.soloVictories = dBw.soloVictories;
        if (!apiData.duoVictories && dBw.duoVictories) apiData.duoVictories = dBw.duoVictories;
        if (!apiData['3vs3Victories'] && dBw['3vs3Victories']) apiData['3vs3Victories'] = dBw['3vs3Victories'];
        if (!apiData.club && dBw.club) apiData.club = dBw.club;
      }
    }
  } catch(e2) {}

  var trofeus = (apiData && apiData.trophies) || p.trophies || 0;
  var highTrofeus = (apiData && apiData.highestTrophies) || trofeus;
  var expLevel = (apiData && apiData.expLevel) ? apiData.expLevel : '?';
  var soloV = (apiData && apiData.soloVictories != null) ? apiData.soloVictories.toLocaleString('pt-BR') : '?';
  var duoV = (apiData && apiData.duoVictories != null) ? apiData.duoVictories.toLocaleString('pt-BR') : '?';
  var v3v3 = (apiData && apiData['3vs3Victories'] != null) ? apiData['3vs3Victories'].toLocaleString('pt-BR') : '?';
  var clube = (apiData && apiData.club && apiData.club.name) ? apiData.club.name : (p.club || 'Sem clube');
  var brawlers = (apiData && apiData.brawlers && apiData.brawlers.length) ? apiData.brawlers.slice().sort(function(a,b){ return (b.trophies||0)-(a.trophies||0); }) : [];

  // Avatar
  var avatarHtml = p.iconId
    ? ('<img src="https://cdn.brawlify.com/profile-icons/regular/' + p.iconId + '.png" style="width:100%;height:100%;object-fit:cover;">')
    : (p.emoji || 'üéÆ');

  // Top 6 brawlers - usa imageUrl se dispon√≠vel (Brawlify), sen√£o monta pelo ID
  var brawlerHtml = '';
  var top6 = brawlers.slice(0, 6);
  top6.forEach(function(b) {
    // Brawlify player API retorna imageUrl direto, API oficial retorna id num√©rico
    var imgUrl = b.imageUrl || b.iconUrl || '';
    if (!imgUrl && b.id) {
      // ID da API oficial do BS: 16000000+ -> Brawlify CDN aceita esses IDs
      imgUrl = 'https://cdn.brawlify.com/brawlers/regular/' + b.id + '.png';
    }
    brawlerHtml += '<div class="brawler-card">' +
      '<div class="brawler-card-power">P' + (b.power||'?') + '</div>' +
      (imgUrl ? '<img class="brawler-card-img" src="' + imgUrl + '" style="width:52px;height:52px;object-fit:contain;" onerror="this.style.opacity=0">' : '<div style="width:52px;height:52px;margin:0 auto 4px;background:var(--surface);border-radius:8px;"></div>') +
      '<div class="brawler-card-name">' + (b.name||'?') + '</div>' +
      '<div class="brawler-card-trofeus">üèÜ ' + (b.trophies||0).toLocaleString('pt-BR') + '</div>' +
    '</div>';
  });
  if (!brawlerHtml) brawlerHtml = '<div style="color:var(--text-muted);font-size:0.75rem;grid-column:1/-1;text-align:center;padding:12px;">Sem dados de brawlers</div>';

  // Power 11 count
  var pw11 = brawlers.filter(function(b){ return b.power >= 11; }).length;
  // 1000+ trofeus
  var mil = brawlers.filter(function(b){ return (b.trophies||0) >= 1000; }).length;

  container.innerHTML =
    // Hero
    '<div class="perfil-hero">' +
      '<div class="perfil-avatar-big">' + avatarHtml + '</div>' +
      '<div class="perfil-hero-info">' +
        '<div class="perfil-hero-name">' + (p.name||'?') + '</div>' +
        '<div class="perfil-hero-tag">' + (p.tag||'') + '</div>' +
        '<div class="perfil-hero-city">üìç ' + (p.city||'?') + ' ‚Ä¢ üè† ' + clube + '</div>' +
      '</div>' +
    '</div>' +

    // Stats principais
    '<div class="perfil-stats-row">' +
      '<div class="perfil-stat"><div class="perfil-stat-val">' + trofeus.toLocaleString('pt-BR') + '</div><div class="perfil-stat-lbl">Trof√©us</div></div>' +
      '<div class="perfil-stat"><div class="perfil-stat-val">' + highTrofeus.toLocaleString('pt-BR') + '</div><div class="perfil-stat-lbl">M√°ximo</div></div>' +
      '<div class="perfil-stat"><div class="perfil-stat-val">#' + pos + '</div><div class="perfil-stat-lbl">Rank PE</div></div>' +
      '<div class="perfil-stat"><div class="perfil-stat-val" style="color:var(--accent);">' + expLevel + '</div><div class="perfil-stat-lbl">N√≠vel EXP</div></div>' +
      '<div class="perfil-stat"><div class="perfil-stat-val" style="color:#a78bfa;">' + pw11 + '</div><div class="perfil-stat-lbl">Power 11</div></div>' +
      '<div class="perfil-stat"><div class="perfil-stat-val" style="color:var(--green);">' + mil + '</div><div class="perfil-stat-lbl">1000+ trof√©us</div></div>' +
    '</div>' +

    // Vit√≥rias
    '<div class="perfil-section-title">üèÜ VIT√ìRIAS</div>' +
    '<div class="perfil-victories">' +
      '<div class="victory-box"><div class="victory-val">' + soloV.toLocaleString('pt-BR') + '</div><div class="victory-lbl">Solo</div></div>' +
      '<div class="victory-box"><div class="victory-val">' + duoV.toLocaleString('pt-BR') + '</div><div class="victory-lbl">Duo</div></div>' +
      '<div class="victory-box"><div class="victory-val">' + v3v3.toLocaleString('pt-BR') + '</div><div class="victory-lbl">3v3</div></div>' +
    '</div>' +

    // Top Brawlers
    '<div class="perfil-section-title">‚≠ê TOP BRAWLERS</div>' +
    '<div class="brawler-grid">' + brawlerHtml + '</div>' +

    // Gr√°fico de trof√©us (reutilizado do modal)
    '<div class="perfil-section-title">üìà EVOLU√á√ÉO DE TROF√âUS</div>' +
    '<div class="chart-container" style="margin-bottom:16px;"><div id="perfilChartArea"><div class="chart-empty">Carregando...</div></div></div>' +

    // IA
    '<div class="ia-section">' +
      '<div class="ia-header"><div class="ia-title">ü§ñ ASSISTENTE IA</div><div class="ia-status"><span class="ia-dot"></span>ONLINE</div></div>' +
      '<div class="ia-messages" id="iaMessages"><div class="ia-msg ia-msg-bot"><div class="ia-msg-avatar">ü§ñ</div><div class="ia-msg-bubble">Oi, <strong>' + (p.name||'jogador') + '</strong>! Careguei seus dados completos. Me pergunta qualquer coisa! üéÆ</div></div></div>' +
      '<div class="ia-suggestions" id="iaSuggestions"><button class="ia-chip" onclick="iaEnviarSugestao(this)">Analise meu perfil</button><button class="ia-chip" onclick="iaEnviarSugestao(this)">Qual brawler focar?</button><button class="ia-chip" onclick="iaEnviarSugestao(this)">Dicas para subir no ranking</button></div>' +
      '<div class="ia-input-row"><input class="ia-input" id="iaInput" type="text" placeholder="Pergunte sobre Brawl Stars..." maxlength="400" onkeydown="if(event.key==String.fromCharCode(13))iaEnviar()"><button class="ia-send-btn" id="iaSendBtn" onclick="iaEnviar()">&#x27A4;</button></div>' +
    '</div>' +

    // Personalizar + Brawlify
    '<div id="perfilEditorTab" style="display:none;">' +
      '<div class="perfil-edit"><div class="perfil-edit-title">üé® PERSONALIZAR PERFIL</div>' +
      '<div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">COR DO CARD</div>' +
      '<div class="color-picker" id="colorPickerTab"></div>' +
      '<div style="font-size:0.7rem;color:var(--text-dim);margin-bottom:8px;font-family:monospace;">AVATAR</div>' +
      '<div class="emoji-picker" id="emojiPickerTab"></div>' +
      '<button class="save-perfil-btn" id="btnSalvarPerfilTab">üíæ SALVAR</button>' +
      '</div>' +
    '</div>' +
    '<div style="display:flex;gap:8px;margin-bottom:20px;">' +
      '<button onclick="toggleEditPerfilTab()" style="flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:8px;font-family:Teko,sans-serif;font-size:0.95rem;letter-spacing:1px;cursor:pointer;">‚úèÔ∏è EDITAR PERFIL</button>' +
      '<a href="https://brawlify.com/stats/profile/' + (p.tag||'').replace('#','') + '" target="_blank" style="flex:1;display:block;text-align:center;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent);font-family:Teko,sans-serif;letter-spacing:2px;text-decoration:none;">‚Üó BRAWLIFY</a>' +
    '</div>';

  // Inicializa IA com dados do jogador
  window._iaJogador = p;
  window._iaHistorico = [];
  _playerEditando = p;

  // Carrega gr√°fico de trof√©us
  try {
    var { collection: col2, query: q2, orderBy: ob2, limit: lim2, getDocs: gd2 } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var hRef2 = col2(db, 'players', p.id, 'history');
    var hQuery2 = q2(hRef2, ob2('timestamp', 'desc'), lim2(14));
    var snap2 = await gd2(hQuery2);
    var pontos2 = [];
    snap2.forEach(function(d) { pontos2.push(d.data()); });
    pontos2.reverse();
    var chartArea2 = document.getElementById('perfilChartArea');
    if (pontos2.length < 2) {
      chartArea2.innerHTML = '<div class="chart-empty">Coletando dados... Volte amanh√£!</div>';
    } else {
      var min2 = Math.min.apply(null, pontos2.map(function(x){return x.trophies;}));
      var max2 = Math.max.apply(null, pontos2.map(function(x){return x.trophies;}));
      var range2 = max2 - min2 || 1;
      var pts2 = pontos2.map(function(x, i) {
        var px = (i / (pontos2.length-1)) * 100;
        var py = 100 - ((x.trophies - min2) / range2) * 80 - 10;
        return px + ',' + py;
      });
      var poly2 = pts2.join(' ');
      var last2 = pts2[pts2.length-1].split(',');
      chartArea2.innerHTML = '<svg viewBox="0 0 100 100" style="width:100%;height:150px;" preserveAspectRatio="none">' +
        '<defs><linearGradient id="g2" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00c8ff" stop-opacity="0.3"/><stop offset="100%" stop-color="#00c8ff" stop-opacity="0"/></linearGradient></defs>' +
        '<polygon points="0,100 ' + poly2 + ' 100,100" fill="url(#g2)"/>' +
        '<polyline points="' + poly2 + '" fill="none" stroke="#00c8ff" stroke-width="2"/>' +
        '<circle cx="' + last2[0] + '" cy="' + last2[1] + '" r="3" fill="#00c8ff"/>' +
        '</svg>' +
        '<div style="display:flex;justify-content:space-between;font-family:JetBrains Mono,monospace;font-size:0.6rem;color:var(--text-dim);margin-top:4px;">' +
        '<span>' + pontos2[0].trophies.toLocaleString('pt-BR') + '</span>' +
        '<span style="color:#00c8ff">' + pontos2[pontos2.length-1].trophies.toLocaleString('pt-BR') + '</span></div>';
    }
  } catch(e2) {
    var ca2 = document.getElementById('perfilChartArea');
    if (ca2) ca2.innerHTML = '<div class="chart-empty">Erro ao carregar hist√≥rico</div>';
  }

  // Bot√£o salvar perfil na aba
  var cp2 = document.getElementById('colorPickerTab');
  var ep2 = document.getElementById('emojiPickerTab');
  if (cp2) cp2.innerHTML = CORES_DISPONIVEIS.map(function(c){ var sel = p.color === c ? ' selected':''; return '<div class="color-opt'+sel+'" style="background:'+c+'" data-color="'+c+'" onclick="selecionarCorTab(this)"></div>'; }).join('');
  if (ep2) ep2.innerHTML = EMOJIS_DISPONIVEIS.map(function(e){ var sel = p.emoji === e ? ' selected':''; return '<span class="emoji-opt'+sel+'" data-emoji="'+e+'" onclick="selecionarEmojiTab(this)">'+e+'</span>'; }).join('');
  _corSelecionada = p.color;
  _emojiSelecionado = p.emoji;

  var btnSalvarTab = document.getElementById('btnSalvarPerfilTab');
  if (btnSalvarTab) {
    btnSalvarTab.onclick = async function() {
      if (!p || !p.id) return;
      var updates = {};
      if (_corSelecionada) updates.color = _corSelecionada;
      if (_emojiSelecionado) updates.emoji = _emojiSelecionado;
      if (!Object.keys(updates).length) return;
      try {
        btnSalvarTab.textContent = 'SALVANDO...';
        await updateDoc(doc(db, 'players', p.id), updates);
        btnSalvarTab.textContent = '‚úÖ SALVO!';
        setTimeout(function(){ btnSalvarTab.textContent = 'üíæ SALVAR'; }, 2000);
      } catch(e){ btnSalvarTab.textContent = '‚ùå ERRO'; setTimeout(function(){ btnSalvarTab.textContent = 'üíæ SALVAR'; }, 2000); }
    };
  }
}

window.fecharPerfilTab = function() {
  // Volta para a aba cidade
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  document.getElementById('tab-cidade').classList.add('active');
  document.getElementById('cityBar').style.display = 'flex';
  var tabCidadeBtn = document.querySelector('.tab-btn:first-child');
  if (tabCidadeBtn) tabCidadeBtn.classList.add('active');
};

window.toggleEditPerfilTab = function() {
  var ed = document.getElementById('perfilEditorTab');
  if (ed) ed.style.display = ed.style.display === 'none' ? 'block' : 'none';
};
window.selecionarCorTab = function(el) {
  document.querySelectorAll('#colorPickerTab .color-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected'); _corSelecionada = el.dataset.color;
};
window.selecionarEmojiTab = function(el) {
  document.querySelectorAll('#emojiPickerTab .emoji-opt').forEach(function(e){ e.classList.remove('selected'); });
  el.classList.add('selected'); _emojiSelecionado = el.dataset.emoji;
};

async function abrirModal(p, pos) {
  // Preenche dados b√°sicos
  var avatarEl = document.getElementById('modalAvatar');
  if (p.iconId) {
    var fbEmoji = p.emoji || 'üéÆ';
    avatarEl.innerHTML = '<img src="https://cdn.brawlify.com/profile-icons/regular/' + p.iconId + '.png" style="width:48px;height:48px;border-radius:50%;object-fit:cover;" data-fb="' + fbEmoji + '" onerror="this.parentNode.textContent=this.dataset.fb">';
  } else {
    avatarEl.textContent = p.emoji || 'üéÆ';
  }
  document.getElementById('modalNome').textContent = p.name;
  document.getElementById('modalTag').textContent = p.tag;
  document.getElementById('modalCidade').textContent = 'üìç ' + p.city;
  document.getElementById('modalTrofeus').textContent = p.trophies.toLocaleString('pt-BR');
  document.getElementById('modalHoras').textContent = (p.horas || '?') + 'h';
  document.getElementById('modalPosicao').textContent = '#' + pos;
  document.getElementById('modalBrawlify').href = 'https://brawlify.com/stats/profile/' + p.tag.replace('#','');
  document.getElementById('modalPerfil').classList.add('open');
  document.getElementById('perfilEditor').style.display = 'none';
  _playerEditando = p;
  // Inicializa IA com dados do jogador
  iaIniciar(p);
  // Mostra sugest√µes novamente ao abrir novo perfil
  var sugs = document.getElementById('iaSuggestions');
  if (sugs) sugs.style.display = 'flex';
  _corSelecionada = p.color;
  _emojiSelecionado = p.emoji;

  // Bot√£o salvar perfil
  var btnSalvar = document.getElementById('btnSalvarPerfil');
  if (btnSalvar) {
    btnSalvar.onclick = async function() {
      if (!_playerEditando || !_playerEditando.id) return;
      var updates = {};
      if (_corSelecionada) updates.color = _corSelecionada;
      if (_emojiSelecionado) updates.emoji = _emojiSelecionado;
      if (Object.keys(updates).length === 0) return;
      try {
        btnSalvar.textContent = 'SALVANDO...';
        await updateDoc(doc(db, 'players', _playerEditando.id), updates);
        btnSalvar.textContent = '‚úÖ SALVO!';
        document.getElementById('modalAvatar').textContent = _emojiSelecionado || _playerEditando.emoji;
        setTimeout(function(){ btnSalvar.textContent = 'üíæ SALVAR'; }, 2000);
      } catch(e) {
        btnSalvar.textContent = '‚ùå ERRO';
        setTimeout(function(){ btnSalvar.textContent = 'üíæ SALVAR'; }, 2000);
      }
    };
  }

  // Busca hist√≥rico de trof√©us do Firebase
  var chartArea = document.getElementById('chartArea');
  chartArea.innerHTML = '<div class="chart-empty">Carregando hist√≥rico...</div>';

  try {
    var { collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js');
    var hRef = collection(db, 'players', p.id, 'history');
    var hQuery = query(hRef, orderBy('timestamp', 'desc'), limit(14));
    var snap = await getDocs(hQuery);
    var pontos = [];
    snap.forEach(function(d) { pontos.push(d.data()); });
    pontos.reverse();

    if (pontos.length < 2) {
      chartArea.innerHTML = '<div class="chart-empty">Coletando dados...<br>Volte amanh√£ para ver o gr√°fico!</div>';
      document.getElementById('modalVariacao').textContent = '-';
      return;
    }

    // Varia√ß√£o 24h
    var ultimo = pontos[pontos.length-1].trophies;
    var penultimo = pontos[pontos.length-2].trophies;
    var variacao = ultimo - penultimo;
    var varEl = document.getElementById('modalVariacao');
    varEl.textContent = (variacao >= 0 ? '+' : '') + variacao.toLocaleString('pt-BR');
    varEl.style.color = variacao >= 0 ? '#2ecc71' : '#e74c3c';

    // Desenha gr√°fico SVG
    var min = Math.min.apply(null, pontos.map(function(p){return p.trophies;}));
    var max = Math.max.apply(null, pontos.map(function(p){return p.trophies;}));
    var range = max - min || 1;
    var w = 100, h = 100;
    var pts = pontos.map(function(p, i) {
      var x = (i / (pontos.length-1)) * w;
      var y = h - ((p.trophies - min) / range) * (h * 0.8) - h*0.1;
      return x + ',' + y;
    });
    var polyline = pts.join(' ');
    var lastPt = pts[pts.length-1].split(',');

    chartArea.innerHTML = '<svg viewBox="0 0 100 100" style="width:100%;height:150px;" preserveAspectRatio="none">' +
      '<defs><linearGradient id="g1" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#00c8ff" stop-opacity="0.3"/><stop offset="100%" stop-color="#00c8ff" stop-opacity="0"/></linearGradient></defs>' +
      '<polygon points="0,100 ' + polyline + ' 100,100" fill="url(#g1)"/>' +
      '<polyline points="' + polyline + '" fill="none" stroke="#00c8ff" stroke-width="2"/>' +
      '<circle cx="' + lastPt[0] + '" cy="' + lastPt[1] + '" r="3" fill="#00c8ff"/>' +
      '</svg>' +
      '<div style="display:flex;justify-content:space-between;font-family:JetBrains Mono,monospace;font-size:0.6rem;color:var(--text-dim);margin-top:4px;">' +
      '<span>' + pontos[0].trophies.toLocaleString('pt-BR') + '</span>' +
      '<span style="color:#00c8ff">' + pontos[pontos.length-1].trophies.toLocaleString('pt-BR') + '</span>' +
      '</div>';

  } catch(e) {
    chartArea.innerHTML = '<div class="chart-empty">Erro ao carregar hist√≥rico</div>';
  }
}
</script>


<script>

window.togglePlayerRadio = function() {
  var modal = document.getElementById('radioModal');
  var frame = document.getElementById('radioFrame');
  if (modal.style.display === 'none') {
    modal.style.display = 'block';
    // Radio Garden embed - esta√ß√£o de cl√°ssicos 80/90
    frame.src = 'https://radio.garden/embed/radio-classicos-rock/YpZUAKJP';
    document.getElementById('musicBtn').style.color = '#f5a623';
  } else {
    fecharRadio();
  }
};

window.fecharRadio = function() {
  var modal = document.getElementById('radioModal');
  var frame = document.getElementById('radioFrame');
  modal.style.display = 'none';
  frame.src = '';
  document.getElementById('musicBtn').style.color = '';
};

function toggleMusic() {
  var music = document.getElementById('bgMusic');
  var btn = document.getElementById('musicBtn');
  if (music.paused) { music.volume = 0.4; music.play(); btn.textContent = 'üîä M√öSICA'; }
  else { music.pause(); btn.textContent = 'üîá M√öSICA'; }
}

// Toca automaticamente no primeiro toque/clique do usu√°rio
(function() {
  var played = false;
  function autoPlay() {
    if (played) return;
    played = true;
    var music = document.getElementById('bgMusic');
    var btn = document.getElementById('musicBtn');
    if (music && music.paused) {
      music.volume = 0.4;
      music.play().then(function() {
        if (btn) btn.textContent = 'üîä M√öSICA';
      }).catch(function() {});
    }
    document.removeEventListener('click', autoPlay);
    document.removeEventListener('touchstart', autoPlay);
  }
  document.addEventListener('click', autoPlay);
  document.addEventListener('touchstart', autoPlay);
})();
// ========== PREST√çGIOS ==========
var PRESTIGIO_TIERS = [
  { label:'Lenda',  classe:'lenda',  emoji:'üîÆ', minTrofeus:15000 },
  { label:'Ouro',   classe:'ouro',   emoji:'ü•á', minTrofeus:7000  },
  { label:'Prata',  classe:'prata',  emoji:'ü•à', minTrofeus:3000  },
  { label:'Bronze', classe:'bronze', emoji:'ü•â', minTrofeus:1000  },
];

// ========== PREST√çGIOS REAIS VIA API ==========
// Cores dos hex√°gonos por tier (igual ao jogo)
var HEX_TIERS = [
  { min: 75000, tier: 'Lenda M√°xima',  cor1: '#e040fb', cor2: '#7b1fa2', glow: 'rgba(224,64,251,0.6)' },
  { min: 50000, tier: 'Lenda III',     cor1: '#ce93d8', cor2: '#6a0dad', glow: 'rgba(155,89,182,0.5)' },
  { min: 35000, tier: 'Lenda II',      cor1: '#ba68c8', cor2: '#6a0dad', glow: 'rgba(155,89,182,0.5)' },
  { min: 20000, tier: 'Lenda I',       cor1: '#9c27b0', cor2: '#4a0080', glow: 'rgba(155,89,182,0.5)' },
  { min: 10000, tier: 'Ouro III',      cor1: '#ffe57f', cor2: '#f5a623', glow: 'rgba(245,166,35,0.5)' },
  { min:  7000, tier: 'Ouro II',       cor1: '#ffd740', cor2: '#c8960c', glow: 'rgba(245,166,35,0.4)' },
  { min:  5000, tier: 'Ouro I',        cor1: '#ffab00', cor2: '#b8860b', glow: 'rgba(245,166,35,0.4)' },
  { min:  3000, tier: 'Prata III',     cor1: '#cfd8dc', cor2: '#78909c', glow: 'rgba(168,184,200,0.4)' },
  { min:  2000, tier: 'Prata II',      cor1: '#b0bec5', cor2: '#546e7a', glow: 'rgba(168,184,200,0.3)' },
  { min:  1000, tier: 'Prata I',       cor1: '#90a4ae', cor2: '#455a64', glow: 'rgba(168,184,200,0.3)' },
  { min:   500, tier: 'Bronze III',    cor1: '#e0ac69', cor2: '#c87840', glow: 'rgba(200,120,64,0.3)' },
  { min:   200, tier: 'Bronze II',     cor1: '#cd7f32', cor2: '#7a4a28', glow: 'rgba(200,120,64,0.3)' },
  { min:     0, tier: 'Bronze I',      cor1: '#a0714f', cor2: '#5d3a1a', glow: 'rgba(160,100,60,0.2)' },
];

function getTier(trofeus) {
  for (var i = 0; i < HEX_TIERS.length; i++) {
    if (trofeus >= HEX_TIERS[i].min) return HEX_TIERS[i];
  }
  return HEX_TIERS[HEX_TIERS.length - 1];
}

function hexSVG(cor1, cor2, glow, uid) {
  // Hex√°gono estilo Brawl Stars com gradiente
  return '<svg viewBox="0 0 54 54" xmlns="http://www.w3.org/2000/svg" class="hex-bg">' +
    '<defs>' +
      '<linearGradient id="hg' + uid + '" x1="0" y1="0" x2="0" y2="1">' +
        '<stop offset="0%" stop-color="' + cor1 + '"/>' +
        '<stop offset="100%" stop-color="' + cor2 + '"/>' +
      '</linearGradient>' +
      '<filter id="glow' + uid + '">' +
        '<feGaussianBlur stdDeviation="2" result="blur"/>' +
        '<feComposite in="SourceGraphic" in2="blur" operator="over"/>' +
      '</filter>' +
    '</defs>' +
    '<polygon points="27,3 50,15 50,39 27,51 4,39 4,15" fill="url(#hg' + uid + ')" stroke="rgba(255,255,255,0.35)" stroke-width="1.5" filter="url(#glow' + uid + ')"/>' +
    '<polygon points="27,7 47,18 47,36 27,47 7,36 7,18" fill="rgba(255,255,255,0.07)"/>' +
  '</svg>';
}

async function renderPrestigios(p) {
  var grid = document.getElementById('prestigioGrid');
  var totalEl = document.getElementById('prestigioTotal');
  if (!grid) return;

  grid.innerHTML = '<div class="prestigio-loading">‚è≥ CARREGANDO BRAWLERS...</div>';
  totalEl.innerHTML = '';

  try {
    // Busca brawlers do jogador via Netlify function (que usa API oficial Brawl Stars)
    var cleanTag = (p.tag || '').replace('#', '');
    var res = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent('#' + cleanTag) + '&brawlers=1');
    var data = res.ok ? await res.json() : null;

    var brawlers = (data && data.brawlers) ? data.brawlers : null;

    // Se n√£o veio brawlers, tenta via Brawlify direto
    if (!brawlers) {
      var res2 = await fetch('https://api.brawlify.com/v1/players/' + encodeURIComponent('#' + cleanTag));
      if (res2.ok) {
        var d2 = await res2.json();
        brawlers = d2.brawlers || null;
      }
    }

    if (!brawlers || brawlers.length === 0) {
      grid.innerHTML = '<div class="prestigio-loading">Nenhum brawler encontrado</div>';
      return;
    }

    // Filtra brawlers com trof√©us >= 500 (que t√™m prest√≠gio) e ordena do maior pro menor
    var comPrestigio = brawlers
      .filter(function(b){ return (b.trophies || b.highestTrophies || 0) >= 500; })
      .sort(function(a,b){
        var ta = b.trophies || b.highestTrophies || 0;
        var tb = a.trophies || a.highestTrophies || 0;
        return ta - tb;
      });

    if (comPrestigio.length === 0) {
      grid.innerHTML = '<div class="prestigio-loading">Nenhum brawler com prest√≠gio ainda</div>';
      return;
    }

    var html = '';
    var totalPrestigio = 0;

    comPrestigio.forEach(function(b, idx) {
      var trofeus = b.trophies || b.highestTrophies || 0;
      var tier = getTier(trofeus);
      totalPrestigio++;

      // Suporte aos dois formatos: API oficial BS e Brawlify
      var brawlerId = b.id || (b.brawler && b.brawler.id) || '';
      var brawlerNome = b.name || (b.brawler && b.brawler.name) || 'Brawler';
      // Brawlify CDN: https://cdn.brawlify.com/brawlers/regular/{id}.png
      // API BS retorna id num√©rico, Brawlify tamb√©m usa id num√©rico
      var imgUrl = brawlerId ? 'https://cdn.brawlify.com/brawlers/regular/' + brawlerId + '.png' : '';

      var uid = 'b' + idx;

      html += '<div class="prestigio-badge" title="' + brawlerNome + ' ‚Äî ' + trofeus.toLocaleString('pt-BR') + ' trof√©us ‚Äî ' + tier.tier + '">' +
        '<div class="prestigio-hex-wrap">' +
          hexSVG(tier.cor1, tier.cor2, tier.glow, uid) +
          (imgUrl ? '<img src="' + imgUrl + '" alt="' + brawlerNome + '" onerror="this.style.display=\'none\'">' : '') +
          '<div class="prestigio-num-badge">' + trofeus.toLocaleString('pt-BR') + '</div>' +
        '</div>' +
        '<div class="prestigio-label">' + brawlerNome + '</div>' +
      '</div>';
    });

    grid.innerHTML = html;
    totalEl.innerHTML = 'Total Prest√≠gio: <span>' + totalPrestigio + '</span> brawlers com 500+ trof√©us';

  } catch(e) {
    grid.innerHTML = '<div class="prestigio-loading">Erro ao carregar prest√≠gios</div>';
    console.error('Prestige error:', e);
  }
}

// ========== IA ASSISTENTE BRAWL STARS ==========
window._iaJogador = null;
window._iaHistorico = []; // hist√≥rico da conversa

function iaIniciar(p) {
  window._iaJogador = p;
  window._iaHistorico = [];
  // Limpa e mostra mensagem inicial personalizada
  var msgs = document.getElementById('iaMessages');
  if (!msgs) return;
  msgs.innerHTML =
    '<div class="ia-msg ia-msg-bot">' +
      '<div class="ia-msg-avatar">ü§ñ</div>' +
      '<div class="ia-msg-bubble">Oi, <strong>' + (p.name || 'jogador') + '</strong>! Vi que voc√™ tem <strong>' + (p.trophies||0).toLocaleString('pt-BR') + ' trof√©us</strong> e ' + (p.horas||'?') + 'h de jogo. Me pergunte qualquer coisa sobre Brawl Stars ou sobre seu perfil! üéÆ</div>' +
    '</div>';
}

function iaAdicionarMsg(texto, tipo) {
  var msgs = document.getElementById('iaMessages');
  if (!msgs) return;
  var div = document.createElement('div');
  div.className = 'ia-msg ia-msg-' + tipo;
  div.innerHTML = tipo === 'bot'
    ? '<div class="ia-msg-avatar">ü§ñ</div><div class="ia-msg-bubble">' + texto + '</div>'
    : '<div class="ia-msg-avatar">üë§</div><div class="ia-msg-bubble">' + texto + '</div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

function iaShowTyping() {
  var msgs = document.getElementById('iaMessages');
  if (!msgs) return null;
  var div = document.createElement('div');
  div.className = 'ia-msg ia-msg-bot';
  div.id = 'iaTyping';
  div.innerHTML = '<div class="ia-msg-avatar">ü§ñ</div><div class="ia-msg-bubble"><div class="ia-typing"><div class="ia-typing-dot"></div><div class="ia-typing-dot"></div><div class="ia-typing-dot"></div></div></div>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

window.iaEnviarSugestao = function(btn) {
  var input = document.getElementById('iaInput');
  if (input) input.value = btn.textContent;
  // Esconde sugest√µes ap√≥s usar uma
  var sugs = document.getElementById('iaSuggestions');
  if (sugs) sugs.style.display = 'none';
  iaEnviar();
};

window.iaEnviar = async function() {
  var input = document.getElementById('iaInput');
  var sendBtn = document.getElementById('iaSendBtn');
  if (!input) return;
  var pergunta = input.value.trim();
  if (!pergunta) return;

  input.value = '';
  input.disabled = true;
  sendBtn.disabled = true;

  iaAdicionarMsg(pergunta, 'user');
  var typing = iaShowTyping();

  // Monta contexto do jogador
  var p = window._iaJogador || {};
  var contexto = 'Nome: ' + (p.name || 'Desconhecido') + ', ' +
    'TAG: ' + (p.tag || '?') + ', ' +
    'Trof√©us totais: ' + (p.trophies || 0).toLocaleString('pt-BR') + ', ' +
    'Horas jogadas: ' + (p.horas || '?') + 'h, ' +
    'Cidade: ' + (p.city || '?') + ', ' +
    'Brawlers desbloqueados: ' + (p.brawlerCount || '?');

  // Busca dados completos da API do Brawl Stars se tiver TAG
  if (p.tag) {
    try {
      var cleanTag = p.tag.startsWith('#') ? p.tag : '#' + p.tag;
      var apiRes = await fetch('/.netlify/functions/player?tag=' + encodeURIComponent(cleanTag));
      if (apiRes.ok) {
        var apiData = await apiRes.json();
        if (apiData.trophies) contexto += ', Trof√©us atuais: ' + apiData.trophies.toLocaleString('pt-BR');
        if (apiData.highestTrophies) contexto += ', M√°ximo hist√≥rico de trof√©us: ' + apiData.highestTrophies.toLocaleString('pt-BR');
        if (apiData.expLevel) contexto += ', N√≠vel de experi√™ncia: ' + apiData.expLevel;
        if (apiData.soloVictories) contexto += ', Vit√≥rias Solo Showdown: ' + apiData.soloVictories;
        if (apiData.duoVictories) contexto += ', Vit√≥rias Duo Showdown: ' + apiData.duoVictories;
        if (apiData['3vs3Victories']) contexto += ', Vit√≥rias 3v3: ' + apiData['3vs3Victories'];
        if (apiData.club && apiData.club.name) contexto += ', Clube: ' + apiData.club.name;
        if (apiData.brawlers && apiData.brawlers.length > 0) {
          var bsSorted = apiData.brawlers.slice().sort(function(a,b){ return (b.trophies||0)-(a.trophies||0); });
          var top10 = bsSorted.slice(0, 10);
          contexto += ', Top 10 brawlers: ' + top10.map(function(b){ return b.name + ' (' + (b.trophies||0) + ' trofeus, rank ' + (b.rank||'?') + ', power ' + (b.power||'?') + ')'; }).join(' | ');
          var pw11 = apiData.brawlers.filter(function(b){ return b.power >= 11; });
          if (pw11.length) contexto += ', Brawlers power 11: ' + pw11.map(function(b){ return b.name; }).join(', ');
          var mil = apiData.brawlers.filter(function(b){ return (b.trophies||0) >= 1000; });
          if (mil.length) contexto += ', Brawlers com 1000+ trofeus: ' + mil.map(function(b){ return b.name + '(' + b.trophies + ')'; }).join(', ');
        }
      }
    } catch(eApi) { /* usa dados basicos se API falhar */ }
  }

  // Adiciona historico ao messages
  window._iaHistorico.push({ role: 'user', content: pergunta });

  // Groq API (gratuita) - https://console.groq.com para pegar sua chave
  var GROQ_KEY = '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'; // Substitua pela sua chave do Groq
  var GROQ_URL = 'https://api.groq.com/openai/v1/chat/completions';

  var systemPrompt = 'Voc√™ √© BrawlBot, assistente especialista em Brawl Stars do site BrawlCity Rank de Pernambuco. ' +
    'Responda SEMPRE em portugu√™s do Brasil, de forma animada e com emojis. ' +
    'Seja conciso (m√°ximo 3 par√°grafos). N√£o use asteriscos, use texto limpo. ' +
    'Dados do jogador: ' + contexto + '.';

  // Monta hist√≥rico no formato OpenAI/Groq
  var groqMessages = [{ role: 'system', content: systemPrompt }];
  for (var hi = 0; hi < window._iaHistorico.length - 1; hi++) {
    var h = window._iaHistorico[hi];
    groqMessages.push({ role: h.role === 'assistant' ? 'assistant' : 'user', content: h.content });
  }
  groqMessages.push({ role: 'user', content: pergunta });

  try {
    var res = await fetch(GROQ_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + GROQ_KEY },
      body: JSON.stringify({
        model: 'llama-3.3-70b-versatile',
        messages: groqMessages,
        max_tokens: 600,
        temperature: 0.9
      })
    });

    var data = await res.json();
    console.log('Groq status:', res.status);
    console.log('Groq response:', JSON.stringify(data));

    // Pega o texto da resposta com fallback seguro
    var resposta = '';
    if (data.error) {
      resposta = '‚ùå Erro da API: ' + (data.error.message || JSON.stringify(data.error));
    } else if (data.choices && data.choices.length > 0) {
      resposta = data.choices[0].message && data.choices[0].message.content ? data.choices[0].message.content : '';
    }
    if (!resposta) {
      resposta = '‚ö†Ô∏è Retorno vazio. Debug: ' + JSON.stringify(data).slice(0, 200);
    }

    // Salva no hist√≥rico
    window._iaHistorico.push({ role: 'assistant', content: resposta });
    if (window._iaHistorico.length > 16) {
      window._iaHistorico = window._iaHistorico.slice(-16);
    }

    if (typing) typing.remove();
    var respostaHtml = resposta
      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
      .replace(/\*(.*?)\*/g, '$1')
      .replace(/\n/g, '<br>');
    iaAdicionarMsg(respostaHtml, 'bot');

  } catch(e) {
    if (typing) typing.remove();
    iaAdicionarMsg('‚ùå Erro de conex√£o. Verifique sua internet e tente novamente.', 'bot');
    console.error('Groq error:', e);
  }

  input.disabled = false;
  sendBtn.disabled = false;
  input.focus();
};

// === SKELETON LOADING ===
function renderSkeletons(containerId, count) {
  count = count || 7;
  var html = '';
  for (var i = 0; i < count; i++) {
    html += '<div class="skeleton-card" style="animation-delay:' + (i * 0.06) + 's">' +
      '<div class="skeleton skeleton-rank"></div>' +
      '<div class="skeleton skeleton-avatar"></div>' +
      '<div class="skeleton-info">' +
        '<div class="skeleton skeleton-name"></div>' +
        '<div class="skeleton skeleton-meta"></div>' +
      '</div>' +
      '<div class="skeleton-score">' +
        '<div class="skeleton skeleton-trofeus"></div>' +
        '<div class="skeleton skeleton-horas"></div>' +
      '</div>' +
    '</div>';
  }
  var el = document.getElementById(containerId);
  if (el) el.innerHTML = html;
}
renderSkeletons('rankingList', 7);
renderSkeletons('rankingListPE', 7);

function switchTab(tab, el) {
  document.querySelectorAll('.tab-content').forEach(function(t){ t.classList.remove('active'); });
  document.querySelectorAll('.tab-btn').forEach(function(b){ b.classList.remove('active'); });
  document.getElementById('tab-'+tab).classList.add('active');
  el.classList.add('active');
  document.getElementById('cityBar').style.display = tab==='cidade' ? 'flex' : 'none';
  if (tab === 'mapas' && !window._mapaCarregado) {
    window._mapaCarregado = true;
    setTimeout(function(){
      if (typeof window.carregarMapas === 'function') {
        window.carregarMapas();
        setInterval(window.carregarMapas, 5 * 60 * 1000);
      }
    }, 200);
  }
}
</script>
</body>
</html>
